{
  "version": 3,
  "sources": [
    "../../Users/sce/AppData/Roaming/npm/node_modules/ksana-cli/node_modules/browserify/node_modules/browser-pack/_prelude.js",
    "index.js",
    "src/main.jsx",
    "../node_modules/ksana-analyzer/configs.js",
    "../node_modules/ksana-analyzer/index.js",
    "../node_modules/ksana-analyzer/tokenizers.js",
    "../node_modules/ksana-database/bsearch.js",
    "../node_modules/ksana-database/index.js",
    "../node_modules/ksana-database/kde.js",
    "../node_modules/ksana-database/listkdb.js",
    "../node_modules/ksana-database/platform.js",
    "../node_modules/ksana-jsonrom/html5read.js",
    "../node_modules/ksana-jsonrom/index.js",
    "../node_modules/ksana-jsonrom/kdb.js",
    "../node_modules/ksana-jsonrom/kdbfs.js",
    "../node_modules/ksana-jsonrom/kdbfs_android.js",
    "../node_modules/ksana-jsonrom/kdbfs_ios.js",
    "../node_modules/ksana-search/boolsearch.js",
    "../node_modules/ksana-search/bsearch.js",
    "../node_modules/ksana-search/excerpt.js",
    "../node_modules/ksana-search/index.js",
    "../node_modules/ksana-search/plist.js",
    "../node_modules/ksana-search/search.js",
    "../node_modules/ksana2015-webruntime/checkbrowser.js",
    "../node_modules/ksana2015-webruntime/downloader.js",
    "../node_modules/ksana2015-webruntime/fileinstaller.js",
    "../node_modules/ksana2015-webruntime/html5fs.js",
    "../node_modules/ksana2015-webruntime/htmlfs.js",
    "../node_modules/ksana2015-webruntime/index.js",
    "../node_modules/ksana2015-webruntime/installkdb.js",
    "../node_modules/ksana2015-webruntime/kfs.js",
    "../node_modules/ksana2015-webruntime/kfs_html5.js",
    "../node_modules/ksana2015-webruntime/ksanagap.js",
    "../node_modules/ksana2015-webruntime/livereload.js",
    "../node_modules/ksana2015-webruntime/liveupdate.js",
    "../node_modules/ksana2015-webruntime/mkdirp.js"
  ],
  "names": [],
  "mappings": "AAAA;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;;ACNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACzBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACvDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AClCA;AACA;AACA;AACA;;ACHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3aA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC5DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC1FA;AACA;AACA;AACA;;ACHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3fA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3TA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC7FA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACjCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpcA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACrGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACxaA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACnkBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC7EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC3GA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC1SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACpNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AChHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AChEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACtCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACvDA;AACA;AACA;AACA;AACA;AACA;AACA;;ACNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC9EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;ACrBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AC5JA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA",
  "file": "generated.js",
  "sourceRoot": "",
  "sourcesContent": [
    "(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})",
    "var React=require(\"react\");\r\nvar runtime=require(\"ksana2015-webruntime\");\r\nruntime.boot(\"myapp\",function(){\r\n\tksana.runtime=runtime;\r\n\tvar Main=React.createElement(require(\"./src/main.jsx\"));\r\n\tksana.mainComponent=React.render(Main,document.getElementById(\"main\"));\r\n});",
    "var React=require(\"react\");\r\nvar kse=require(\"ksana-search\");\r\nvar maincomponent = React.createClass({displayName: \"maincomponent\",\r\n  getInitialState:function() {\r\n    return {result:[],tofind:\"君子\"};\r\n  },\r\n  search:function() {\r\n    kse.search(\"sample\",this.state.tofind,{range:{start:0}},function(err,data){\r\n      this.setState({result:data.excerpt});\r\n    },this);\r\n  },\r\n  renderItem:function(item) {\r\n    return React.createElement(\"div\", {dangerouslySetInnerHTML: {__html:item.text}})\r\n  },\r\n  setTofind:function(e) {\r\n    this.setState({tofind:e.target.value})\r\n  },\r\n  render: function() {\r\n    return React.createElement(\"div\", null, React.createElement(\"input\", {ref: \"tofind\", value: this.state.tofind, onChange: this.setTofind}), \r\n    React.createElement(\"button\", {onClick: this.search}, \"Search\"), \r\n      this.state.result.map(this.renderItem)\r\n\r\n    );\r\n  }\r\n});\r\nmodule.exports=maincomponent;",
    "var tokenizers=require('./tokenizers');\r\nvar normalizeTbl=null;\r\nvar setNormalizeTable=function(tbl,obj) {\r\n\tif (!obj) {\r\n\t\tobj={};\r\n\t\tfor (var i=0;i<tbl.length;i++) {\r\n\t\t\tvar arr=tbl[i].split(\"=\");\r\n\t\t\tobj[arr[0]]=arr[1];\r\n\t\t}\r\n\t}\r\n\tnormalizeTbl=obj;\r\n\treturn obj;\r\n}\r\nvar normalize1=function(token) {\r\n\tif (!token) return \"\";\r\n\ttoken=token.replace(/[ \\n\\.,，。！．「」：；、]/g,'').trim();\r\n\tif (!normalizeTbl) return token;\r\n\tif (token.length==1) {\r\n\t\treturn normalizeTbl[token] || token;\r\n\t} else {\r\n\t\tfor (var i=0;i<token.length;i++) {\r\n\t\t\ttoken[i]=normalizeTbl[token[i]] || token[i];\r\n\t\t}\r\n\t\treturn token;\r\n\t}\r\n}\r\nvar isSkip1=function(token) {\r\n\tvar t=token.trim();\r\n\treturn (t==\"\" || t==\"　\" || t==\"※\" || t==\"\\n\");\r\n}\r\nvar normalize_tibetan=function(token) {\r\n\treturn token.replace(/[།་ ]/g,'').trim();\r\n}\r\n\r\nvar isSkip_tibetan=function(token) {\r\n\tvar t=token.trim();\r\n\treturn (t==\"\" || t==\"　\" ||  t==\"\\n\");\t\r\n}\r\nvar simple1={\r\n\tfunc:{\r\n\t\ttokenize:tokenizers.simple\r\n\t\t,setNormalizeTable:setNormalizeTable\r\n\t\t,normalize: normalize1\r\n\t\t,isSkip:\tisSkip1\r\n\t}\r\n\t\r\n}\r\nvar tibetan1={\r\n\tfunc:{\r\n\t\ttokenize:tokenizers.tibetan\r\n\t\t,setNormalizeTable:setNormalizeTable\r\n\t\t,normalize:normalize_tibetan\r\n\t\t,isSkip:isSkip_tibetan\r\n\t}\r\n}\r\nmodule.exports={\"simple1\":simple1,\"tibetan1\":tibetan1}",
    "/* \r\n  custom func for building and searching ydb\r\n\r\n  keep all version\r\n  \r\n  getAPI(version); //return hash of functions , if ver is omit , return lastest\r\n\t\r\n  postings2Tree      // if version is not supply, get lastest\r\n  tokenize(text,api) // convert a string into tokens(depends on other api)\r\n  normalizeToken     // stemming and etc\r\n  isSpaceChar        // not a searchable token\r\n  isSkipChar         // 0 vpos\r\n\r\n  for client and server side\r\n  \r\n*/\r\nvar configs=require(\"./configs\");\r\nvar config_simple=\"simple1\";\r\nvar optimize=function(json,config) {\r\n\tconfig=config||config_simple;\r\n\treturn json;\r\n}\r\n\r\nvar getAPI=function(config) {\r\n\tconfig=config||config_simple;\r\n\tvar func=configs[config].func;\r\n\tfunc.optimize=optimize;\r\n\tif (config==\"simple1\") {\r\n\t\t//add common custom function here\r\n\t} else if (config==\"tibetan1\") {\r\n\r\n\t} else throw \"config \"+config +\"not supported\";\r\n\r\n\treturn func;\r\n}\r\n\r\nmodule.exports={getAPI:getAPI};",
    "var tibetan =function(s) {\r\n\t//continuous tsheg grouped into same token\r\n\t//shad and space grouped into same token\r\n\tvar offset=0;\r\n\tvar tokens=[],offsets=[];\r\n\ts=s.replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n');\r\n\tvar arr=s.split('\\n');\r\n\r\n\tfor (var i=0;i<arr.length;i++) {\r\n\t\tvar last=0;\r\n\t\tvar str=arr[i];\r\n\t\tstr.replace(/[།་ ]+/g,function(m,m1){\r\n\t\t\ttokens.push(str.substring(last,m1)+m);\r\n\t\t\toffsets.push(offset+last);\r\n\t\t\tlast=m1+m.length;\r\n\t\t});\r\n\t\tif (last<str.length) {\r\n\t\t\ttokens.push(str.substring(last));\r\n\t\t\toffsets.push(offset+last);\r\n\t\t}\r\n\t\tif (i===arr.length-1) break;\r\n\t\ttokens.push('\\n');\r\n\t\toffsets.push(offset+last);\r\n\t\toffset+=str.length+1;\r\n\t}\r\n\r\n\treturn {tokens:tokens,offsets:offsets};\r\n};\r\nvar isSpace=function(c) {\r\n\treturn (c==\" \") ;//|| (c==\",\") || (c==\".\");\r\n}\r\nvar isCJK =function(c) {return ((c>=0x3000 && c<=0x9FFF) \r\n|| (c>=0xD800 && c<0xDC00) || (c>=0xFF00) ) ;}\r\nvar simple1=function(s) {\r\n\tvar offset=0;\r\n\tvar tokens=[],offsets=[];\r\n\ts=s.replace(/\\r\\n/g,'\\n').replace(/\\r/g,'\\n');\r\n\tarr=s.split('\\n');\r\n\r\n\tvar pushtoken=function(t,off) {\r\n\t\tvar i=0;\r\n\t\tif (t.charCodeAt(0)>255) {\r\n\t\t\twhile (i<t.length) {\r\n\t\t\t\tvar c=t.charCodeAt(i);\r\n\t\t\t\toffsets.push(off+i);\r\n\t\t\t\ttokens.push(t[i]);\r\n\t\t\t\tif (c>=0xD800 && c<=0xDFFF) {\r\n\t\t\t\t\ttokens[tokens.length-1]+=t[i]; //extension B,C,D\r\n\t\t\t\t}\r\n\t\t\t\ti++;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\ttokens.push(t);\r\n\t\t\toffsets.push(off);\t\r\n\t\t}\r\n\t}\r\n\tfor (var i=0;i<arr.length;i++) {\r\n\t\tvar last=0,sp=\"\";\r\n\t\tstr=arr[i];\r\n\t\tstr.replace(/[_0-9A-Za-z]+/g,function(m,m1){\r\n\t\t\twhile (isSpace(sp=str[last]) && last<str.length) {\r\n\t\t\t\ttokens[tokens.length-1]+=sp;\r\n\t\t\t\tlast++;\r\n\t\t\t}\r\n\t\t\tpushtoken(str.substring(last,m1)+m , offset+last);\r\n\t\t\toffsets.push(offset+last);\r\n\t\t\tlast=m1+m.length;\r\n\t\t});\r\n\r\n\t\tif (last<str.length) {\r\n\t\t\twhile (isSpace(sp=str[last]) && last<str.length) {\r\n\t\t\t\ttokens[tokens.length-1]+=sp;\r\n\t\t\t\tlast++;\r\n\t\t\t}\r\n\t\t\tpushtoken(str.substring(last), offset+last);\r\n\t\t\t\r\n\t\t}\t\t\r\n\t\toffsets.push(offset+last);\r\n\t\toffset+=str.length+1;\r\n\t\tif (i===arr.length-1) break;\r\n\t\ttokens.push('\\n');\r\n\t}\r\n\r\n\treturn {tokens:tokens,offsets:offsets};\r\n\r\n};\r\n\r\nvar simple=function(s) {\r\n\tvar token='';\r\n\tvar tokens=[], offsets=[] ;\r\n\tvar i=0; \r\n\tvar lastspace=false;\r\n\tvar addtoken=function() {\r\n\t\tif (!token) return;\r\n\t\ttokens.push(token);\r\n\t\toffsets.push(i);\r\n\t\ttoken='';\r\n\t}\r\n\twhile (i<s.length) {\r\n\t\tvar c=s.charAt(i);\r\n\t\tvar code=s.charCodeAt(i);\r\n\t\tif (isCJK(code)) {\r\n\t\t\taddtoken();\r\n\t\t\ttoken=c;\r\n\t\t\tif (code>=0xD800 && code<0xDC00) { //high sorragate\r\n\t\t\t\ttoken+=s.charAt(i+1);i++;\r\n\t\t\t}\r\n\t\t\taddtoken();\r\n\t\t} else {\r\n\t\t\tif (c=='&' || c=='<' || c=='?' || c==\",\" || c==\".\"\r\n\t\t\t|| c=='|' || c=='~' || c=='`' || c==';' \r\n\t\t\t|| c=='>' || c==':' \r\n\t\t\t|| c=='=' || c=='@'  || c==\"-\" \r\n\t\t\t|| c==']' || c=='}'  || c==\")\" \r\n\t\t\t//|| c=='{' || c=='}'|| c=='[' || c==']' || c=='(' || c==')'\r\n\t\t\t|| code==0xf0b || code==0xf0d // tibetan space\r\n\t\t\t|| (code>=0x2000 && code<=0x206f)) {\r\n\t\t\t\taddtoken();\r\n\t\t\t\tif (c=='&' || c=='<'){ // || c=='{'|| c=='('|| c=='[') {\r\n\t\t\t\t\tvar endchar='>';\r\n\t\t\t\t\tif (c=='&') endchar=';'\r\n\t\t\t\t\t//else if (c=='{') endchar='}';\r\n\t\t\t\t\t//else if (c=='[') endchar=']';\r\n\t\t\t\t\t//else if (c=='(') endchar=')';\r\n\r\n\t\t\t\t\twhile (i<s.length && s.charAt(i)!=endchar) {\r\n\t\t\t\t\t\ttoken+=s.charAt(i);\r\n\t\t\t\t\t\ti++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttoken+=endchar;\r\n\t\t\t\t\taddtoken();\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttoken=c;\r\n\t\t\t\t\taddtoken();\r\n\t\t\t\t}\r\n\t\t\t\ttoken='';\r\n\t\t\t} else {\r\n\t\t\t\tif (c==\" \") {\r\n\t\t\t\t\ttoken+=c;\r\n\t\t\t\t\tlastspace=true;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (lastspace) addtoken();\r\n\t\t\t\t\tlastspace=false;\r\n\t\t\t\t\ttoken+=c;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\ti++;\r\n\t}\r\n\taddtoken();\r\n\treturn {tokens:tokens,offsets:offsets};\r\n}\r\nmodule.exports={simple:simple,tibetan:tibetan};",
    "var indexOfSorted = function (array, obj, near) { \r\n  var low = 0,\r\n  high = array.length;\r\n  while (low < high) {\r\n    var mid = (low + high) >> 1;\r\n    if (array[mid]==obj) return mid;\r\n    array[mid] < obj ? low = mid + 1 : high = mid;\r\n  }\r\n  if (near) return low;\r\n  else if (array[low]==obj) return low;else return -1;\r\n};\r\nvar indexOfSorted_str = function (array, obj, near) { \r\n  var low = 0,\r\n  high = array.length;\r\n  while (low < high) {\r\n    var mid = (low + high) >> 1;\r\n    if (array[mid]==obj) return mid;\r\n    //(array[mid].localeCompare(obj)<0) ? low = mid + 1 : high = mid;\r\n    array[mid]<obj ? low=mid+1 : high=mid;\r\n  }\r\n  if (near) return low;\r\n  else if (array[low]==obj) return low;else return -1;\r\n};\r\n\r\n\r\nvar bsearch=function(array,value,near) {\r\n\tvar func=indexOfSorted;\r\n\tif (typeof array[0]==\"string\") func=indexOfSorted_str;\r\n\treturn func(array,value,near);\r\n}\r\nvar bsearchNear=function(array,value) {\r\n\treturn bsearch(array,value,true);\r\n}\r\n\r\nmodule.exports=bsearch;//{bsearchNear:bsearchNear,bsearch:bsearch};",
    "var KDE=require(\"./kde\");\r\n//currently only support node.js fs, ksanagap native fs, html5 file system\r\n//use socket.io to read kdb from remote server in future\r\nmodule.exports=KDE;",
    "/* Ksana Database Engine\r\n\r\n   2015/1/2 , \r\n   move to ksana-database\r\n   simplified by removing document support and socket.io support\r\n\r\n\r\n*/\r\nvar pool={},localPool={};\r\nvar apppath=\"\";\r\nvar bsearch=require(\"./bsearch\");\r\nvar Kdb=require('ksana-jsonrom');\r\nvar kdbs=[]; //available kdb , id and absolute path\r\nvar strsep=\"\\uffff\";\r\nvar kdblisted=false;\r\n/*\r\nvar _getSync=function(paths,opts) {\r\n\tvar out=[];\r\n\tfor (var i in paths) {\r\n\t\tout.push(this.getSync(paths[i],opts));\t\r\n\t}\r\n\treturn out;\r\n}\r\n*/\r\nvar _gets=function(paths,opts,cb) { //get many data with one call\r\n\r\n\tif (!paths) return ;\r\n\tif (typeof paths=='string') {\r\n\t\tpaths=[paths];\r\n\t}\r\n\tvar engine=this, output=[];\r\n\r\n\tvar makecb=function(path){\r\n\t\treturn function(data){\r\n\t\t\t\tif (!(data && typeof data =='object' && data.__empty)) output.push(data);\r\n\t\t\t\tengine.get(path,opts,taskqueue.shift());\r\n\t\t};\r\n\t};\r\n\r\n\tvar taskqueue=[];\r\n\tfor (var i=0;i<paths.length;i++) {\r\n\t\tif (typeof paths[i]==\"null\") { //this is only a place holder for key data already in client cache\r\n\t\t\toutput.push(null);\r\n\t\t} else {\r\n\t\t\ttaskqueue.push(makecb(paths[i]));\r\n\t\t}\r\n\t};\r\n\r\n\ttaskqueue.push(function(data){\r\n\t\toutput.push(data);\r\n\t\tcb.apply(engine.context||engine,[output,paths]); //return to caller\r\n\t});\r\n\r\n\ttaskqueue.shift()({__empty:true}); //run the task\r\n}\r\n\r\nvar getFileRange=function(i) {\r\n\tvar engine=this;\r\n\r\n\tvar filesegcount=engine.get([\"filesegcount\"]);\r\n\tif (filesegcount) {\r\n\t\tif (i==0) {\r\n\t\t\treturn {start:0,end:filesegcount[0]-1};\r\n\t\t} else {\r\n\t\t\treturn {start:filesegcount[i-1],end:filesegcount[i]-1};\r\n\t\t}\r\n\t}\r\n\t//old buggy code\r\n\tvar filenames=engine.get([\"filenames\"]);\r\n\tvar fileoffsets=engine.get([\"fileoffsets\"]);\r\n\tvar segoffsets=engine.get([\"segoffsets\"]);\r\n\tvar segnames=engine.get([\"segnames\"]);\r\n\tvar filestart=fileoffsets[i], fileend=fileoffsets[i+1]-1;\r\n\r\n\tvar start=bsearch(segoffsets,filestart,true);\r\n\t//if (segOffsets[start]==fileStart) start--;\r\n\t\r\n\t//work around for jiangkangyur\r\n\twhile (segNames[start+1]==\"_\") start++;\r\n\r\n  //if (i==0) start=0; //work around for first file\r\n\tvar end=bsearch(segoffsets,fileend,true);\r\n\treturn {start:start,end:end};\r\n}\r\n\r\nvar absSegToFileSeg=function(absoluteseg) {\r\n\tvar filesegcount=this.get(\"filesegcount\");\r\n\tvar s=absoluteseg;\r\n\tvar file=0;\r\n\twhile (s>filesegcount[file]) {\r\n\t\ts-=filesegcount[file];\r\n\t\tfile++;\r\n\t}\r\n\treturn {file:file,seg:s};\r\n}\r\n\r\nvar fileSegToAbsSeg=function(file,seg) {\r\n\tif (file==0)return seg;\r\n\treturn this.get(\"filesegcount\")[file]+(seg);\r\n}\r\n/*\r\nvar vposToFileSeg=function(engine,vpos) {\r\n    var segoffsets=engine.get(\"segoffsets\");\r\n    var fileoffsets=engine.get([\"fileoffsets\"]);\r\n    var segnames=engine.get(\"segnames\");\r\n    var fileid=bsearch(fileoffsets,vpos+1,true);\r\n    fileid--;\r\n    var segid=bsearch(segoffsets,vpos+1,true);\r\n\tvar range=engine.getFileRange(fileid);\r\n\tsegid-=range.start;\r\n    return {file:fileid,seg:segid};\r\n}\r\n*/\r\n//return array of object of nfile nseg given segname\r\nvar findSeg=function(segname) {\r\n\tvar segnames=this.get(\"segnames\");\r\n\tvar out=[];\r\n\tfor (var i=0;i<segnames.length;i++) {\r\n\t\tif (segnames[i]==segname) {\r\n\t\t\tvar fileseg=absSegToFileSeg.apply(this,[i]);\r\n\t\t\tout.push({file:fileseg.file,seg:fileseg.seg,absseg:i});\r\n\t\t}\r\n\t}\r\n\treturn out;\r\n}\r\nvar findFile=function(filename) {\r\n\tvar filenames=this.get(\"filenames\");\r\n\tfor (var i=0;i<filenames.length;i++) {\r\n\t\tif (filenames[i]===filename) return i;\r\n\t}\r\n\treturn -1;\r\n}\r\n\r\nvar getFileSegOffsets=function(i) {\r\n\tvar segoffsets=this.get(\"segoffsets\");\r\n\tvar range=getFileRange.apply(this,[i]);\r\n\tif (segoffsets.subarray) {\r\n\t\treturn segoffsets.subarray(range.start,range.end+1);\r\n\t} else {\r\n\t\treturn segoffsets.slice(range.start,range.end+1);\t\r\n\t}\r\n\t\r\n\r\n}\r\nvar absSegFromVpos=function(vpos) { \r\n\tvar segoffsets=this.get([\"segoffsets\"]);\r\n\tvar i=bsearch(segoffsets,vpos,true);\r\n\twhile (segoffsets[i]==vpos) i++;\r\n\treturn i;\r\n}\r\n\r\nvar fileSegFromVpos=function(vpos) { \r\n\tvar seg=absSegFromVpos.call(this,vpos);\r\n\treturn absSegToFileSeg.call(this,seg);\r\n}\r\nvar fileSegToVpos=function(f,s) {\r\n\tvar segoffsets=this.get([\"segoffsets\"]);\r\n\tvar seg=fileSegToAbsSeg(f,s);\r\n\treturn segoffsets[seg-1];\r\n}\r\n\r\nvar getFileSegNames=function(i) {\r\n\tvar range=getFileRange.apply(this,[i]);\r\n\tvar segnames=this.get(\"segnames\");\r\n\treturn segnames.slice(range.start,range.end+1);\r\n}\r\nvar localengine_get=function(path,opts,cb,context) {\r\n\tvar engine=this;\r\n\tif (typeof opts==\"function\") {\r\n\t\tcontext=cb;\r\n\t\tcb=opts;\r\n\t\topts={recursive:false};\r\n\t}\r\n\tif (!path) {\r\n\t\tif (cb) cb.apply(context,[null]);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tif (typeof cb!=\"function\") {\r\n\t\treturn engine.kdb.get(path,opts);\r\n\t}\r\n\r\n\tif (typeof path==\"string\") {\r\n\t\treturn engine.kdb.get([path],opts,cb,context);\r\n\t} else if (typeof path[0] ==\"string\") {\r\n\t\treturn engine.kdb.get(path,opts,cb,context);\r\n\t} else if (typeof path[0] ==\"object\") {\r\n\t\treturn _gets.apply(engine,[path,opts,cb,context]);\r\n\t} else {\r\n\t\tengine.kdb.get([],opts,function(data){\r\n\t\t\tcb.apply(context,[data]);//return top level keys\r\n\t\t},context);\r\n\t}\r\n};\t\r\n\r\nvar getPreloadField=function(user) {\r\n\tvar preload=[[\"meta\"],[\"filenames\"],[\"fileoffsets\"],[\"segnames\"],[\"segoffsets\"],[\"filesegcount\"]];\r\n\t//[\"tokens\"],[\"postingslen\"] kse will load it\r\n\tif (user && user.length) { //user supply preload\r\n\t\tfor (var i=0;i<user.length;i++) {\r\n\t\t\tif (preload.indexOf(user[i])==-1) {\r\n\t\t\t\tpreload.push(user[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn preload;\r\n}\r\nvar createLocalEngine=function(kdb,opts,cb,context) {\r\n\tvar engine={kdb:kdb, queryCache:{}, postingCache:{}, cache:{}};\r\n\r\n\tif (typeof context==\"object\") engine.context=context;\r\n\tengine.get=localengine_get;\r\n\r\n\tengine.segOffset=segOffset;\r\n\tengine.fileOffset=fileOffset;\r\n\tengine.folderOffset=folderOffset;\r\n\tengine.getFileSegNames=getFileSegNames;\r\n\tengine.getFileSegOffsets=getFileSegOffsets;\r\n\tengine.getFileRange=getFileRange;\r\n\tengine.findSeg=findSeg;\r\n\tengine.findFile=findFile;\r\n\tengine.absSegToFileSeg=absSegToFileSeg;\r\n\tengine.fileSegToAbsSeg=fileSegToAbsSeg;\r\n\tengine.fileSegFromVpos=fileSegFromVpos;\r\n\tengine.absSegFromVpos=absSegFromVpos;\r\n\tengine.fileSegToVpos=fileSegToVpos;\r\n\t\r\n\t//engine.fileSegToVpos=fileSegToVpos;\r\n\t//engine.vposToFileSeg=vposToFileSeg;\r\n\t//only local engine allow getSync\r\n\t//if (kdb.fs.getSync) engine.getSync=engine.kdb.getSync;\r\n\t\r\n\t//speedy native functions\r\n\tif (kdb.fs.mergePostings) {\r\n\t\tengine.mergePostings=kdb.fs.mergePostings.bind(kdb.fs);\r\n\t}\r\n\t\r\n\tvar setPreload=function(res) {\r\n\t\tengine.dbname=res[0].name;\r\n\t\t//engine.customfunc=customfunc.getAPI(res[0].config);\r\n\t\tengine.ready=true;\r\n\t}\r\n\r\n\tvar preload=getPreloadField(opts.preload);\r\n\tvar opts={recursive:true};\r\n\t//if (typeof cb==\"function\") {\r\n\t\t_gets.apply(engine,[ preload, opts,function(res){\r\n\t\t\tsetPreload(res);\r\n\t\t\tcb.apply(engine.context,[engine]);\r\n\t\t}]);\r\n\t//} else {\r\n\t//\tsetPreload(_getSync.apply(engine,[preload,opts]));\r\n\t//}\r\n\treturn engine;\r\n}\r\n\r\nvar segOffset=function(segname) {\r\n\tvar engine=this;\r\n\tif (arguments.length>1) throw \"argument : segname \";\r\n\r\n\tvar segNames=engine.get(\"segnames\");\r\n\tvar segOffsets=engine.get(\"segoffsets\");\r\n\r\n\tvar i=segNames.indexOf(segname);\r\n\treturn (i>-1)?segOffsets[i]:0;\r\n}\r\nvar fileOffset=function(fn) {\r\n\tvar engine=this;\r\n\tvar filenames=engine.get(\"filenames\");\r\n\tvar offsets=engine.get(\"fileoffsets\");\r\n\tvar i=filenames.indexOf(fn);\r\n\tif (i==-1) return null;\r\n\treturn {start: offsets[i], end:offsets[i+1]};\r\n}\r\n\r\nvar folderOffset=function(folder) {\r\n\tvar engine=this;\r\n\tvar start=0,end=0;\r\n\tvar filenames=engine.get(\"filenames\");\r\n\tvar offsets=engine.get(\"fileoffsets\");\r\n\tfor (var i=0;i<filenames.length;i++) {\r\n\t\tif (filenames[i].substring(0,folder.length)==folder) {\r\n\t\t\tif (!start) start=offsets[i];\r\n\t\t\tend=offsets[i];\r\n\t\t} else if (start) break;\r\n\t}\r\n\treturn {start:start,end:end};\r\n}\r\n\r\n //TODO delete directly from kdb instance\r\n //kdb.free();\r\nvar closeLocal=function(kdbid) {\r\n\tvar engine=localPool[kdbid];\r\n\tif (engine) {\r\n\t\tengine.kdb.free();\r\n\t\tdelete localPool[kdbid];\r\n\t}\r\n}\r\nvar close=function(kdbid) {\r\n\tvar engine=pool[kdbid];\r\n\tif (engine) {\r\n\t\tengine.kdb.free();\r\n\t\tdelete pool[kdbid];\r\n\t}\r\n}\r\n\r\nvar getLocalTries=function(kdbfn) {\r\n\tif (!kdblisted) {\r\n\t\tkdbs=require(\"./listkdb\")();\r\n\t\tkdblisted=true;\r\n\t}\r\n\r\n\tvar kdbid=kdbfn.replace('.kdb','');\r\n\tvar tries= [\"./\"+kdbid+\".kdb\"\r\n\t           ,\"../\"+kdbid+\".kdb\"\r\n\t];\r\n\r\n\tfor (var i=0;i<kdbs.length;i++) {\r\n\t\tif (kdbs[i][0]==kdbid) {\r\n\t\t\ttries.push(kdbs[i][1]);\r\n\t\t}\r\n\t}\r\n\treturn tries;\r\n}\r\nvar openLocalKsanagap=function(kdbid,opts,cb,context) {\r\n\tvar kdbfn=kdbid;\r\n\tvar tries=getLocalTries(kdbfn);\r\n\r\n\tfor (var i=0;i<tries.length;i++) {\r\n\t\tif (fs.existsSync(tries[i])) {\r\n\t\t\t//console.log(\"kdb path: \"+nodeRequire('path').resolve(tries[i]));\r\n\t\t\tvar kdb=new Kdb.open(tries[i],function(err,kdb){\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tcb.apply(context,[err]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcreateLocalEngine(kdb,opts,function(engine){\r\n\t\t\t\t\t\tlocalPool[kdbid]=engine;\r\n\t\t\t\t\t\tcb.apply(context||engine.context,[0,engine]);\r\n\t\t\t\t\t},context);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\tif (cb) cb.apply(context,[kdbid+\" not found\"]);\r\n\treturn null;\r\n\r\n}\r\nvar openLocalNode=function(kdbid,opts,cb,context) {\r\n\tvar fs=require('fs');\r\n\tvar tries=getLocalTries(kdbid);\r\n\r\n\tfor (var i=0;i<tries.length;i++) {\r\n\t\tif (fs.existsSync(tries[i])) {\r\n\r\n\t\t\tnew Kdb.open(tries[i],function(err,kdb){\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tcb.apply(context||engine.content,[err]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcreateLocalEngine(kdb,opts,function(engine){\r\n\t\t\t\t\t\t\tlocalPool[kdbid]=engine;\r\n\t\t\t\t\t\t\tcb.apply(context||engine.context,[0,engine]);\r\n\t\t\t\t\t},context);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\tif (cb) cb.apply(context,[kdbid+\" not found\"]);\r\n\treturn null;\r\n}\r\n\r\nvar openLocalHtml5=function(kdbid,opts,cb,context) {\t\r\n\tvar engine=localPool[kdbid];\r\n\tvar kdbfn=kdbid;\r\n\tif (kdbfn.indexOf(\".kdb\")==-1) kdbfn+=\".kdb\";\r\n\tnew Kdb.open(kdbfn,function(err,handle){\r\n\t\tif (err) {\r\n\t\t\tcb.apply(context,[err]);\r\n\t\t} else {\r\n\t\t\tcreateLocalEngine(handle,opts,function(engine){\r\n\t\t\t\tlocalPool[kdbid]=engine;\r\n\t\t\t\tcb.apply(context||engine.context,[0,engine]);\r\n\t\t\t},context);\r\n\t\t}\r\n\t});\r\n}\r\n//omit cb for syncronize open\r\nvar openLocal=function(kdbid,opts,cb,context)  {\r\n\tif (typeof opts==\"function\") { //no opts\r\n\t\tif (typeof cb==\"object\") context=cb;\r\n\t\tcb=opts;\r\n\t\topts={};\r\n\t}\r\n\r\n\tvar engine=localPool[kdbid];\r\n\tif (engine) {\r\n\t\tif (cb) cb.apply(context||engine.context,[0,engine]);\r\n\t\treturn engine;\r\n\t}\r\n\r\n\tvar platform=require(\"./platform\").getPlatform();\r\n\tif (platform==\"node-webkit\" || platform==\"node\") {\r\n\t\topenLocalNode(kdbid,opts,cb,context);\r\n\t} else if (platform==\"html5\" || platform==\"chrome\"){\r\n\t\topenLocalHtml5(kdbid,opts,cb,context);\t\t\r\n\t} else {\r\n\t\topenLocalKsanagap(kdbid,opts,cb,context);\t\r\n\t}\r\n}\r\nvar setPath=function(path) {\r\n\tapppath=path;\r\n\tconsole.log(\"set path\",path)\r\n}\r\n\r\nvar enumKdb=function(cb,context){\r\n\tif (kdbs.length) return kdbs.map(function(k){return k[0]});\r\n\r\n\tif (!kdblisted) {\r\n\t\trequire(\"./listkdb\")(function(files){\r\n\t\t\tkdbs=files;\r\n\t\t\tcb.call(context, kdbs.map(function(k){return k[0]}) );\r\n\t\t});\r\n\t\tkdblisted=true;\r\n\t}\r\n}\r\n\r\nmodule.exports={open:openLocal,setPath:setPath, close:closeLocal, enumKdb:enumKdb, bsearch:bsearch};",
    "/* return array of dbid and absolute path*/\r\nvar listkdb_html5=function(cb,context) {\r\n\tksana.runtime.html5fs.readdir(function(kdbs){\r\n\t\t\tcb.apply(this,[kdbs]);\r\n\t},context||this);\t\t\r\n}\r\n\r\nvar listkdb_node=function(){\r\n\tvar fs=require(\"fs\");\r\n\tvar path=require(\"path\")\r\n\tvar parent=path.resolve(process.cwd(),\"..\");\r\n\tvar files=fs.readdirSync(parent);\r\n\tvar output=[];\r\n\tfiles.map(function(f){\r\n\t\tvar subdir=parent+path.sep+f;\r\n\t\tvar stat=fs.statSync(subdir );\r\n\t\tif (stat.isDirectory()) {\r\n\t\t\tvar subfiles=fs.readdirSync(subdir);\r\n\t\t\tfor (var i=0;i<subfiles.length;i++) {\r\n\t\t\t\tvar file=subfiles[i];\r\n\t\t\t\tvar idx=file.indexOf(\".kdb\");\r\n\t\t\t\tif (idx>-1&&idx==file.length-4) {\r\n\t\t\t\t\toutput.push([ file.substr(0,file.length-4), subdir+path.sep+file]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t})\r\n\treturn output;\r\n}\r\nvar fileNameOnly=function(fn) {\r\n\tvar at=fn.lastIndexOf(\"/\");\r\n\tif (at>-1) return fn.substr(at+1);\r\n\treturn fn;\r\n}\r\nvar listkdb_ksanagap=function() {\r\n\tvar output=[];\r\n\tvar apps=JSON.parse(kfs.listApps());\r\n\tfor (var i=0;i<apps.length;i++) {\r\n\t\tvar app=apps[i];\r\n\t\tif (app.files) for (var j=0;j<app.files.length;j++) {\r\n\t\t\tvar file=app.files[j];\r\n\t\t\tif (file.substr(file.length-4)==\".kdb\") {\r\n\t\t\t\toutput.push([app.dbid,fileNameOnly(file)]);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\treturn output;\r\n}\r\nvar listkdb=function(cb,context) {\r\n\tvar platform=require(\"./platform\").getPlatform();\r\n\tvar files=[];\r\n\tif (platform==\"node\" || platform==\"node-webkit\") {\r\n\t\tfiles=listkdb_node();\r\n\t} else if (platform==\"chrome\") {\r\n\t\tfiles=listkdb_html5(cb,context);\r\n\t} else {\r\n\t\tfiles=listkdb_ksanagap();\r\n\t}\r\n\treturn files;\r\n}\r\nmodule.exports=listkdb;",
    "var getPlatform=function() {\r\n\tif (typeof ksanagap==\"undefined\") {\r\n\t\tplatform=\"node\";\r\n\t} else {\r\n\t\tplatform=ksanagap.platform;\r\n\t}\r\n\treturn platform;\r\n}\r\nmodule.exports={getPlatform:getPlatform};",
    "\r\n/* emulate filesystem on html5 browser */\r\n/* emulate filesystem on html5 browser */\r\nvar read=function(handle,buffer,offset,length,position,cb) {//buffer and offset is not used\r\n\tvar xhr = new XMLHttpRequest();\r\n\txhr.open('GET', handle.url , true);\r\n\tvar range=[position,length+position-1];\r\n\txhr.setRequestHeader('Range', 'bytes='+range[0]+'-'+range[1]);\r\n\txhr.responseType = 'arraybuffer';\r\n\txhr.send();\r\n\txhr.onload = function(e) {\r\n\t\tvar that=this;\r\n\t\tsetTimeout(function(){\r\n\t\t\tcb(0,that.response.byteLength,that.response);\r\n\t\t},0);\r\n\t}; \r\n}\r\nvar close=function(handle) {}\r\nvar fstatSync=function(handle) {\r\n\tthrow \"not implement yet\";\r\n}\r\nvar fstat=function(handle,cb) {\r\n\tthrow \"not implement yet\";\r\n}\r\nvar _open=function(fn_url,cb) {\r\n\t\tvar handle={};\r\n\t\tif (fn_url.indexOf(\"filesystem:\")==0){\r\n\t\t\thandle.url=fn_url;\r\n\t\t\thandle.fn=fn_url.substr( fn_url.lastIndexOf(\"/\")+1);\r\n\t\t} else {\r\n\t\t\thandle.fn=fn_url;\r\n\t\t\tvar url=API.files.filter(function(f){ return (f[0]==fn_url)});\r\n\t\t\tif (url.length) handle.url=url[0][1];\r\n\t\t\telse cb(null);\r\n\t\t}\r\n\t\tcb(handle);\r\n}\r\nvar open=function(fn_url,cb) {\r\n\t\tif (!API.initialized) {init(1024*1024,function(){\r\n\t\t\t_open.apply(this,[fn_url,cb]);\r\n\t\t},this)} else _open.apply(this,[fn_url,cb]);\r\n}\r\nvar load=function(filename,mode,cb) {\r\n\topen(filename,mode,cb,true);\r\n}\r\nfunction errorHandler(e) {\r\n\tconsole.error('Error: ' +e.name+ \" \"+e.message);\r\n}\r\nvar readdir=function(cb,context) {\r\n\t var dirReader = API.fs.root.createReader();\r\n\t var out=[],that=this;\r\n\t\tdirReader.readEntries(function(entries) {\r\n\t\t\tif (entries.length) {\r\n\t\t\t\tfor (var i = 0, entry; entry = entries[i]; ++i) {\r\n\t\t\t\t\tif (entry.isFile) {\r\n\t\t\t\t\t\tout.push([entry.name,entry.toURL ? entry.toURL() : entry.toURI()]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tAPI.files=out;\r\n\t\t\tif (cb) cb.apply(context,[out]);\r\n\t\t}, function(){\r\n\t\t\tif (cb) cb.apply(context,[null]);\r\n\t\t});\r\n}\r\nvar initfs=function(grantedBytes,cb,context) {\r\n\twebkitRequestFileSystem(PERSISTENT, grantedBytes,  function(fs) {\r\n\t\tAPI.fs=fs;\r\n\t\tAPI.quota=grantedBytes;\r\n\t\treaddir(function(){\r\n\t\t\tAPI.initialized=true;\r\n\t\t\tcb.apply(context,[grantedBytes,fs]);\r\n\t\t},context);\r\n\t}, errorHandler);\r\n}\r\nvar init=function(quota,cb,context) {\r\n\tnavigator.webkitPersistentStorage.requestQuota(quota, \r\n\t\t\tfunction(grantedBytes) {\r\n\t\t\t\tinitfs(grantedBytes,cb,context);\r\n\t\t}, errorHandler \r\n\t);\r\n}\r\nvar API={\r\n\tread:read\r\n\t,readdir:readdir\r\n\t,open:open\r\n\t,close:close\r\n\t,fstatSync:fstatSync\r\n\t,fstat:fstat\r\n}\r\nmodule.exports=API;",
    "module.exports={\r\n\topen:require(\"./kdb\")\r\n}\r\n",
    "/*\r\n\tKDB version 3.0 GPL\r\n\tyapcheahshen@gmail.com\r\n\t2013/12/28\r\n\tasyncronize version of yadb\r\n\r\n  remove dependency of Q, thanks to\r\n  http://stackoverflow.com/questions/4234619/how-to-avoid-long-nesting-of-asynchronous-functions-in-node-js\r\n\r\n  2015/1/2\r\n  moved to ksanaforge/ksana-jsonrom\r\n  add err in callback for node.js compliant\r\n*/\r\nvar Kfs=null;\r\n\r\nif (typeof ksanagap==\"undefined\") {\r\n\tKfs=require('./kdbfs');\t\t\t\r\n} else {\r\n\tif (ksanagap.platform==\"ios\") {\r\n\t\tKfs=require(\"./kdbfs_ios\");\r\n\t} else if (ksanagap.platform==\"node-webkit\") {\r\n\t\tKfs=require(\"./kdbfs\");\r\n\t} else if (ksanagap.platform==\"chrome\") {\r\n\t\tKfs=require(\"./kdbfs\");\r\n\t} else {\r\n\t\tKfs=require(\"./kdbfs_android\");\r\n\t}\r\n\t\t\r\n}\r\n\r\n\r\nvar DT={\r\n\tuint8:'1', //unsigned 1 byte integer\r\n\tint32:'4', // signed 4 bytes integer\r\n\tutf8:'8',  \r\n\tucs2:'2',\r\n\tbool:'^', \r\n\tblob:'&',\r\n\tutf8arr:'*', //shift of 8\r\n\tucs2arr:'@', //shift of 2\r\n\tuint8arr:'!', //shift of 1\r\n\tint32arr:'$', //shift of 4\r\n\tvint:'`',\r\n\tpint:'~',\t\r\n\r\n\tarray:'\\u001b',\r\n\tobject:'\\u001a' \r\n\t//ydb start with object signature,\r\n\t//type a ydb in command prompt shows nothing\r\n}\r\nvar verbose=0, readLog=function(){};\r\nvar _readLog=function(readtype,bytes) {\r\n\tconsole.log(readtype,bytes,\"bytes\");\r\n}\r\nif (verbose) readLog=_readLog;\r\nvar strsep=\"\\uffff\";\r\nvar Create=function(path,opts,cb) {\r\n\t/* loadxxx functions move file pointer */\r\n\t// load variable length int\r\n\tif (typeof opts==\"function\") {\r\n\t\tcb=opts;\r\n\t\topts={};\r\n\t}\r\n\r\n\t\r\n\tvar loadVInt =function(opts,blocksize,count,cb) {\r\n\t\t//if (count==0) return [];\r\n\t\tvar that=this;\r\n\r\n\t\tthis.fs.readBuf_packedint(opts.cur,blocksize,count,true,function(o){\r\n\t\t\t//console.log(\"vint\");\r\n\t\t\topts.cur+=o.adv;\r\n\t\t\tcb.apply(that,[o.data]);\r\n\t\t});\r\n\t}\r\n\tvar loadVInt1=function(opts,cb) {\r\n\t\tvar that=this;\r\n\t\tloadVInt.apply(this,[opts,6,1,function(data){\r\n\t\t\t//console.log(\"vint1\");\r\n\t\t\tcb.apply(that,[data[0]]);\r\n\t\t}])\r\n\t}\r\n\t//for postings\r\n\tvar loadPInt =function(opts,blocksize,count,cb) {\r\n\t\tvar that=this;\r\n\t\tthis.fs.readBuf_packedint(opts.cur,blocksize,count,false,function(o){\r\n\t\t\t//console.log(\"pint\");\r\n\t\t\topts.cur+=o.adv;\r\n\t\t\tcb.apply(that,[o.data]);\r\n\t\t});\r\n\t}\r\n\t// item can be any type (variable length)\r\n\t// maximum size of array is 1TB 2^40\r\n\t// structure:\r\n\t// signature,5 bytes offset, payload, itemlengths\r\n\tvar getArrayLength=function(opts,cb) {\r\n\t\tvar that=this;\r\n\t\tvar dataoffset=0;\r\n\r\n\t\tthis.fs.readUI8(opts.cur,function(len){\r\n\t\t\tvar lengthoffset=len*4294967296;\r\n\t\t\topts.cur++;\r\n\t\t\tthat.fs.readUI32(opts.cur,function(len){\r\n\t\t\t\topts.cur+=4;\r\n\t\t\t\tdataoffset=opts.cur; //keep this\r\n\t\t\t\tlengthoffset+=len;\r\n\t\t\t\topts.cur+=lengthoffset;\r\n\r\n\t\t\t\tloadVInt1.apply(that,[opts,function(count){\r\n\t\t\t\t\tloadVInt.apply(that,[opts,count*6,count,function(sz){\t\t\t\t\t\t\r\n\t\t\t\t\t\tcb({count:count,sz:sz,offset:dataoffset});\r\n\t\t\t\t\t}]);\r\n\t\t\t\t}]);\r\n\t\t\t\t\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tvar loadArray = function(opts,blocksize,cb) {\r\n\t\tvar that=this;\r\n\t\tgetArrayLength.apply(this,[opts,function(L){\r\n\t\t\t\tvar o=[];\r\n\t\t\t\tvar endcur=opts.cur;\r\n\t\t\t\topts.cur=L.offset;\r\n\r\n\t\t\t\tif (opts.lazy) { \r\n\t\t\t\t\t\tvar offset=L.offset;\r\n\t\t\t\t\t\tfor (var i=0;i<L.sz.length;i++) {\r\n\t\t\t\t\t\t\tvar sz=L.sz[i];\r\n\t\t\t\t\t\t\to[o.length]=strsep+offset.toString(16)\r\n\t\t\t\t\t\t\t\t   +strsep+sz.toString(16);\r\n\t\t\t\t\t\t\toffset+=sz;\r\n\t\t\t\t\t\t};\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvar taskqueue=[];\r\n\t\t\t\t\tfor (var i=0;i<L.count;i++) {\r\n\t\t\t\t\t\ttaskqueue.push(\r\n\t\t\t\t\t\t\t(function(sz){\r\n\t\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t\tfunction(data){\r\n\t\t\t\t\t\t\t\t\t\tif (typeof data=='object' && data.__empty) {\r\n\t\t\t\t\t\t\t\t\t\t\t //not pushing the first call\r\n\t\t\t\t\t\t\t\t\t\t}\telse o.push(data);\r\n\t\t\t\t\t\t\t\t\t\topts.blocksize=sz;\r\n\t\t\t\t\t\t\t\t\t\tload.apply(that,[opts, taskqueue.shift()]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t})(L.sz[i])\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//last call to child load\r\n\t\t\t\t\ttaskqueue.push(function(data){\r\n\t\t\t\t\t\to.push(data);\r\n\t\t\t\t\t\topts.cur=endcur;\r\n\t\t\t\t\t\tcb.apply(that,[o]);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (opts.lazy) cb.apply(that,[o]);\r\n\t\t\t\telse {\r\n\t\t\t\t\ttaskqueue.shift()({__empty:true});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t])\r\n\t}\t\t\r\n\t// item can be any type (variable length)\r\n\t// support lazy load\r\n\t// structure:\r\n\t// signature,5 bytes offset, payload, itemlengths, \r\n\t//                    stringarray_signature, keys\r\n\tvar loadObject = function(opts,blocksize,cb) {\r\n\t\tvar that=this;\r\n\t\tvar start=opts.cur;\r\n\t\tgetArrayLength.apply(this,[opts,function(L) {\r\n\t\t\topts.blocksize=blocksize-opts.cur+start;\r\n\t\t\tload.apply(that,[opts,function(keys){ //load the keys\r\n\t\t\t\tif (opts.keys) { //caller ask for keys\r\n\t\t\t\t\tkeys.map(function(k) { opts.keys.push(k)});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar o={};\r\n\t\t\t\tvar endcur=opts.cur;\r\n\t\t\t\topts.cur=L.offset;\r\n\t\t\t\tif (opts.lazy) { \r\n\t\t\t\t\tvar offset=L.offset;\r\n\t\t\t\t\tfor (var i=0;i<L.sz.length;i++) {\r\n\t\t\t\t\t\t//prefix with a \\0, impossible for normal string\r\n\t\t\t\t\t\to[keys[i]]=strsep+offset.toString(16)\r\n\t\t\t\t\t\t\t   +strsep+L.sz[i].toString(16);\r\n\t\t\t\t\t\toffset+=L.sz[i];\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tvar taskqueue=[];\r\n\t\t\t\t\tfor (var i=0;i<L.count;i++) {\r\n\t\t\t\t\t\ttaskqueue.push(\r\n\t\t\t\t\t\t\t(function(sz,key){\r\n\t\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t\tfunction(data){\r\n\t\t\t\t\t\t\t\t\t\tif (typeof data=='object' && data.__empty) {\r\n\t\t\t\t\t\t\t\t\t\t\t//not saving the first call;\r\n\t\t\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t\t\to[key]=data; \r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\topts.blocksize=sz;\r\n\t\t\t\t\t\t\t\t\t\tif (verbose) readLog(\"key\",key);\r\n\t\t\t\t\t\t\t\t\t\tload.apply(that,[opts, taskqueue.shift()]);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t\t})(L.sz[i],keys[i-1])\r\n\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//last call to child load\r\n\t\t\t\t\ttaskqueue.push(function(data){\r\n\t\t\t\t\t\to[keys[keys.length-1]]=data;\r\n\t\t\t\t\t\topts.cur=endcur;\r\n\t\t\t\t\t\tcb.apply(that,[o]);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\tif (opts.lazy) cb.apply(that,[o]);\r\n\t\t\t\telse {\r\n\t\t\t\t\ttaskqueue.shift()({__empty:true});\r\n\t\t\t\t}\r\n\t\t\t}]);\r\n\t\t}]);\r\n\t}\r\n\r\n\t//item is same known type\r\n\tvar loadStringArray=function(opts,blocksize,encoding,cb) {\r\n\t\tvar that=this;\r\n\t\tthis.fs.readStringArray(opts.cur,blocksize,encoding,function(o){\r\n\t\t\topts.cur+=blocksize;\r\n\t\t\tcb.apply(that,[o]);\r\n\t\t});\r\n\t}\r\n\tvar loadIntegerArray=function(opts,blocksize,unitsize,cb) {\r\n\t\tvar that=this;\r\n\t\tloadVInt1.apply(this,[opts,function(count){\r\n\t\t\tvar o=that.fs.readFixedArray(opts.cur,count,unitsize,function(o){\r\n\t\t\t\topts.cur+=count*unitsize;\r\n\t\t\t\tcb.apply(that,[o]);\r\n\t\t\t});\r\n\t\t}]);\r\n\t}\r\n\tvar loadBlob=function(blocksize,cb) {\r\n\t\tvar o=this.fs.readBuf(this.cur,blocksize);\r\n\t\tthis.cur+=blocksize;\r\n\t\treturn o;\r\n\t}\t\r\n\tvar loadbysignature=function(opts,signature,cb) {\r\n\t\t  var blocksize=opts.blocksize||this.fs.size; \r\n\t\t\topts.cur+=this.fs.signature_size;\r\n\t\t\tvar datasize=blocksize-this.fs.signature_size;\r\n\t\t\t//basic types\r\n\t\t\tif (signature===DT.int32) {\r\n\t\t\t\topts.cur+=4;\r\n\t\t\t\tthis.fs.readI32(opts.cur-4,cb);\r\n\t\t\t} else if (signature===DT.uint8) {\r\n\t\t\t\topts.cur++;\r\n\t\t\t\tthis.fs.readUI8(opts.cur-1,cb);\r\n\t\t\t} else if (signature===DT.utf8) {\r\n\t\t\t\tvar c=opts.cur;opts.cur+=datasize;\r\n\t\t\t\tthis.fs.readString(c,datasize,'utf8',cb);\r\n\t\t\t} else if (signature===DT.ucs2) {\r\n\t\t\t\tvar c=opts.cur;opts.cur+=datasize;\r\n\t\t\t\tthis.fs.readString(c,datasize,'ucs2',cb);\t\r\n\t\t\t} else if (signature===DT.bool) {\r\n\t\t\t\topts.cur++;\r\n\t\t\t\tthis.fs.readUI8(opts.cur-1,function(data){cb(!!data)});\r\n\t\t\t} else if (signature===DT.blob) {\r\n\t\t\t\tloadBlob(datasize,cb);\r\n\t\t\t}\r\n\t\t\t//variable length integers\r\n\t\t\telse if (signature===DT.vint) {\r\n\t\t\t\tloadVInt.apply(this,[opts,datasize,datasize,cb]);\r\n\t\t\t}\r\n\t\t\telse if (signature===DT.pint) {\r\n\t\t\t\tloadPInt.apply(this,[opts,datasize,datasize,cb]);\r\n\t\t\t}\r\n\t\t\t//simple array\r\n\t\t\telse if (signature===DT.utf8arr) {\r\n\t\t\t\tloadStringArray.apply(this,[opts,datasize,'utf8',cb]);\r\n\t\t\t}\r\n\t\t\telse if (signature===DT.ucs2arr) {\r\n\t\t\t\tloadStringArray.apply(this,[opts,datasize,'ucs2',cb]);\r\n\t\t\t}\r\n\t\t\telse if (signature===DT.uint8arr) {\r\n\t\t\t\tloadIntegerArray.apply(this,[opts,datasize,1,cb]);\r\n\t\t\t}\r\n\t\t\telse if (signature===DT.int32arr) {\r\n\t\t\t\tloadIntegerArray.apply(this,[opts,datasize,4,cb]);\r\n\t\t\t}\r\n\t\t\t//nested structure\r\n\t\t\telse if (signature===DT.array) {\r\n\t\t\t\tloadArray.apply(this,[opts,datasize,cb]);\r\n\t\t\t}\r\n\t\t\telse if (signature===DT.object) {\r\n\t\t\t\tloadObject.apply(this,[opts,datasize,cb]);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tconsole.error('unsupported type',signature,opts)\r\n\t\t\t\tcb.apply(this,[null]);//make sure it return\r\n\t\t\t\t//throw 'unsupported type '+signature;\r\n\t\t\t}\r\n\t}\r\n\r\n\tvar load=function(opts,cb) {\r\n\t\topts=opts||{}; // this will served as context for entire load procedure\r\n\t\topts.cur=opts.cur||0;\r\n\t\tvar that=this;\r\n\t\tthis.fs.readSignature(opts.cur, function(signature){\r\n\t\t\tloadbysignature.apply(that,[opts,signature,cb])\r\n\t\t});\r\n\t\treturn this;\r\n\t}\r\n\tvar CACHE=null;\r\n\tvar KEY={};\r\n\tvar ADDRESS={};\r\n\tvar reset=function(cb) {\r\n\t\tif (!CACHE) {\r\n\t\t\tload.apply(this,[{cur:0,lazy:true},function(data){\r\n\t\t\t\tCACHE=data;\r\n\t\t\t\tcb.call(this);\r\n\t\t\t}]);\t\r\n\t\t} else {\r\n\t\t\tcb.call(this);\r\n\t\t}\r\n\t}\r\n\r\n\tvar exists=function(path,cb) {\r\n\t\tif (path.length==0) return true;\r\n\t\tvar key=path.pop();\r\n\t\tvar that=this;\r\n\t\tget.apply(this,[path,false,function(data){\r\n\t\t\tif (!path.join(strsep)) return (!!KEY[key]);\r\n\t\t\tvar keys=KEY[path.join(strsep)];\r\n\t\t\tpath.push(key);//put it back\r\n\t\t\tif (keys) cb.apply(that,[keys.indexOf(key)>-1]);\r\n\t\t\telse cb.apply(that,[false]);\r\n\t\t}]);\r\n\t}\r\n\r\n\tvar getSync=function(path) {\r\n\t\tif (!CACHE) return undefined;\t\r\n\t\tvar o=CACHE;\r\n\t\tfor (var i=0;i<path.length;i++) {\r\n\t\t\tvar r=o[path[i]];\r\n\t\t\tif (typeof r==\"undefined\") return null;\r\n\t\t\to=r;\r\n\t\t}\r\n\t\treturn o;\r\n\t}\r\n\tvar get=function(path,opts,cb,context) {\r\n\t\tif (typeof path=='undefined') path=[];\r\n\t\tif (typeof path==\"string\") path=[path];\r\n\t\t//opts.recursive=!!opts.recursive;\r\n\t\tif (typeof opts==\"function\") {\r\n\t\t\tcontext=cb;\r\n\t\t\tcb=opts;\r\n\t\t\topts={};\r\n\t\t}\r\n\t\tvar context=context||this;\r\n\t\tvar that=this;\r\n\t\tif (typeof cb!='function') return getSync(path);\r\n\r\n\t\treset.apply(this,[function(){\r\n\t\t\tvar o=CACHE;\r\n\t\t\tif (path.length==0) {\r\n\t\t\t\tif (opts.address) {\r\n\t\t\t\t\tcb.apply(context,[[0,that.fs.size]]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcb.apply(context,[Object.keys(CACHE)]);\r\n\t\t\t\t}\r\n\t\t\t\treturn;\r\n\t\t\t} \r\n\t\t\t\r\n\t\t\tvar pathnow=\"\",taskqueue=[],newopts={},r=null;\r\n\t\t\tvar lastkey=\"\";\r\n\r\n\t\t\tfor (var i=0;i<path.length;i++) {\r\n\t\t\t\tvar task=(function(key,k){\r\n\r\n\t\t\t\t\treturn (function(data){\r\n\t\t\t\t\t\tif (!(typeof data=='object' && data.__empty)) {\r\n\t\t\t\t\t\t\tif (typeof o[lastkey]=='string' && o[lastkey][0]==strsep) o[lastkey]={};\r\n\t\t\t\t\t\t\to[lastkey]=data; \r\n\t\t\t\t\t\t\to=o[lastkey];\r\n\t\t\t\t\t\t\tr=data[key];\r\n\t\t\t\t\t\t\tKEY[pathnow]=opts.keys;\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tdata=o[key];\r\n\t\t\t\t\t\t\tr=data;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (typeof r===\"undefined\") {\r\n\t\t\t\t\t\t\ttaskqueue=null;\r\n\t\t\t\t\t\t\tcb.apply(context,[r]); //return empty value\r\n\t\t\t\t\t\t} else {\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif (parseInt(k)) pathnow+=strsep;\r\n\t\t\t\t\t\t\tpathnow+=key;\r\n\t\t\t\t\t\t\tif (typeof r=='string' && r[0]==strsep) { //offset of data to be loaded\r\n\t\t\t\t\t\t\t\tvar p=r.substring(1).split(strsep).map(function(item){return parseInt(item,16)});\r\n\t\t\t\t\t\t\t\tvar cur=p[0],sz=p[1];\r\n\t\t\t\t\t\t\t\tnewopts.lazy=!opts.recursive || (k<path.length-1) ;\r\n\t\t\t\t\t\t\t\tnewopts.blocksize=sz;newopts.cur=cur,newopts.keys=[];\r\n\t\t\t\t\t\t\t\tlastkey=key; //load is sync in android\r\n\t\t\t\t\t\t\t\tif (opts.address && taskqueue.length==1) {\r\n\t\t\t\t\t\t\t\t\tADDRESS[pathnow]=[cur,sz];\r\n\t\t\t\t\t\t\t\t\ttaskqueue.shift()(null,ADDRESS[pathnow]);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tload.apply(that,[newopts, taskqueue.shift()]);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tif (opts.address && taskqueue.length==1) {\r\n\t\t\t\t\t\t\t\t\ttaskqueue.shift()(null,ADDRESS[pathnow]);\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\ttaskqueue.shift().apply(that,[r]);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\t\t\t\t(path[i],i);\r\n\t\t\t\t\r\n\t\t\t\ttaskqueue.push(task);\r\n\t\t\t}\r\n\r\n\t\t\tif (taskqueue.length==0) {\r\n\t\t\t\tcb.apply(context,[o]);\r\n\t\t\t} else {\r\n\t\t\t\t//last call to child load\r\n\t\t\t\ttaskqueue.push(function(data,cursz){\r\n\t\t\t\t\tif (opts.address) {\r\n\t\t\t\t\t\tcb.apply(context,[cursz]);\r\n\t\t\t\t\t} else{\r\n\t\t\t\t\t\tvar key=path[path.length-1];\r\n\t\t\t\t\t\to[key]=data; KEY[pathnow]=opts.keys;\r\n\t\t\t\t\t\tcb.apply(context,[data]);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\ttaskqueue.shift()({__empty:true});\t\t\t\r\n\t\t\t}\r\n\r\n\t\t}]); //reset\r\n\t}\r\n\t// get all keys in given path\r\n\tvar getkeys=function(path,cb) {\r\n\t\tif (!path) path=[]\r\n\t\tvar that=this;\r\n\r\n\t\tget.apply(this,[path,false,function(){\r\n\t\t\tif (path && path.length) {\r\n\t\t\t\tcb.apply(that,[KEY[path.join(strsep)]]);\r\n\t\t\t} else {\r\n\t\t\t\tcb.apply(that,[Object.keys(CACHE)]); \r\n\t\t\t\t//top level, normally it is very small\r\n\t\t\t}\r\n\t\t}]);\r\n\t}\r\n\r\n\tvar setupapi=function() {\r\n\t\tthis.load=load;\r\n//\t\tthis.cur=0;\r\n\t\tthis.cache=function() {return CACHE};\r\n\t\tthis.key=function() {return KEY};\r\n\t\tthis.free=function() {\r\n\t\t\tCACHE=null;\r\n\t\t\tKEY=null;\r\n\t\t\tthis.fs.free();\r\n\t\t}\r\n\t\tthis.setCache=function(c) {CACHE=c};\r\n\t\tthis.keys=getkeys;\r\n\t\tthis.get=get;   // get a field, load if needed\r\n\t\tthis.exists=exists;\r\n\t\tthis.DT=DT;\r\n\t\t\r\n\t\t//install the sync version for node\r\n\t\t//if (typeof process!=\"undefined\") require(\"./kdb_sync\")(this);\r\n\t\t//if (cb) setTimeout(cb.bind(this),0);\r\n\t\tvar that=this;\r\n\t\tvar err=0;\r\n\t\tif (cb) {\r\n\t\t\tsetTimeout(function(){\r\n\t\t\t\tcb(err,that);\t\r\n\t\t\t},0);\r\n\t\t}\r\n\t}\r\n\tvar that=this;\r\n\tvar kfs=new Kfs(path,opts,function(err){\r\n\t\tif (err) {\r\n\t\t\tsetTimeout(function(){\r\n\t\t\t\tcb(err,0);\r\n\t\t\t},0);\r\n\t\t\treturn null;\r\n\t\t} else {\r\n\t\t\tthat.size=this.size;\r\n\t\t\tsetupapi.call(that);\t\t\t\r\n\t\t}\r\n\t});\r\n\tthis.fs=kfs;\r\n\treturn this;\r\n}\r\n\r\nCreate.datatypes=DT;\r\n\r\nif (module) module.exports=Create;\r\n//return Create;\r\n",
    "/* node.js and html5 file system abstraction layer*/\r\ntry {\r\n\tvar fs=require(\"fs\");\r\n\tvar Buffer=require(\"buffer\").Buffer;\r\n} catch (e) {\r\n\tvar fs=require('./html5read');\r\n\tvar Buffer=function(){ return \"\"};\r\n\tvar html5fs=true; \t\r\n}\r\nvar signature_size=1;\r\nvar verbose=0, readLog=function(){};\r\nvar _readLog=function(readtype,bytes) {\r\n\tconsole.log(readtype,bytes,\"bytes\");\r\n}\r\nif (verbose) readLog=_readLog;\r\n\r\nvar unpack_int = function (ar, count , reset) {\r\n   count=count||ar.length;\r\n  var r = []\r\n  //var r=new Uint32Array(count);\r\n  var i = 0, v = 0,n=0;\r\n  do {\r\n\tvar shift = 0;\r\n\tdo {\r\n\t  v += ((ar[i] & 0x7F) << shift);\r\n\t  shift += 7;\t  \r\n\t} while (ar[++i] & 0x80);\r\n\tr.push(v);\r\n\t//r[n++]=v;\r\n\tif (reset) v=0;\r\n\tcount--;\r\n  } while (i<ar.length && count);\r\n\r\n  //var rr=r.subarray(0,n);\r\n  return {data:r, adv:i };\r\n}\r\nvar Open=function(path,opts,cb) {\r\n\topts=opts||{};\r\n\r\n\tvar readSignature=function(pos,cb) {\r\n\t\tvar buf=new Buffer(signature_size);\r\n\t\tvar that=this;\r\n\t\tfs.read(this.handle,buf,0,signature_size,pos,function(err,len,buffer){\r\n\t\t\tif (html5fs) var signature=String.fromCharCode((new Uint8Array(buffer))[0])\r\n\t\t\telse var signature=buffer.toString('utf8',0,signature_size);\r\n\t\t\tcb.apply(that,[signature]);\r\n\t\t});\r\n\t}\r\n\r\n\t//this is quite slow\r\n\t//wait for StringView +ArrayBuffer to solve the problem\r\n\t//https://groups.google.com/a/chromium.org/forum/#!topic/blink-dev/ylgiNY_ZSV0\r\n\t//if the string is always ucs2\r\n\t//can use Uint16 to read it.\r\n\t//http://updates.html5rocks.com/2012/06/How-to-convert-ArrayBuffer-to-and-from-String\r\n\tvar decodeutf8 = function (utftext) {\r\n\t\tvar string = \"\";\r\n\t\tvar i = 0;\r\n\t\tvar c=0,c1 = 0, c2 = 0 , c3=0;\r\n\t\tfor (var i=0;i<utftext.length;i++) {\r\n\t\t\tif (utftext.charCodeAt(i)>127) break;\r\n\t\t}\r\n\t\tif (i>=utftext.length) return utftext;\r\n\r\n\t\twhile ( i < utftext.length ) {\r\n\t\t\tc = utftext.charCodeAt(i);\r\n\t\t\tif (c < 128) {\r\n\t\t\t\tstring += utftext[i];\r\n\t\t\t\ti++;\r\n\t\t\t} else if((c > 191) && (c < 224)) {\r\n\t\t\t\tc2 = utftext.charCodeAt(i+1);\r\n\t\t\t\tstring += String.fromCharCode(((c & 31) << 6) | (c2 & 63));\r\n\t\t\t\ti += 2;\r\n\t\t\t} else {\r\n\t\t\t\tc2 = utftext.charCodeAt(i+1);\r\n\t\t\t\tc3 = utftext.charCodeAt(i+2);\r\n\t\t\t\tstring += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));\r\n\t\t\t\ti += 3;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn string;\r\n\t}\r\n\r\n\tvar readString= function(pos,blocksize,encoding,cb) {\r\n\t\tencoding=encoding||'utf8';\r\n\t\tvar buffer=new Buffer(blocksize);\r\n\t\tvar that=this;\r\n\t\tfs.read(this.handle,buffer,0,blocksize,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"string\",len);\r\n\t\t\tif (html5fs) {\r\n\t\t\t\tif (encoding=='utf8') {\r\n\t\t\t\t\tvar str=decodeutf8(String.fromCharCode.apply(null, new Uint8Array(buffer)))\r\n\t\t\t\t} else { //ucs2 is 3 times faster\r\n\t\t\t\t\tvar str=String.fromCharCode.apply(null, new Uint16Array(buffer))\t\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tcb.apply(that,[str]);\r\n\t\t\t} \r\n\t\t\telse cb.apply(that,[buffer.toString(encoding)]);\t\r\n\t\t});\r\n\t}\r\n\r\n\t//work around for chrome fromCharCode cannot accept huge array\r\n\t//https://code.google.com/p/chromium/issues/detail?id=56588\r\n\tvar buf2stringarr=function(buf,enc) {\r\n\t\tif (enc==\"utf8\") \tvar arr=new Uint8Array(buf);\r\n\t\telse var arr=new Uint16Array(buf);\r\n\t\tvar i=0,codes=[],out=[],s=\"\";\r\n\t\twhile (i<arr.length) {\r\n\t\t\tif (arr[i]) {\r\n\t\t\t\tcodes[codes.length]=arr[i];\r\n\t\t\t} else {\r\n\t\t\t\ts=String.fromCharCode.apply(null,codes);\r\n\t\t\t\tif (enc==\"utf8\") out[out.length]=decodeutf8(s);\r\n\t\t\t\telse out[out.length]=s;\r\n\t\t\t\tcodes=[];\t\t\t\t\r\n\t\t\t}\r\n\t\t\ti++;\r\n\t\t}\r\n\t\t\r\n\t\ts=String.fromCharCode.apply(null,codes);\r\n\t\tif (enc==\"utf8\") out[out.length]=decodeutf8(s);\r\n\t\telse out[out.length]=s;\r\n\r\n\t\treturn out;\r\n\t}\r\n\tvar readStringArray = function(pos,blocksize,encoding,cb) {\r\n\t\tvar that=this,out=null;\r\n\t\tif (blocksize==0) return [];\r\n\t\tencoding=encoding||'utf8';\r\n\t\tvar buffer=new Buffer(blocksize);\r\n\t\tfs.read(this.handle,buffer,0,blocksize,pos,function(err,len,buffer){\r\n\t\t\tif (html5fs) {\r\n\t\t\t\treadLog(\"stringArray\",buffer.byteLength);\r\n\r\n\t\t\t\tif (encoding=='utf8') {\r\n\t\t\t\t\tout=buf2stringarr(buffer,\"utf8\");\r\n\t\t\t\t} else { //ucs2 is 3 times faster\r\n\t\t\t\t\tout=buf2stringarr(buffer,\"ucs2\");\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\treadLog(\"stringArray\",buffer.length);\r\n\t\t\t\tout=buffer.toString(encoding).split('\\0');\r\n\t\t\t} \t\r\n\t\t\tcb.apply(that,[out]);\r\n\t\t});\r\n\t}\r\n\tvar readUI32=function(pos,cb) {\r\n\t\tvar buffer=new Buffer(4);\r\n\t\tvar that=this;\r\n\t\tfs.read(this.handle,buffer,0,4,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"ui32\",len);\r\n\t\t\tif (html5fs){\r\n\t\t\t\t//v=(new Uint32Array(buffer))[0];\r\n\t\t\t\tvar v=new DataView(buffer).getUint32(0, false)\r\n\t\t\t\tcb(v);\r\n\t\t\t}\r\n\t\t\telse cb.apply(that,[buffer.readInt32BE(0)]);\t\r\n\t\t});\t\t\r\n\t}\r\n\r\n\tvar readI32=function(pos,cb) {\r\n\t\tvar buffer=new Buffer(4);\r\n\t\tvar that=this;\r\n\t\tfs.read(this.handle,buffer,0,4,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"i32\",len);\r\n\t\t\tif (html5fs){\r\n\t\t\t\tvar v=new DataView(buffer).getInt32(0, false)\r\n\t\t\t\tcb(v);\r\n\t\t\t}\r\n\t\t\telse  \tcb.apply(that,[buffer.readInt32BE(0)]);\t\r\n\t\t});\r\n\t}\r\n\tvar readUI8=function(pos,cb) {\r\n\t\tvar buffer=new Buffer(1);\r\n\t\tvar that=this;\r\n\r\n\t\tfs.read(this.handle,buffer,0,1,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"ui8\",len);\r\n\t\t\tif (html5fs)cb( (new Uint8Array(buffer))[0]) ;\r\n\t\t\telse  \t\t\tcb.apply(that,[buffer.readUInt8(0)]);\t\r\n\t\t\t\r\n\t\t});\r\n\t}\r\n\tvar readBuf=function(pos,blocksize,cb) {\r\n\t\tvar that=this;\r\n\t\tvar buf=new Buffer(blocksize);\r\n\t\tfs.read(this.handle,buf,0,blocksize,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"buf\",len);\r\n\t\t\tvar buff=new Uint8Array(buffer)\r\n\t\t\tcb.apply(that,[buff]);\r\n\t\t});\r\n\t}\r\n\tvar readBuf_packedint=function(pos,blocksize,count,reset,cb) {\r\n\t\tvar that=this;\r\n\t\treadBuf.apply(this,[pos,blocksize,function(buffer){\r\n\t\t\tcb.apply(that,[unpack_int(buffer,count,reset)]);\t\r\n\t\t}]);\r\n\t\t\r\n\t}\r\n\tvar readFixedArray_html5fs=function(pos,count,unitsize,cb) {\r\n\t\tvar func=null;\r\n\t\tif (unitsize===1) {\r\n\t\t\tfunc='getUint8';//Uint8Array;\r\n\t\t} else if (unitsize===2) {\r\n\t\t\tfunc='getUint16';//Uint16Array;\r\n\t\t} else if (unitsize===4) {\r\n\t\t\tfunc='getUint32';//Uint32Array;\r\n\t\t} else throw 'unsupported integer size';\r\n\r\n\t\tfs.read(this.handle,null,0,unitsize*count,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"fix array\",len);\r\n\t\t\tvar out=[];\r\n\t\t\tif (unitsize==1) {\r\n\t\t\t\tout=new Uint8Array(buffer);\r\n\t\t\t} else {\r\n\t\t\t\tfor (var i = 0; i < len / unitsize; i++) { //endian problem\r\n\t\t\t\t//\tout.push( func(buffer,i*unitsize));\r\n\t\t\t\t\tout.push( v=new DataView(buffer)[func](i,false) );\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tcb.apply(that,[out]);\r\n\t\t});\r\n\t}\r\n\t// signature, itemcount, payload\r\n\tvar readFixedArray = function(pos ,count, unitsize,cb) {\r\n\t\tvar func=null;\r\n\t\tvar that=this;\r\n\t\t\r\n\t\tif (unitsize* count>this.size && this.size)  {\r\n\t\t\tconsole.log(\"array size exceed file size\",this.size)\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tif (html5fs) return readFixedArray_html5fs.apply(this,[pos,count,unitsize,cb]);\r\n\r\n\t\tvar items=new Buffer( unitsize* count);\r\n\t\tif (unitsize===1) {\r\n\t\t\tfunc=items.readUInt8;\r\n\t\t} else if (unitsize===2) {\r\n\t\t\tfunc=items.readUInt16BE;\r\n\t\t} else if (unitsize===4) {\r\n\t\t\tfunc=items.readUInt32BE;\r\n\t\t} else throw 'unsupported integer size';\r\n\t\t//console.log('itemcount',itemcount,'buffer',buffer);\r\n\r\n\t\tfs.read(this.handle,items,0,unitsize*count,pos,function(err,len,buffer){\r\n\t\t\treadLog(\"fix array\",len);\r\n\t\t\tvar out=[];\r\n\t\t\tfor (var i = 0; i < items.length / unitsize; i++) {\r\n\t\t\t\tout.push( func.apply(items,[i*unitsize]));\r\n\t\t\t}\r\n\t\t\tcb.apply(that,[out]);\r\n\t\t});\r\n\t}\r\n\r\n\tvar free=function() {\r\n\t\t//console.log('closing ',handle);\r\n\t\tfs.closeSync(this.handle);\r\n\t}\r\n\tvar setupapi=function() {\r\n\t\tvar that=this;\r\n\t\tthis.readSignature=readSignature;\r\n\t\tthis.readI32=readI32;\r\n\t\tthis.readUI32=readUI32;\r\n\t\tthis.readUI8=readUI8;\r\n\t\tthis.readBuf=readBuf;\r\n\t\tthis.readBuf_packedint=readBuf_packedint;\r\n\t\tthis.readFixedArray=readFixedArray;\r\n\t\tthis.readString=readString;\r\n\t\tthis.readStringArray=readStringArray;\r\n\t\tthis.signature_size=signature_size;\r\n\t\tthis.free=free;\r\n\t\tif (html5fs) {\r\n\t\t\tvar fn=path;\r\n\t\t\tif (path.indexOf(\"filesystem:\")==0) fn=path.substr(path.lastIndexOf(\"/\"));\r\n\t\t\tfs.fs.root.getFile(fn,{},function(entry){\r\n\t\t\t  entry.getMetadata(function(metadata) { \r\n\t\t\t\tthat.size=metadata.size;\r\n\t\t\t\tif (cb) setTimeout(cb.bind(that),0);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tvar stat=fs.fstatSync(this.handle);\r\n\t\t\tthis.stat=stat;\r\n\t\t\tthis.size=stat.size;\t\t\r\n\t\t\tif (cb)\tsetTimeout(cb.bind(this,0),0);\t\r\n\t\t}\r\n\t}\r\n\r\n\tvar that=this;\r\n\tif (html5fs) {\r\n\t\tfs.open(path,function(h){\r\n\t\t\tif (!h) {\r\n\t\t\t\tif (cb)\tsetTimeout(cb.bind(null,\"file not found:\"+path),0);\t\r\n\t\t\t} else {\r\n\t\t\t\tthat.handle=h;\r\n\t\t\t\tthat.html5fs=true;\r\n\t\t\t\tsetupapi.call(that);\r\n\t\t\t\tthat.opened=true;\t\t\t\t\r\n\t\t\t}\r\n\t\t})\r\n\t} else {\r\n\t\tif (fs.existsSync(path)){\r\n\t\t\tthis.handle=fs.openSync(path,'r');//,function(err,handle){\r\n\t\t\tthis.opened=true;\r\n\t\t\tsetupapi.call(this);\r\n\t\t} else {\r\n\t\t\tif (cb)\tsetTimeout(cb.bind(null,\"file not found:\"+path),0);\t\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\treturn this;\r\n}\r\nmodule.exports=Open;",
    "/*\r\n  JAVA can only return Number and String\r\n\tarray and buffer return in string format\r\n\tneed JSON.parse\r\n*/\r\nvar verbose=0;\r\n\r\nvar readSignature=function(pos,cb) {\r\n\tif (verbose) console.debug(\"read signature\");\r\n\tvar signature=kfs.readUTF8String(this.handle,pos,1);\r\n\tif (verbose) console.debug(signature,signature.charCodeAt(0));\r\n\tcb.apply(this,[signature]);\r\n}\r\nvar readI32=function(pos,cb) {\r\n\tif (verbose) console.debug(\"read i32 at \"+pos);\r\n\tvar i32=kfs.readInt32(this.handle,pos);\r\n\tif (verbose) console.debug(i32);\r\n\tcb.apply(this,[i32]);\t\r\n}\r\nvar readUI32=function(pos,cb) {\r\n\tif (verbose) console.debug(\"read ui32 at \"+pos);\r\n\tvar ui32=kfs.readUInt32(this.handle,pos);\r\n\tif (verbose) console.debug(ui32);\r\n\tcb.apply(this,[ui32]);\r\n}\r\nvar readUI8=function(pos,cb) {\r\n\tif (verbose) console.debug(\"read ui8 at \"+pos); \r\n\tvar ui8=kfs.readUInt8(this.handle,pos);\r\n\tif (verbose) console.debug(ui8);\r\n\tcb.apply(this,[ui8]);\r\n}\r\nvar readBuf=function(pos,blocksize,cb) {\r\n\tif (verbose) console.debug(\"read buffer at \"+pos+ \" blocksize \"+blocksize);\r\n\tvar buf=kfs.readBuf(this.handle,pos,blocksize);\r\n\tvar buff=JSON.parse(buf);\r\n\tif (verbose) console.debug(\"buffer length\"+buff.length);\r\n\tcb.apply(this,[buff]);\t\r\n}\r\nvar readBuf_packedint=function(pos,blocksize,count,reset,cb) {\r\n\tif (verbose) console.debug(\"read packed int at \"+pos+\" blocksize \"+blocksize+\" count \"+count);\r\n\tvar buf=kfs.readBuf_packedint(this.handle,pos,blocksize,count,reset);\r\n\tvar adv=parseInt(buf);\r\n\tvar buff=JSON.parse(buf.substr(buf.indexOf(\"[\")));\r\n\tif (verbose) console.debug(\"packedInt length \"+buff.length+\" first item=\"+buff[0]);\r\n\tcb.apply(this,[{data:buff,adv:adv}]);\t\r\n}\r\n\r\n\r\nvar readString= function(pos,blocksize,encoding,cb) {\r\n\tif (verbose) console.debug(\"readstring at \"+pos+\" blocksize \" +blocksize+\" enc:\"+encoding);\r\n\tif (encoding==\"ucs2\") {\r\n\t\tvar str=kfs.readULE16String(this.handle,pos,blocksize);\r\n\t} else {\r\n\t\tvar str=kfs.readUTF8String(this.handle,pos,blocksize);\t\r\n\t}\t \r\n\tif (verbose) console.debug(str);\r\n\tcb.apply(this,[str]);\t\r\n}\r\n\r\nvar readFixedArray = function(pos ,count, unitsize,cb) {\r\n\tif (verbose) console.debug(\"read fixed array at \"+pos+\" count \"+count+\" unitsize \"+unitsize); \r\n\tvar buf=kfs.readFixedArray(this.handle,pos,count,unitsize);\r\n\tvar buff=JSON.parse(buf);\r\n\tif (verbose) console.debug(\"array length\"+buff.length);\r\n\tcb.apply(this,[buff]);\t\r\n}\r\nvar readStringArray = function(pos,blocksize,encoding,cb) {\r\n\tif (verbose) console.log(\"read String array at \"+pos+\" blocksize \"+blocksize +\" enc \"+encoding); \r\n\tencoding = encoding||\"utf8\";\r\n\tvar buf=kfs.readStringArray(this.handle,pos,blocksize,encoding);\r\n\t//var buff=JSON.parse(buf);\r\n\tif (verbose) console.debug(\"read string array\");\r\n\tvar buff=buf.split(\"\\uffff\"); //cannot return string with 0\r\n\tif (verbose) console.debug(\"array length\"+buff.length);\r\n\tcb.apply(this,[buff]);\t\r\n}\r\nvar mergePostings=function(positions,cb) {\r\n\tvar buf=kfs.mergePostings(this.handle,JSON.stringify(positions));\r\n\tif (!buf || buf.length==0) return [];\r\n\telse return JSON.parse(buf);\r\n}\r\n\r\nvar free=function() {\r\n\t//console.log('closing ',handle);\r\n\tkfs.close(this.handle);\r\n}\r\nvar Open=function(path,opts,cb) {\r\n\topts=opts||{};\r\n\tvar signature_size=1;\r\n\tvar setupapi=function() { \r\n\t\tthis.readSignature=readSignature;\r\n\t\tthis.readI32=readI32;\r\n\t\tthis.readUI32=readUI32;\r\n\t\tthis.readUI8=readUI8;\r\n\t\tthis.readBuf=readBuf;\r\n\t\tthis.readBuf_packedint=readBuf_packedint;\r\n\t\tthis.readFixedArray=readFixedArray;\r\n\t\tthis.readString=readString;\r\n\t\tthis.readStringArray=readStringArray;\r\n\t\tthis.signature_size=signature_size;\r\n\t\tthis.mergePostings=mergePostings;\r\n\t\tthis.free=free;\r\n\t\tthis.size=kfs.getFileSize(this.handle);\r\n\t\tif (verbose) console.log(\"filesize  \"+this.size);\r\n\t\tif (cb)\tcb.call(this);\r\n\t}\r\n\r\n\tthis.handle=kfs.open(path);\r\n\tthis.opened=true;\r\n\tsetupapi.call(this);\r\n\treturn this;\r\n}\r\n\r\nmodule.exports=Open;",
    "/*\r\n  JSContext can return all Javascript types.\r\n*/\r\nvar verbose=1;\r\n\r\nvar readSignature=function(pos,cb) {\r\n\tif (verbose)  ksanagap.log(\"read signature at \"+pos);\r\n\tvar signature=kfs.readUTF8String(this.handle,pos,1);\r\n\tif (verbose)  ksanagap.log(signature+\" \"+signature.charCodeAt(0));\r\n\tcb.apply(this,[signature]);\r\n}\r\nvar readI32=function(pos,cb) {\r\n\tif (verbose)  ksanagap.log(\"read i32 at \"+pos);\r\n\tvar i32=kfs.readInt32(this.handle,pos);\r\n\tif (verbose)  ksanagap.log(i32);\r\n\tcb.apply(this,[i32]);\t\r\n}\r\nvar readUI32=function(pos,cb) {\r\n\tif (verbose)  ksanagap.log(\"read ui32 at \"+pos);\r\n\tvar ui32=kfs.readUInt32(this.handle,pos);\r\n\tif (verbose)  ksanagap.log(ui32);\r\n\tcb.apply(this,[ui32]);\r\n}\r\nvar readUI8=function(pos,cb) {\r\n\tif (verbose)  ksanagap.log(\"read ui8 at \"+pos); \r\n\tvar ui8=kfs.readUInt8(this.handle,pos);\r\n\tif (verbose)  ksanagap.log(ui8);\r\n\tcb.apply(this,[ui8]);\r\n}\r\nvar readBuf=function(pos,blocksize,cb) {\r\n\tif (verbose)  ksanagap.log(\"read buffer at \"+pos);\r\n\tvar buf=kfs.readBuf(this.handle,pos,blocksize);\r\n\tif (verbose)  ksanagap.log(\"buffer length\"+buf.length);\r\n\tcb.apply(this,[buf]);\t\r\n}\r\nvar readBuf_packedint=function(pos,blocksize,count,reset,cb) {\r\n\tif (verbose)  ksanagap.log(\"read packed int fast, blocksize \"+blocksize+\" at \"+pos);var t=new Date();\r\n\tvar buf=kfs.readBuf_packedint(this.handle,pos,blocksize,count,reset);\r\n\tif (verbose)  ksanagap.log(\"return from packedint, time\" + (new Date()-t));\r\n\tif (typeof buf.data==\"string\") {\r\n\t\tbuf.data=eval(\"[\"+buf.data.substr(0,buf.data.length-1)+\"]\");\r\n\t}\r\n\tif (verbose)  ksanagap.log(\"unpacked length\"+buf.data.length+\" time\" + (new Date()-t) );\r\n\tcb.apply(this,[buf]);\r\n}\r\n\r\n\r\nvar readString= function(pos,blocksize,encoding,cb) {\r\n\r\n\tif (verbose)  ksanagap.log(\"readstring at \"+pos+\" blocksize \"+blocksize+\" \"+encoding);var t=new Date();\r\n\tif (encoding==\"ucs2\") {\r\n\t\tvar str=kfs.readULE16String(this.handle,pos,blocksize);\r\n\t} else {\r\n\t\tvar str=kfs.readUTF8String(this.handle,pos,blocksize);\t\r\n\t}\r\n\tif (verbose)  ksanagap.log(str+\" time\"+(new Date()-t));\r\n\tcb.apply(this,[str]);\t\r\n}\r\n\r\nvar readFixedArray = function(pos ,count, unitsize,cb) {\r\n\tif (verbose)  ksanagap.log(\"read fixed array at \"+pos); var t=new Date();\r\n\tvar buf=kfs.readFixedArray(this.handle,pos,count,unitsize);\r\n\tif (verbose)  ksanagap.log(\"array length \"+buf.length+\" time\"+(new Date()-t));\r\n\tcb.apply(this,[buf]);\t\r\n}\r\nvar readStringArray = function(pos,blocksize,encoding,cb) {\r\n\t//if (verbose)  ksanagap.log(\"read String array \"+blocksize +\" \"+encoding); \r\n\tencoding = encoding||\"utf8\";\r\n\tif (verbose)  ksanagap.log(\"read string array at \"+pos);var t=new Date();\r\n\tvar buf=kfs.readStringArray(this.handle,pos,blocksize,encoding);\r\n\tif (typeof buf==\"string\") buf=buf.split(\"\\0\");\r\n\t//var buff=JSON.parse(buf);\r\n\t//var buff=buf.split(\"\\uffff\"); //cannot return string with 0\r\n\tif (verbose)  ksanagap.log(\"string array length\"+buf.length+\" time\"+(new Date()-t));\r\n\tcb.apply(this,[buf]);\r\n}\r\n\r\nvar mergePostings=function(positions) {\r\n\tvar buf=kfs.mergePostings(this.handle,positions);\r\n\tif (typeof buf==\"string\") {\r\n\t\tbuf=eval(\"[\"+buf.substr(0,buf.length-1)+\"]\");\r\n\t}\r\n\treturn buf;\r\n}\r\nvar free=function() {\r\n\t////if (verbose)  ksanagap.log('closing ',handle);\r\n\tkfs.close(this.handle);\r\n}\r\nvar Open=function(path,opts,cb) {\r\n\topts=opts||{};\r\n\tvar signature_size=1;\r\n\tvar setupapi=function() { \r\n\t\tthis.readSignature=readSignature;\r\n\t\tthis.readI32=readI32;\r\n\t\tthis.readUI32=readUI32;\r\n\t\tthis.readUI8=readUI8;\r\n\t\tthis.readBuf=readBuf;\r\n\t\tthis.readBuf_packedint=readBuf_packedint;\r\n\t\tthis.readFixedArray=readFixedArray;\r\n\t\tthis.readString=readString;\r\n\t\tthis.readStringArray=readStringArray;\r\n\t\tthis.signature_size=signature_size;\r\n\t\tthis.mergePostings=mergePostings;\r\n\t\tthis.free=free;\r\n\t\tthis.size=kfs.getFileSize(this.handle);\r\n\t\tif (verbose)  ksanagap.log(\"filesize  \"+this.size);\r\n\t\tif (cb)\tcb.call(this);\r\n\t}\r\n\r\n\tthis.handle=kfs.open(path);\r\n\tthis.opened=true;\r\n\tsetupapi.call(this);\r\n\treturn this;\r\n}\r\n\r\nmodule.exports=Open;",
    "/*\r\n  TODO\r\n  and not\r\n\r\n*/\r\n\r\n// http://jsfiddle.net/neoswf/aXzWw/\r\nvar plist=require('./plist');\r\nfunction intersect(I, J) {\r\n  var i = j = 0;\r\n  var result = [];\r\n\r\n  while( i < I.length && j < J.length ){\r\n     if      (I[i] < J[j]) i++; \r\n     else if (I[i] > J[j]) j++; \r\n     else {\r\n       result[result.length]=l[i];\r\n       i++;j++;\r\n     }\r\n  }\r\n  return result;\r\n}\r\n\r\n/* return all items in I but not in J */\r\nfunction subtract(I, J) {\r\n  var i = j = 0;\r\n  var result = [];\r\n\r\n  while( i < I.length && j < J.length ){\r\n    if (I[i]==J[j]) {\r\n      i++;j++;\r\n    } else if (I[i]<J[j]) {\r\n      while (I[i]<J[j]) result[result.length]= I[i++];\r\n    } else {\r\n      while(J[j]<I[i]) j++;\r\n    }\r\n  }\r\n\r\n  if (j==J.length) {\r\n    while (i<I.length) result[result.length]=I[i++];\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nvar union=function(a,b) {\r\n\tif (!a || !a.length) return b;\r\n\tif (!b || !b.length) return a;\r\n    var result = [];\r\n    var ai = 0;\r\n    var bi = 0;\r\n    while (true) {\r\n        if ( ai < a.length && bi < b.length) {\r\n            if (a[ai] < b[bi]) {\r\n                result[result.length]=a[ai];\r\n                ai++;\r\n            } else if (a[ai] > b[bi]) {\r\n                result[result.length]=b[bi];\r\n                bi++;\r\n            } else {\r\n                result[result.length]=a[ai];\r\n                result[result.length]=b[bi];\r\n                ai++;\r\n                bi++;\r\n            }\r\n        } else if (ai < a.length) {\r\n            result.push.apply(result, a.slice(ai, a.length));\r\n            break;\r\n        } else if (bi < b.length) {\r\n            result.push.apply(result, b.slice(bi, b.length));\r\n            break;\r\n        } else {\r\n            break;\r\n        }\r\n    }\r\n    return result;\r\n}\r\nvar OPERATION={'include':intersect, 'union':union, 'exclude':subtract};\r\n\r\nvar boolSearch=function(opts) {\r\n  opts=opts||{};\r\n  ops=opts.op||this.opts.op;\r\n  this.docs=[];\r\n\tif (!this.phrases.length) return;\r\n\tvar r=this.phrases[0].docs;\r\n  /* ignore operator of first phrase */\r\n\tfor (var i=1;i<this.phrases.length;i++) {\r\n\t\tvar op= ops[i] || 'union';\r\n\t\tr=OPERATION[op](r,this.phrases[i].docs);\r\n\t}\r\n\tthis.docs=plist.unique(r);\r\n\treturn this;\r\n}\r\nmodule.exports={search:boolSearch}",
    "var indexOfSorted = function (array, obj, near) { \r\n  var low = 0,\r\n  high = array.length;\r\n  while (low < high) {\r\n    var mid = (low + high) >> 1;\r\n    if (array[mid]==obj) return mid;\r\n    array[mid] < obj ? low = mid + 1 : high = mid;\r\n  }\r\n  if (near) return low;\r\n  else if (array[low]==obj) return low;else return -1;\r\n};\r\nvar indexOfSorted_str = function (array, obj, near) { \r\n  var low = 0,\r\n  high = array.length;\r\n  while (low < high) {\r\n    var mid = (low + high) >> 1;\r\n    if (array[mid]==obj) return mid;\r\n    (array[mid].localeCompare(obj)<0) ? low = mid + 1 : high = mid;\r\n  }\r\n  if (near) return low;\r\n  else if (array[low]==obj) return low;else return -1;\r\n};\r\n\r\n\r\nvar bsearch=function(array,value,near) {\r\n\tvar func=indexOfSorted;\r\n\tif (typeof array[0]==\"string\") func=indexOfSorted_str;\r\n\treturn func(array,value,near);\r\n}\r\nvar bsearchNear=function(array,value) {\r\n\treturn bsearch(array,value,true);\r\n}\r\n\r\nmodule.exports=bsearch;//{bsearchNear:bsearchNear,bsearch:bsearch};",
    "var plist=require(\"./plist\");\r\n\r\nvar getPhraseWidths=function (Q,phraseid,vposs) {\r\n\tvar res=[];\r\n\tfor (var i in vposs) {\r\n\t\tres.push(getPhraseWidth(Q,phraseid,vposs[i]));\r\n\t}\r\n\treturn res;\r\n}\r\nvar getPhraseWidth=function (Q,phraseid,vpos) {\r\n\tvar P=Q.phrases[phraseid];\r\n\tvar width=0,varwidth=false;\r\n\tif (P.width) return P.width; // no wildcard\r\n\tif (P.termid.length<2) return P.termlength[0];\r\n\tvar lasttermposting=Q.terms[P.termid[P.termid.length-1]].posting;\r\n\r\n\tfor (var i in P.termid) {\r\n\t\tvar T=Q.terms[P.termid[i]];\r\n\t\tif (T.op=='wildcard') {\r\n\t\t\twidth+=T.width;\r\n\t\t\tif (T.wildcard=='*') varwidth=true;\r\n\t\t} else {\r\n\t\t\twidth+=P.termlength[i];\r\n\t\t}\r\n\t}\r\n\tif (varwidth) { //width might be smaller due to * wildcard\r\n\t\tvar at=plist.indexOfSorted(lasttermposting,vpos);\r\n\t\tvar endpos=lasttermposting[at];\r\n\t\tif (endpos-vpos<width) width=endpos-vpos+1;\r\n\t}\r\n\r\n\treturn width;\r\n}\r\n/* return [vpos, phraseid, phrasewidth, optional_tagname] by slot range*/\r\nvar hitInRange=function(Q,startvpos,endvpos) {\r\n\tvar res=[];\r\n\tif (!Q || !Q.rawresult || !Q.rawresult.length) return res;\r\n\tfor (var i=0;i<Q.phrases.length;i++) {\r\n\t\tvar P=Q.phrases[i];\r\n\t\tif (!P.posting) continue;\r\n\t\tvar s=plist.indexOfSorted(P.posting,startvpos);\r\n\t\tvar e=plist.indexOfSorted(P.posting,endvpos);\r\n\t\tvar r=P.posting.slice(s,e+1);\r\n\t\tvar width=getPhraseWidths(Q,i,r);\r\n\r\n\t\tres=res.concat(r.map(function(vpos,idx){ return [vpos,width[idx],i] }));\r\n\t}\r\n\t// order by vpos, if vpos is the same, larger width come first.\r\n\t// so the output will be\r\n\t// <tag1><tag2>one</tag2>two</tag1>\r\n\t//TODO, might cause overlap if same vpos and same width\r\n\t//need to check tag name\r\n\tres.sort(function(a,b){return a[0]==b[0]? b[1]-a[1] :a[0]-b[0]});\r\n\r\n\treturn res;\r\n}\r\n\r\nvar tagsInRange=function(Q,renderTags,startvpos,endvpos) {\r\n\tvar res=[];\r\n\tif (typeof renderTags==\"string\") renderTags=[renderTags];\r\n\r\n\trenderTags.map(function(tag){\r\n\t\tvar starts=Q.engine.get([\"fields\",tag+\"_start\"]);\r\n\t\tvar ends=Q.engine.get([\"fields\",tag+\"_end\"]);\r\n\t\tif (!starts) return;\r\n\r\n\t\tvar s=plist.indexOfSorted(starts,startvpos);\r\n\t\tvar e=s;\r\n\t\twhile (e<starts.length && starts[e]<endvpos) e++;\r\n\t\tvar opentags=starts.slice(s,e);\r\n\r\n\t\ts=plist.indexOfSorted(ends,startvpos);\r\n\t\te=s;\r\n\t\twhile (e<ends.length && ends[e]<endvpos) e++;\r\n\t\tvar closetags=ends.slice(s,e);\r\n\r\n\t\topentags.map(function(start,idx) {\r\n\t\t\tres.push([start,closetags[idx]-start,tag]);\r\n\t\t})\r\n\t});\r\n\t// order by vpos, if vpos is the same, larger width come first.\r\n\tres.sort(function(a,b){return a[0]==b[0]? b[1]-a[1] :a[0]-b[0]});\r\n\r\n\treturn res;\r\n}\r\n\r\n/*\r\ngiven a vpos range start, file, convert to filestart, fileend\r\n   filestart : starting file\r\n   start   : vpos start\r\n   showfile: how many files to display\r\n   showpage: how many pages to display\r\n\r\noutput:\r\n   array of fileid with hits\r\n*/\r\nvar getFileWithHits=function(engine,Q,range) {\r\n\tvar fileOffsets=engine.get(\"fileoffsets\");\r\n\tvar out=[],filecount=100;\r\n\tvar start=0 , end=Q.byFile.length;\r\n\tQ.excerptOverflow=false;\r\n\tif (range.start) {\r\n\t\tvar first=range.start ;\r\n\t\tvar last=range.end;\r\n\t\tif (!last) last=Number.MAX_SAFE_INTEGER;\r\n\t\tfor (var i=0;i<fileOffsets.length;i++) {\r\n\t\t\t//if (fileOffsets[i]>first) break;\r\n\t\t\tif (fileOffsets[i]>last) {\r\n\t\t\t\tend=i;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tif (fileOffsets[i]<first) start=i;\r\n\t\t}\t\t\r\n\t} else {\r\n\t\tstart=range.filestart || 0;\r\n\t\tif (range.maxfile) {\r\n\t\t\tfilecount=range.maxfile;\r\n\t\t} else if (range.showseg) {\r\n\t\t\tthrow \"not implement yet\"\r\n\t\t}\r\n\t}\r\n\r\n\tvar fileWithHits=[],totalhit=0;\r\n\trange.maxhit=range.maxhit||1000;\r\n\r\n\tfor (var i=start;i<end;i++) {\r\n\t\tif(Q.byFile[i].length>0) {\r\n\t\t\ttotalhit+=Q.byFile[i].length;\r\n\t\t\tfileWithHits.push(i);\r\n\t\t\trange.nextFileStart=i;\r\n\t\t\tif (fileWithHits.length>=filecount) {\r\n\t\t\t\tQ.excerptOverflow=true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tif (totalhit>range.maxhit) {\r\n\t\t\t\tQ.excerptOverflow=true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif (i>=end) { //no more file\r\n\t\tQ.excerptStop=true;\r\n\t}\r\n\treturn fileWithHits;\r\n}\r\nvar resultlist=function(engine,Q,opts,cb) {\r\n\tvar output=[];\r\n\tif (!Q.rawresult || !Q.rawresult.length) {\r\n\t\tcb(output);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (opts.range) {\r\n\t\tif (opts.range.maxhit && !opts.range.maxfile) {\r\n\t\t\topts.range.maxfile=opts.range.maxhit;\r\n\t\t\topts.range.maxseg=opts.range.maxhit;\r\n\t\t}\r\n\t\tif (!opts.range.maxseg) opts.range.maxseg=100;\r\n\t\tif (!opts.range.end) {\r\n\t\t\topts.range.end=Number.MAX_SAFE_INTEGER;\r\n\t\t}\r\n\t}\r\n\tvar fileWithHits=getFileWithHits(engine,Q,opts.range);\r\n\tif (!fileWithHits.length) {\r\n\t\tcb(output);\r\n\t\treturn;\r\n\t}\r\n\r\n\tvar output=[],files=[];//temporary holder for segnames\r\n\tfor (var i=0;i<fileWithHits.length;i++) {\r\n\t\tvar nfile=fileWithHits[i];\r\n\t\tvar segoffsets=engine.getFileSegOffsets(nfile);\r\n\t\tvar segnames=engine.getFileSegNames(nfile);\r\n\t\tfiles[nfile]={segoffsets:segoffsets};\r\n\t\tvar segwithhit=plist.groupbyposting2(Q.byFile[ nfile ],  segoffsets);\r\n\t\t//if (segoffsets[0]==1)\r\n\t\t//segwithhit.shift(); //the first item is not used (0~Q.byFile[0] )\r\n\r\n\t\tfor (var j=0; j<segwithhit.length;j++) {\r\n\t\t\tif (!segwithhit[j].length) continue;\r\n\t\t\t//var offsets=segwithhit[j].map(function(p){return p- fileOffsets[i]});\r\n\t\t\tif (segoffsets[j]>opts.range.end) break;\r\n\t\t\toutput.push(  {file: nfile, seg:j,  segname:segnames[j]});\r\n\t\t\tif (output.length>opts.range.maxseg) break;\r\n\t\t}\r\n\t}\r\n\r\n\tvar segpaths=output.map(function(p){\r\n\t\treturn [\"filecontents\",p.file,p.seg];\r\n\t});\r\n\t//prepare the text\r\n\tengine.get(segpaths,function(segs){\r\n\t\tvar seq=0;\r\n\t\tif (segs) for (var i=0;i<segs.length;i++) {\r\n\t\t\tvar startvpos=files[output[i].file].segoffsets[output[i].seg-1] ||0;\r\n\t\t\tvar endvpos=files[output[i].file].segoffsets[output[i].seg];\r\n\t\t\tvar hl={};\r\n\r\n\t\t\tif (opts.range && opts.range.start  ) {\r\n\t\t\t\tif ( startvpos<opts.range.start) startvpos=opts.range.start;\r\n\t\t\t//\tif (endvpos>opts.range.end) endvpos=opts.range.end;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (opts.nohighlight) {\r\n\t\t\t\thl.text=segs[i];\r\n\t\t\t\thl.hits=hitInRange(Q,startvpos,endvpos);\r\n\t\t\t} else {\r\n\t\t\t\tvar o={nocrlf:true,nospan:true,\r\n\t\t\t\t\ttext:segs[i],startvpos:startvpos, endvpos: endvpos, \r\n\t\t\t\t\tQ:Q,fulltext:opts.fulltext};\r\n\t\t\t\thl=highlight(Q,o);\r\n\t\t\t}\r\n\t\t\tif (hl.text) {\r\n\t\t\t\toutput[i].text=hl.text;\r\n\t\t\t\toutput[i].hits=hl.hits;\r\n\t\t\t\toutput[i].seq=seq;\r\n\t\t\t\tseq+=hl.hits.length;\r\n\r\n\t\t\t\toutput[i].start=startvpos;\t\t\t\t\r\n\t\t\t} else {\r\n\t\t\t\toutput[i]=null; //remove item vpos less than opts.range.start\r\n\t\t\t}\r\n\t\t} \r\n\t\toutput=output.filter(function(o){return o!=null});\r\n\t\tcb(output);\r\n\t});\r\n}\r\nvar injectTag=function(Q,opts){\r\n\tvar hits=opts.hits;\r\n\tvar tags=opts.tags;\r\n\tif (!tags) tags=[];\r\n\tvar hitclass=opts.hitclass||'hl';\r\n\tvar output='',O=[],j=0,k=0;\r\n\tvar surround=opts.surround||5;\r\n\r\n\tvar tokens=Q.tokenize(opts.text).tokens;\r\n\tvar vpos=opts.vpos;\r\n\tvar i=0,previnrange=!!opts.fulltext ,inrange=!!opts.fulltext;\r\n\tvar hitstart=0,hitend=0,tagstart=0,tagend=0,tagclass=\"\";\r\n\twhile (i<tokens.length) {\r\n\t\tvar skip=Q.isSkip(tokens[i]);\r\n\t\tvar hashit=false;\r\n\t\tinrange=opts.fulltext || (j<hits.length && vpos+surround>=hits[j][0] ||\r\n\t\t\t\t(j>0 && j<=hits.length &&  hits[j-1][0]+surround*2>=vpos));\t\r\n\r\n\t\tif (previnrange!=inrange) {\r\n\t\t\toutput+=opts.abridge||\"...\";\r\n\t\t}\r\n\t\tprevinrange=inrange;\r\n\t\tvar token=tokens[i];\r\n\t\tif (opts.nocrlf && token==\"\\n\") token=\"\";\r\n\r\n\t\tif (inrange && i<tokens.length) {\r\n\t\t\tif (skip) {\r\n\t\t\t\toutput+=token;\r\n\t\t\t} else {\r\n\t\t\t\tvar classes=\"\";\t\r\n\r\n\t\t\t\t//check hit\r\n\t\t\t\tif (j<hits.length && vpos==hits[j][0]) {\r\n\t\t\t\t\tvar nphrase=hits[j][2] % 10, width=hits[j][1];\r\n\t\t\t\t\thitstart=hits[j][0];\r\n\t\t\t\t\thitend=hitstart+width;\r\n\t\t\t\t\tj++;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t//check tag\r\n\t\t\t\tif (k<tags.length && vpos==tags[k][0]) {\r\n\t\t\t\t\tvar width=tags[k][1];\r\n\t\t\t\t\ttagstart=tags[k][0];\r\n\t\t\t\t\ttagend=tagstart+width;\r\n\t\t\t\t\ttagclass=tags[k][2];\r\n\t\t\t\t\tk++;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (vpos>=hitstart && vpos<hitend) classes=hitclass+\" \"+hitclass+nphrase;\r\n\t\t\t\tif (vpos>=tagstart && vpos<tagend) classes+=\" \"+tagclass;\r\n\r\n\t\t\t\tif (classes || !opts.nospan) {\r\n\t\t\t\t\toutput+='<span vpos=\"'+vpos+'\"';\r\n\t\t\t\t\tif (classes) classes=' class=\"'+classes+'\"';\r\n\t\t\t\t\toutput+=classes+'>';\r\n\t\t\t\t\toutput+=token+'</span>';\r\n\t\t\t\t} else {\r\n\t\t\t\t\toutput+=token;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (!skip) vpos++;\r\n\t\ti++; \r\n\t}\r\n\r\n\tO.push(output);\r\n\toutput=\"\";\r\n\r\n\treturn O.join(\"\");\r\n}\r\nvar highlight=function(Q,opts) {\r\n\tif (!opts.text) return {text:\"\",hits:[]};\r\n\tvar opt={text:opts.text,\r\n\t\thits:null,abridge:opts.abridge,vpos:opts.startvpos,\r\n\t\tfulltext:opts.fulltext,renderTags:opts.renderTags,nospan:opts.nospan,nocrlf:opts.nocrlf,\r\n\t};\r\n\r\n\topt.hits=hitInRange(opts.Q,opts.startvpos,opts.endvpos);\r\n\treturn {text:injectTag(Q,opt),hits:opt.hits};\r\n}\r\n\r\nvar addspan=function(text,startvpos){\r\n\tengine=this;\r\n\tvar output=\"\";\r\n\tvar tokens=engine.analyzer.tokenize(text).tokens;\r\n\tvar isSkip=engine.analyzer.isSkip;\r\n\tvar vpos=startvpos;\r\n\tfor (var i=0;i<tokens.length;i++) {\r\n\t\toutput+='<span vpos=\"'+(vpos)+'\">'+tokens[i]+\"</span>\";\r\n\t\tif (!isSkip(tokens[i])) vpos++;\r\n\t}\t\t\r\n\treturn output;\r\n}\r\nvar addtoken=function(text,startvpos) {\r\n\tengine=this;\r\n\tvar output=[];\r\n\tvar tokens=engine.analyzer.tokenize(text).tokens;\r\n\tvar isSkip=engine.analyzer.isSkip;\r\n\tvar vpos=startvpos;\r\n\tfor (var i=0;i<tokens.length;i++) {\r\n\t\toutput.push([tokens[i],vpos]);\r\n\t\tif (!isSkip(tokens[i])) vpos++;\r\n\t}\t\t\r\n\treturn output;\r\n}\r\nvar getSeg=function(engine,fileid,segid,opts,cb,context) {\r\n\tif (typeof opts==\"function\") {\r\n\t\tcontext=cb;\r\n\t\tcb=opts;\r\n\t\topts={};\r\n\t}\r\n\r\n\tvar fileOffsets=engine.get(\"fileoffsets\");\r\n\tvar segpaths=[\"filecontents\",fileid,segid];\r\n\tvar segnames=engine.getFileSegNames(fileid);\r\n\tvar vpos=engine.fileSegToVpos(fileid,segid);\r\n\r\n\tengine.get(segpaths,function(text){\r\n\t\tvar out=text;\r\n\t\tif (opts.span) out=addspan.apply(engine,[text,vpos]);\r\n\t\telse if(opts.token) out=addtoken.apply(engine,[text,vpos]);\r\n\t\tcb.apply(context||engine.context,[{text:out,file:fileid,seg:segid,segname:segnames[segid]}]);\r\n\t});\r\n}\r\n\r\nvar getSegSync=function(engine,fileid,segid) {\r\n\tvar fileOffsets=engine.get(\"fileoffsets\");\r\n\tvar segpaths=[\"filecontents\",fileid,segid];\r\n\tvar segnames=engine.getFileSegNames(fileid);\r\n\r\n\tvar text=engine.get(segpaths);\r\n\treturn {text:text,file:fileid,seg:segid,segname:segnames[segid]};\r\n}\r\n\r\nvar getRange=function(engine,start,end,cb) {\r\n\tvar fileoffsets=engine.get(\"fileoffsets\");\r\n\t//var pagepaths=[\"fileContents\",];\r\n\t//find first page and last page\r\n\t//create get paths\r\n\r\n}\r\n\r\nvar getFile=function(engine,fileid,cb) {\r\n\tvar filename=engine.get(\"filenames\")[fileid];\r\n\tvar segnames=engine.getFileSegNames(fileid);\r\n\tvar filestart=engine.get(\"fileoffsets\")[fileid];\r\n\tvar offsets=engine.getFileSegOffsets(fileid);\r\n\tvar pc=0;\r\n\tengine.get([\"fileContents\",fileid],true,function(data){\r\n\t\tvar text=data.map(function(t,idx) {\r\n\t\t\tif (idx==0) return \"\"; \r\n\t\t\tvar pb='<pb n=\"'+segnames[idx]+'\"></pb>';\r\n\t\t\treturn pb+t;\r\n\t\t});\r\n\t\tcb({texts:data,text:text.join(\"\"),segnames:segnames,filestart:filestart,offsets:offsets,file:fileid,filename:filename}); //force different token\r\n\t});\r\n}\r\n\r\nvar highlightRange=function(Q,startvpos,endvpos,opts,cb){\r\n\t//not implement yet\r\n}\r\n\r\nvar highlightFile=function(Q,fileid,opts,cb) {\r\n\tif (typeof opts==\"function\") {\r\n\t\tcb=opts;\r\n\t}\r\n\r\n\tif (!Q || !Q.engine) return cb(null);\r\n\r\n\tvar segoffsets=Q.engine.getFileSegOffsets(fileid);\r\n\tvar output=[];\t\r\n\t//console.log(startvpos,endvpos)\r\n\tQ.engine.get([\"filecontents\",fileid],true,function(data){\r\n\t\tif (!data) {\r\n\t\t\tconsole.error(\"wrong file id\",fileid);\r\n\t\t} else {\r\n\t\t\tfor (var i=0;i<data.length-1;i++ ){\r\n\t\t\t\tvar startvpos=segoffsets[i];\r\n\t\t\t\tvar endvpos=segoffsets[i+1];\r\n\t\t\t\tvar segnames=Q.engine.getFileSegNames(fileid);\r\n\t\t\t\tvar seg=getSegSync(Q.engine, fileid,i+1);\r\n\t\t\t\tvar opt={text:seg.text,hits:null,tag:'hl',vpos:startvpos,\r\n\t\t\t\t\tfulltext:true,nospan:opts.nospan,nocrlf:opts.nocrlf};\r\n\t\t\t\tvar segname=segnames[i+1];\r\n\t\t\t\topt.hits=hitInRange(Q,startvpos,endvpos);\r\n\t\t\t\tvar pb='<pb n=\"'+segname+'\"></pb>';\r\n\t\t\t\tvar withtag=injectTag(Q,opt);\r\n\t\t\t\toutput.push(pb+withtag);\r\n\t\t\t}\t\t\t\r\n\t\t}\r\n\r\n\t\tcb.apply(Q.engine.context,[{text:output.join(\"\"),file:fileid}]);\r\n\t})\r\n}\r\nvar highlightSeg=function(Q,fileid,segid,opts,cb,context) {\r\n\tif (typeof opts==\"function\") {\r\n\t\tcb=opts;\r\n\t}\r\n\r\n\tif (!Q || !Q.engine) return cb.apply(context,[null]);\r\n\tvar segoffsets=Q.engine.getFileSegOffsets(fileid);\r\n\tvar startvpos=segoffsets[segid-1];\r\n\tvar endvpos=segoffsets[segid];\r\n\tvar segnames=Q.engine.getFileSegNames(fileid);\r\n\r\n\tthis.getSeg(Q.engine,fileid,segid,function(res){\r\n\t\tvar opt={text:res.text,hits:null,vpos:startvpos,fulltext:true,\r\n\t\t\tnospan:opts.nospan,nocrlf:opts.nocrlf};\r\n\t\t\topt.hits=hitInRange(Q,startvpos,endvpos);\r\n\t\t\tif (opts.renderTags) {\r\n\t\t\t\topt.tags=tagsInRange(Q,opts.renderTags,startvpos,endvpos);\r\n\t\t\t}\r\n\r\n\t\tvar segname=segnames[segid];\r\n\t\tcb.apply(context||Q.engine.context,[{text:injectTag(Q,opt),seg:segid,file:fileid,hits:opt.hits,segname:segname}]);\r\n\t});\r\n}\r\nmodule.exports={resultlist:resultlist, \r\n\thitInRange:hitInRange, \r\n\thighlightSeg:highlightSeg,\r\n\tgetSeg:getSeg,\r\n\thighlightFile:highlightFile,\r\n\tgetFile:getFile\r\n\t//highlightRange:highlightRange,\r\n  //getRange:getRange,\r\n};",
    "/*\r\n  Ksana Search Engine.\r\n\r\n  need a KDE instance to be functional\r\n  \r\n*/\r\nvar bsearch=require(\"./bsearch\");\r\nvar dosearch=require(\"./search\");\r\n\r\nvar prepareEngineForSearch=function(engine,cb){\r\n\tif (engine.get(\"tokens\") && engine.tokenizer) {\r\n\t\tcb();\r\n\t\treturn;\r\n\t}\r\n\r\n\tengine.get([[\"tokens\"],[\"postingslength\"]],function(){\r\n\t\tif (!engine.analyzer) {\r\n\t\t\tvar analyzer=require(\"ksana-analyzer\");\r\n\t\t\tvar config=engine.get(\"meta\").config;\r\n\t\t\tengine.analyzer=analyzer.getAPI(config);\t\t\t\r\n\t\t}\r\n\t\tcb();\r\n\t});\r\n}\r\n\r\nvar _search=function(engine,q,opts,cb,context) {\r\n\tif (typeof engine==\"string\") {//browser only\r\n\t\tvar kde=require(\"ksana-database\");\r\n\t\tif (typeof opts==\"function\") { //user didn't supply options\r\n\t\t\tif (typeof cb==\"object\")context=cb;\r\n\t\t\tcb=opts;\r\n\t\t\topts={};\r\n\t\t}\r\n\t\topts.q=q;\r\n\t\topts.dbid=engine;\r\n\t\tkde.open(opts.dbid,function(err,db){\r\n\t\t\tif (err) {\r\n\t\t\t\tcb(err);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tprepareEngineForSearch(db,function(){\r\n\t\t\t\treturn dosearch(db,q,opts,cb);\t\r\n\t\t\t});\r\n\t\t},context);\r\n\t} else {\r\n\t\tprepareEngineForSearch(engine,function(){\r\n\t\t\treturn dosearch(engine,q,opts,cb);\t\r\n\t\t});\r\n\t}\r\n}\r\n\r\nvar _highlightSeg=function(engine,fileid,segid,opts,cb,context){\r\n\tif (!opts.q) {\r\n\t\tif (!engine.analyzer) {\r\n\t\t\tvar analyzer=require(\"ksana-analyzer\");\r\n\t\t\tvar config=engine.get(\"meta\").config;\r\n\t\t\tengine.analyzer=analyzer.getAPI(config);\t\t\t\r\n\t\t}\r\n\t\tapi.excerpt.getSeg(engine,fileid,segid,opts,cb,context);\r\n\t} else {\r\n\t\t_search(engine,opts.q,opts,function(err,Q){\r\n\t\t\tapi.excerpt.highlightSeg(Q,fileid,segid,opts,cb,context);\r\n\t\t});\t\t\t\r\n\t}\r\n}\r\nvar _highlightRange=function(engine,start,end,opts,cb,context){\r\n\r\n\tif (opts.q) {\r\n\t\t_search(engine,opts.q,opts,function(err,Q){\r\n\t\t\tapi.excerpt.highlightRange(Q,start,end,opts,cb,context);\r\n\t\t});\r\n\t} else {\r\n\t\tprepareEngineForSearch(engine,function(){\r\n\t\t\tapi.excerpt.getRange(engine,start,end,cb,context);\r\n\t\t});\r\n\t}\r\n}\r\nvar _highlightFile=function(engine,fileid,opts,cb){\r\n\tif (!opts.q) opts.q=\"\"; \r\n\t_search(engine,opts.q,opts,function(err,Q){\r\n\t\tapi.excerpt.highlightFile(Q,fileid,opts,cb);\r\n\t});\r\n\t/*\r\n\t} else {\r\n\t\tapi.excerpt.getFile(engine,fileid,function(data) {\r\n\t\t\tcb.apply(engine.context,[data]);\r\n\t\t});\r\n\t}\r\n\t*/\r\n}\r\n\r\nvar api={\r\n\tsearch:_search\r\n//\t,concordance:require(\"./concordance\")\r\n//\t,regex:require(\"./regex\")\r\n\t,highlightSeg:_highlightSeg\r\n\t,highlightFile:_highlightFile\r\n//\t,highlightRange:_highlightRange\r\n\t,excerpt:require(\"./excerpt\")\r\n\t//,vpos2fileseg:vpos2fileseg\r\n}\r\nmodule.exports=api;",
    "\r\nvar unpack = function (ar) { // unpack variable length integer list\r\n  var r = [],\r\n  i = 0,\r\n  v = 0;\r\n  do {\r\n\tvar shift = 0;\r\n\tdo {\r\n\t  v += ((ar[i] & 0x7F) << shift);\r\n\t  shift += 7;\r\n\t} while (ar[++i] & 0x80);\r\n\tr[r.length]=v;\r\n  } while (i < ar.length);\r\n  return r;\r\n}\r\n\r\n/*\r\n   arr:  [1,1,1,1,1,1,1,1,1]\r\n   levels: [0,1,1,2,2,0,1,2]\r\n   output: [5,1,3,1,1,3,1,1]\r\n*/\r\n\r\nvar groupsum=function(arr,levels) {\r\n  if (arr.length!=levels.length+1) return null;\r\n  var stack=[];\r\n  var output=new Array(levels.length);\r\n  for (var i=0;i<levels.length;i++) output[i]=0;\r\n  for (var i=1;i<arr.length;i++) { //first one out of toc scope, ignored\r\n    if (stack.length>levels[i-1]) {\r\n      while (stack.length>levels[i-1]) stack.pop();\r\n    }\r\n    stack.push(i-1);\r\n    for (var j=0;j<stack.length;j++) {\r\n      output[stack[j]]+=arr[i];\r\n    }\r\n  }\r\n  return output;\r\n}\r\n/* arr= 1 , 2 , 3 ,4 ,5,6,7 //token posting\r\n  posting= 3 , 5  //tag posting\r\n  out = 3 , 2, 2\r\n*/\r\nvar countbyposting = function (arr, posting) {\r\n  if (!posting.length) return [arr.length];\r\n  var out=[];\r\n  for (var i=0;i<posting.length;i++) out[i]=0;\r\n  out[posting.length]=0;\r\n  var p=0,i=0,lasti=0;\r\n  while (i<arr.length && p<posting.length) {\r\n    if (arr[i]<=posting[p]) {\r\n      while (p<posting.length && i<arr.length && arr[i]<=posting[p]) {\r\n        out[p]++;\r\n        i++;\r\n      }      \r\n    } \r\n    p++;\r\n  }\r\n  out[posting.length] = arr.length-i; //remaining\r\n  return out;\r\n}\r\n\r\nvar groupbyposting=function(arr,gposting) { //relative vpos\r\n  if (!gposting.length) return [arr.length];\r\n  var out=[];\r\n  for (var i=0;i<=gposting.length;i++) out[i]=[];\r\n  \r\n  var p=0,i=0,lasti=0;\r\n  while (i<arr.length && p<gposting.length) {\r\n    if (arr[i]<gposting[p]) {\r\n      while (p<gposting.length && i<arr.length && arr[i]<gposting[p]) {\r\n        var start=0;\r\n        if (p>0) start=gposting[p-1];\r\n        out[p].push(arr[i++]-start);  // relative\r\n      }      \r\n    } \r\n    p++;\r\n  }\r\n  //remaining\r\n  while(i<arr.length) out[out.length-1].push(arr[i++]-gposting[gposting.length-1]);\r\n  return out;\r\n}\r\nvar groupbyposting2=function(arr,gposting) { //absolute vpos\r\n  if (!arr || !arr.length) return [];\r\n  if (!gposting.length) return [arr.length];\r\n  var out=[];\r\n  for (var i=0;i<=gposting.length;i++) out[i]=[];\r\n  \r\n  var p=0,i=0,lasti=0;\r\n  while (i<arr.length && p<gposting.length) {\r\n    if (arr[i]<gposting[p]) {\r\n      while (p<gposting.length && i<arr.length && arr[i]<gposting[p]) {\r\n        var start=0;\r\n        if (p>0) start=gposting[p-1]; //absolute\r\n        out[p].push(arr[i++]);\r\n      }      \r\n    } \r\n    p++;\r\n  }\r\n  //remaining\r\n  while(i<arr.length) out[out.length-1].push(arr[i++]-gposting[gposting.length-1]);\r\n  return out;\r\n}\r\nvar groupbyblock2 = function(ar, ntoken,slotshift,opts) {\r\n  if (!ar.length) return [{},{}];\r\n  \r\n  slotshift = slotshift || 16;\r\n  var g = Math.pow(2,slotshift);\r\n  var i = 0;\r\n  var r = {}, ntokens={};\r\n  var groupcount=0;\r\n  do {\r\n    var group = Math.floor(ar[i] / g) ;\r\n    if (!r[group]) {\r\n      r[group] = [];\r\n      ntokens[group]=[];\r\n      groupcount++;\r\n    }\r\n    r[group].push(ar[i] % g);\r\n    ntokens[group].push(ntoken[i]);\r\n    i++;\r\n  } while (i < ar.length);\r\n  if (opts) opts.groupcount=groupcount;\r\n  return [r,ntokens];\r\n}\r\nvar groupbyslot = function (ar, slotshift, opts) {\r\n  if (!ar.length)\r\n\treturn {};\r\n  \r\n  slotshift = slotshift || 16;\r\n  var g = Math.pow(2,slotshift);\r\n  var i = 0;\r\n  var r = {};\r\n  var groupcount=0;\r\n  do {\r\n\tvar group = Math.floor(ar[i] / g) ;\r\n\tif (!r[group]) {\r\n\t  r[group] = [];\r\n\t  groupcount++;\r\n\t}\r\n\tr[group].push(ar[i] % g);\r\n\ti++;\r\n  } while (i < ar.length);\r\n  if (opts) opts.groupcount=groupcount;\r\n  return r;\r\n}\r\n/*\r\nvar identity = function (value) {\r\n  return value;\r\n};\r\nvar sortedIndex = function (array, obj, iterator) { //taken from underscore\r\n  iterator || (iterator = identity);\r\n  var low = 0,\r\n  high = array.length;\r\n  while (low < high) {\r\n\tvar mid = (low + high) >> 1;\r\n\titerator(array[mid]) < iterator(obj) ? low = mid + 1 : high = mid;\r\n  }\r\n  return low;\r\n};*/\r\n\r\nvar indexOfSorted = function (array, obj) { \r\n  var low = 0,\r\n  high = array.length-1;\r\n  while (low < high) {\r\n    var mid = (low + high) >> 1;\r\n    array[mid] < obj ? low = mid + 1 : high = mid;\r\n  }\r\n  return low;\r\n};\r\nvar plhead=function(pl, pltag, opts) {\r\n  opts=opts||{};\r\n  opts.max=opts.max||1;\r\n  var out=[];\r\n  if (pltag.length<pl.length) {\r\n    for (var i=0;i<pltag.length;i++) {\r\n       k = indexOfSorted(pl, pltag[i]);\r\n       if (k>-1 && k<pl.length) {\r\n        if (pl[k]==pltag[i]) {\r\n          out[out.length]=pltag[i];\r\n          if (out.length>=opts.max) break;\r\n        }\r\n      }\r\n    }\r\n  } else {\r\n    for (var i=0;i<pl.length;i++) {\r\n       k = indexOfSorted(pltag, pl[i]);\r\n       if (k>-1 && k<pltag.length) {\r\n        if (pltag[k]==pl[i]) {\r\n          out[out.length]=pltag[k];\r\n          if (out.length>=opts.max) break;\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return out;\r\n}\r\n/*\r\n pl2 occur after pl1, \r\n pl2>=pl1+mindis\r\n pl2<=pl1+maxdis\r\n*/\r\nvar plfollow2 = function (pl1, pl2, mindis, maxdis) {\r\n  var r = [],i=0;\r\n  var swap = 0;\r\n  \r\n  while (i<pl1.length){\r\n    var k = indexOfSorted(pl2, pl1[i] + mindis);\r\n    var t = (pl2[k] >= (pl1[i] +mindis) && pl2[k]<=(pl1[i]+maxdis)) ? k : -1;\r\n    if (t > -1) {\r\n      r[r.length]=pl1[i];\r\n      i++;\r\n    } else {\r\n      if (k>=pl2.length) break;\r\n      var k2=indexOfSorted (pl1,pl2[k]-maxdis);\r\n      if (k2>i) {\r\n        var t = (pl2[k] >= (pl1[i] +mindis) && pl2[k]<=(pl1[i]+maxdis)) ? k : -1;\r\n        if (t>-1) r[r.length]=pl1[k2];\r\n        i=k2;\r\n      } else break;\r\n    }\r\n  }\r\n  return r;\r\n}\r\n\r\nvar plnotfollow2 = function (pl1, pl2, mindis, maxdis) {\r\n  var r = [],i=0;\r\n  \r\n  while (i<pl1.length){\r\n    var k = indexOfSorted(pl2, pl1[i] + mindis);\r\n    var t = (pl2[k] >= (pl1[i] +mindis) && pl2[k]<=(pl1[i]+maxdis)) ? k : -1;\r\n    if (t > -1) {\r\n      i++;\r\n    } else {\r\n      if (k>=pl2.length) {\r\n        r=r.concat(pl1.slice(i));\r\n        break;\r\n      } else {\r\n        var k2=indexOfSorted (pl1,pl2[k]-maxdis);\r\n        if (k2>i) {\r\n          r=r.concat(pl1.slice(i,k2));\r\n          i=k2;\r\n        } else break;\r\n      }\r\n    }\r\n  }\r\n  return r;\r\n}\r\n/* this is incorrect */\r\nvar plfollow = function (pl1, pl2, distance) {\r\n  var r = [],i=0;\r\n\r\n  while (i<pl1.length){\r\n    var k = indexOfSorted(pl2, pl1[i] + distance);\r\n    var t = (pl2[k] === (pl1[i] + distance)) ? k : -1;\r\n    if (t > -1) {\r\n      r.push(pl1[i]);\r\n      i++;\r\n    } else {\r\n      if (k>=pl2.length) break;\r\n      var k2=indexOfSorted (pl1,pl2[k]-distance);\r\n      if (k2>i) {\r\n        t = (pl2[k] === (pl1[k2] + distance)) ? k : -1;\r\n        if (t>-1) {\r\n           r.push(pl1[k2]);\r\n           k2++;\r\n        }\r\n        i=k2;\r\n      } else break;\r\n    }\r\n  }\r\n  return r;\r\n}\r\nvar plnotfollow = function (pl1, pl2, distance) {\r\n  var r = [];\r\n  var r = [],i=0;\r\n  var swap = 0;\r\n  \r\n  while (i<pl1.length){\r\n    var k = indexOfSorted(pl2, pl1[i] + distance);\r\n    var t = (pl2[k] === (pl1[i] + distance)) ? k : -1;\r\n    if (t > -1) { \r\n      i++;\r\n    } else {\r\n      if (k>=pl2.length) {\r\n        r=r.concat(pl1.slice(i));\r\n        break;\r\n      } else {\r\n        var k2=indexOfSorted (pl1,pl2[k]-distance);\r\n        if (k2>i) {\r\n          r=r.concat(pl1.slice(i,k2));\r\n          i=k2;\r\n        } else break;\r\n      }\r\n    }\r\n  }\r\n  return r;\r\n}\r\nvar pland = function (pl1, pl2, distance) {\r\n  var r = [];\r\n  var swap = 0;\r\n  \r\n  if (pl1.length > pl2.length) { //swap for faster compare\r\n    var t = pl2;\r\n    pl2 = pl1;\r\n    pl1 = t;\r\n    swap = distance;\r\n    distance = -distance;\r\n  }\r\n  for (var i = 0; i < pl1.length; i++) {\r\n    var k = indexOfSorted(pl2, pl1[i] + distance);\r\n    var t = (pl2[k] === (pl1[i] + distance)) ? k : -1;\r\n    if (t > -1) {\r\n      r.push(pl1[i] - swap);\r\n    }\r\n  }\r\n  return r;\r\n}\r\nvar combine=function (postings) {\r\n  var out=[];\r\n  for (var i in postings) {\r\n    out=out.concat(postings[i]);\r\n  }\r\n  out.sort(function(a,b){return a-b});\r\n  return out;\r\n}\r\n\r\nvar unique = function(ar){\r\n   if (!ar || !ar.length) return [];\r\n   var u = {}, a = [];\r\n   for(var i = 0, l = ar.length; i < l; ++i){\r\n    if(u.hasOwnProperty(ar[i])) continue;\r\n    a.push(ar[i]);\r\n    u[ar[i]] = 1;\r\n   }\r\n   return a;\r\n}\r\n\r\n\r\n\r\nvar plphrase = function (postings,ops) {\r\n  var r = [];\r\n  for (var i=0;i<postings.length;i++) {\r\n  \tif (!postings[i])  return [];\r\n  \tif (0 === i) {\r\n  \t  r = postings[0];\r\n  \t} else {\r\n      if (ops[i]=='andnot') {\r\n        r = plnotfollow(r, postings[i], i);  \r\n      }else {\r\n        r = pland(r, postings[i], i);  \r\n      }\r\n  \t}\r\n  }\r\n  \r\n  return r;\r\n}\r\n//return an array of group having any of pl item\r\nvar matchPosting=function(pl,gupl,start,end) {\r\n  start=start||0;\r\n  end=end||-1;\r\n  if (end==-1) end=Math.pow(2, 53); // max integer value\r\n\r\n  var count=0, i = j= 0,  result = [] ,v=0;\r\n  var docs=[], freq=[];\r\n  if (!pl) return {docs:[],freq:[]};\r\n  while( i < pl.length && j < gupl.length ){\r\n     if (pl[i] < gupl[j] ){ \r\n       count++;\r\n       v=pl[i];\r\n       i++; \r\n     } else {\r\n       if (count) {\r\n        if (v>=start && v<end) {\r\n          docs.push(j);\r\n          freq.push(count);          \r\n        }\r\n       }\r\n       j++;\r\n       count=0;\r\n     }\r\n  }\r\n  if (count && j<gupl.length && v>=start && v<end) {\r\n    docs.push(j);\r\n    freq.push(count);\r\n    count=0;\r\n  }\r\n  else {\r\n    while (j==gupl.length && i<pl.length && pl[i] >= gupl[gupl.length-1]) {\r\n      i++;\r\n      count++;\r\n    }\r\n    if (v>=start && v<end) {\r\n      docs.push(j);\r\n      freq.push(count);      \r\n    }\r\n  } \r\n  return {docs:docs,freq:freq};\r\n}\r\n\r\nvar trim=function(arr,start,end) {\r\n  var s=indexOfSorted(arr,start);\r\n  var e=indexOfSorted(arr,end);\r\n  return arr.slice(s,e+1);\r\n}\r\nvar plist={};\r\nplist.unpack=unpack;\r\nplist.plphrase=plphrase;\r\nplist.plhead=plhead;\r\nplist.plfollow2=plfollow2;\r\nplist.plnotfollow2=plnotfollow2;\r\nplist.plfollow=plfollow;\r\nplist.plnotfollow=plnotfollow;\r\nplist.unique=unique;\r\nplist.indexOfSorted=indexOfSorted;\r\nplist.matchPosting=matchPosting;\r\nplist.trim=trim;\r\n\r\nplist.groupbyslot=groupbyslot;\r\nplist.groupbyblock2=groupbyblock2;\r\nplist.countbyposting=countbyposting;\r\nplist.groupbyposting=groupbyposting;\r\nplist.groupbyposting2=groupbyposting2;\r\nplist.groupsum=groupsum;\r\nplist.combine=combine;\r\nmodule.exports=plist;",
    "/*\r\nvar dosearch2=function(engine,opts,cb,context) {\r\n\topts\r\n\t\tnfile,npage  //return a highlighted page\r\n\t\tnfile,[pages] //return highlighted pages \r\n\t\tnfile        //return entire highlighted file\r\n\t\tabs_npage\r\n\t\t[abs_pages]  //return set of highlighted pages (may cross file)\r\n\r\n\t\tfilename, pagename\r\n\t\tfilename,[pagenames]\r\n\r\n\t\texcerpt      //\r\n\t    sortBy       //default natural, sortby by vsm ranking\r\n\r\n\t//return err,array_of_string ,Q  (Q contains low level search result)\r\n}\r\n\r\n*/\r\n/* TODO sorted tokens */\r\nvar plist=require(\"./plist\");\r\nvar boolsearch=require(\"./boolsearch\");\r\nvar excerpt=require(\"./excerpt\");\r\nvar parseTerm = function(engine,raw,opts) {\r\n\tif (!raw) return;\r\n\tvar res={raw:raw,variants:[],term:'',op:''};\r\n\tvar term=raw, op=0;\r\n\tvar firstchar=term[0];\r\n\tvar termregex=\"\";\r\n\tif (firstchar=='-') {\r\n\t\tterm=term.substring(1);\r\n\t\tfirstchar=term[0];\r\n\t\tres.exclude=true; //exclude\r\n\t}\r\n\tterm=term.trim();\r\n\tvar lastchar=term[term.length-1];\r\n\tterm=engine.analyzer.normalize(term);\r\n\t\r\n\tif (term.indexOf(\"%\")>-1) {\r\n\t\tvar termregex=\"^\"+term.replace(/%+/g,\".+\")+\"$\";\r\n\t\tif (firstchar==\"%\") \ttermregex=\".+\"+termregex.substr(1);\r\n\t\tif (lastchar==\"%\") \ttermregex=termregex.substr(0,termregex.length-1)+\".+\";\r\n\t}\r\n\r\n\tif (termregex) {\r\n\t\tres.variants=expandTerm(engine,termregex);\r\n\t}\r\n\r\n\tres.key=term;\r\n\treturn res;\r\n}\r\nvar expandTerm=function(engine,regex) {\r\n\tvar r=new RegExp(regex);\r\n\tvar tokens=engine.get(\"tokens\");\r\n\tvar postingsLength=engine.get(\"postingslength\");\r\n\tif (!postingsLength) postingsLength=[];\r\n\tvar out=[];\r\n\tfor (var i=0;i<tokens.length;i++) {\r\n\t\tvar m=tokens[i].match(r);\r\n\t\tif (m) {\r\n\t\t\tout.push([m[0],postingsLength[i]||1]);\r\n\t\t}\r\n\t}\r\n\tout.sort(function(a,b){return b[1]-a[1]});\r\n\treturn out;\r\n}\r\nvar isWildcard=function(raw) {\r\n\treturn !!raw.match(/[\\*\\?]/);\r\n}\r\n\r\nvar isOrTerm=function(term) {\r\n\tterm=term.trim();\r\n\treturn (term[term.length-1]===',');\r\n}\r\nvar orterm=function(engine,term,key) {\r\n\t\tvar t={text:key};\r\n\t\tif (engine.analyzer.simplifiedToken) {\r\n\t\t\tt.simplified=engine.analyzer.simplifiedToken(key);\r\n\t\t}\r\n\t\tterm.variants.push(t);\r\n}\r\nvar orTerms=function(engine,tokens,now) {\r\n\tvar raw=tokens[now];\r\n\tvar term=parseTerm(engine,raw);\r\n\tif (!term) return;\r\n\torterm(engine,term,term.key);\r\n\twhile (isOrTerm(raw))  {\r\n\t\traw=tokens[++now];\r\n\t\tvar term2=parseTerm(engine,raw);\r\n\t\torterm(engine,term,term2.key);\r\n\t\tfor (var i in term2.variants){\r\n\t\t\tterm.variants[i]=term2.variants[i];\r\n\t\t}\r\n\t\tterm.key+=','+term2.key;\r\n\t}\r\n\treturn term;\r\n}\r\n\r\nvar getOperator=function(raw) {\r\n\tvar op='';\r\n\tif (raw[0]=='+') op='include';\r\n\tif (raw[0]=='-') op='exclude';\r\n\treturn op;\r\n}\r\nvar parsePhrase=function(q) {\r\n\tvar match=q.match(/(\".+?\"|'.+?'|\\S+)/g)\r\n\tmatch=match.map(function(str){\r\n\t\tvar n=str.length, h=str.charAt(0), t=str.charAt(n-1)\r\n\t\tif (h===t&&(h==='\"'|h===\"'\")) str=str.substr(1,n-2)\r\n\t\treturn str;\r\n\t})\r\n\treturn match;\r\n}\r\nvar tibetanNumber={\r\n\t\"\\u0f20\":\"0\",\"\\u0f21\":\"1\",\"\\u0f22\":\"2\",\t\"\\u0f23\":\"3\",\t\"\\u0f24\":\"4\",\r\n\t\"\\u0f25\":\"5\",\"\\u0f26\":\"6\",\"\\u0f27\":\"7\",\"\\u0f28\":\"8\",\"\\u0f29\":\"9\"\r\n}\r\nvar parseNumber=function(raw) {\r\n\tvar n=parseInt(raw,10);\r\n\tif (isNaN(n)){\r\n\t\tvar converted=[];\r\n\t\tfor (var i=0;i<raw.length;i++) {\r\n\t\t\tvar nn=tibetanNumber[raw[i]];\r\n\t\t\tif (typeof nn !=\"undefined\") converted[i]=nn;\r\n\t\t\telse break;\r\n\t\t}\r\n\t\treturn parseInt(converted,10);\r\n\t} else {\r\n\t\treturn n;\r\n\t}\r\n}\r\nvar parseWildcard=function(raw) {\r\n\tvar n=parseNumber(raw) || 1;\r\n\tvar qcount=raw.split('?').length-1;\r\n\tvar scount=raw.split('*').length-1;\r\n\tvar type='';\r\n\tif (qcount) type='?';\r\n\telse if (scount) type='*';\r\n\treturn {wildcard:type, width: n , op:'wildcard'};\r\n}\r\n\r\nvar newPhrase=function() {\r\n\treturn {termid:[],posting:[],raw:'',termlength:[]};\r\n} \r\nvar parseQuery=function(q,sep) {\r\n\tif (sep && q.indexOf(sep)>-1) {\r\n\t\tvar match=q.split(sep);\r\n\t} else {\r\n\t\tvar match=q.match(/(\".+?\"|'.+?'|\\S+)/g)\r\n\t\tmatch=match.map(function(str){\r\n\t\t\tvar n=str.length, h=str.charAt(0), t=str.charAt(n-1)\r\n\t\t\tif (h===t&&(h==='\"'|h===\"'\")) str=str.substr(1,n-2)\r\n\t\t\treturn str\r\n\t\t})\r\n\t\t//console.log(input,'==>',match)\t\t\r\n\t}\r\n\treturn match;\r\n}\r\nvar loadPhrase=function(phrase) {\r\n\t/* remove leading and ending wildcard */\r\n\tvar Q=this;\r\n\tvar cache=Q.engine.postingCache;\r\n\tif (cache[phrase.key]) {\r\n\t\tphrase.posting=cache[phrase.key];\r\n\t\treturn Q;\r\n\t}\r\n\tif (phrase.termid.length==1) {\r\n\t\tif (!Q.terms.length){\r\n\t\t\tphrase.posting=[];\r\n\t\t} else {\r\n\t\t\tcache[phrase.key]=phrase.posting=Q.terms[phrase.termid[0]].posting;\t\r\n\t\t}\r\n\t\treturn Q;\r\n\t}\r\n\r\n\tvar i=0, r=[],dis=0;\r\n\twhile(i<phrase.termid.length) {\r\n\t  var T=Q.terms[phrase.termid[i]];\r\n\t\tif (0 === i) {\r\n\t\t\tr = T.posting;\r\n\t\t} else {\r\n\t\t    if (T.op=='wildcard') {\r\n\t\t    \tT=Q.terms[phrase.termid[i++]];\r\n\t\t    \tvar width=T.width;\r\n\t\t    \tvar wildcard=T.wildcard;\r\n\t\t    \tT=Q.terms[phrase.termid[i]];\r\n\t\t    \tvar mindis=dis;\r\n\t\t    \tif (wildcard=='?') mindis=dis+width;\r\n\t\t    \tif (T.exclude) r = plist.plnotfollow2(r, T.posting, mindis, dis+width);\r\n\t\t    \telse r = plist.plfollow2(r, T.posting, mindis, dis+width);\t\t    \t\r\n\t\t    \tdis+=(width-1);\r\n\t\t    }else {\r\n\t\t    \tif (T.posting) {\r\n\t\t    \t\tif (T.exclude) r = plist.plnotfollow(r, T.posting, dis);\r\n\t\t    \t\telse r = plist.plfollow(r, T.posting, dis);\r\n\t\t    \t}\r\n\t\t    }\r\n\t\t}\r\n\t\tdis += phrase.termlength[i];\r\n\t\ti++;\r\n\t\tif (!r) return Q;\r\n  }\r\n  phrase.posting=r;\r\n  cache[phrase.key]=r;\r\n  return Q;\r\n}\r\nvar trimSpace=function(engine,query) {\r\n\tif (!query) return \"\";\r\n\tvar i=0;\r\n\tvar isSkip=engine.analyzer.isSkip;\r\n\twhile (i<query.length && isSkip(query[i])) i++;\r\n\treturn query.substring(i);\r\n}\r\nvar getSegWithHit=function(fileid,offsets) {\r\n\tvar Q=this,engine=Q.engine;\r\n\tvar segWithHit=plist.groupbyposting2(Q.byFile[fileid ], offsets);\r\n\tif (segWithHit.length) segWithHit.shift(); //the first item is not used (0~Q.byFile[0] )\r\n\tvar out=[];\r\n\tsegWithHit.map(function(p,idx){if (p.length) out.push(idx)});\r\n\treturn out;\r\n}\r\nvar segWithHit=function(fileid) {\r\n\tvar Q=this,engine=Q.engine;\r\n\tvar offsets=engine.getFileSegOffsets(fileid);\r\n\treturn getSegWithHit.apply(this,[fileid,offsets]);\r\n}\r\nvar isSimplePhrase=function(phrase) {\r\n\tvar m=phrase.match(/[\\?%^]/);\r\n\treturn !m;\r\n}\r\n\r\n// 發菩提心   ==> 發菩  提心       2 2   \r\n// 菩提心     ==> 菩提  提心       1 2\r\n// 劫劫       ==> 劫    劫         1 1   // invalid\r\n// 因緣所生道  ==> 因緣  所生   道   2 2 1\r\nvar splitPhrase=function(engine,simplephrase,bigram) {\r\n\tvar bigram=bigram||engine.get(\"meta\").bigram||[];\r\n\tvar tokens=engine.analyzer.tokenize(simplephrase).tokens;\r\n\tvar loadtokens=[],lengths=[],j=0,lastbigrampos=-1;\r\n\twhile (j+1<tokens.length) {\r\n\t\tvar token=engine.analyzer.normalize(tokens[j]);\r\n\t\tvar nexttoken=engine.analyzer.normalize(tokens[j+1]);\r\n\t\tvar bi=token+nexttoken;\r\n\t\tvar i=plist.indexOfSorted(bigram,bi);\r\n\t\tif (bigram[i]==bi) {\r\n\t\t\tloadtokens.push(bi);\r\n\t\t\tif (j+3<tokens.length) {\r\n\t\t\t\tlastbigrampos=j;\r\n\t\t\t\tj++;\r\n\t\t\t} else {\r\n\t\t\t\tif (j+2==tokens.length){ \r\n\t\t\t\t\tif (lastbigrampos+1==j ) {\r\n\t\t\t\t\t\tlengths[lengths.length-1]--;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlastbigrampos=j;\r\n\t\t\t\t\tj++;\r\n\t\t\t\t}else {\r\n\t\t\t\t\tlastbigrampos=j;\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlengths.push(2);\r\n\t\t} else {\r\n\t\t\tif (!bigram || lastbigrampos==-1 || lastbigrampos+1!=j) {\r\n\t\t\t\tloadtokens.push(token);\r\n\t\t\t\tlengths.push(1);\t\t\t\t\r\n\t\t\t}\r\n\t\t}\r\n\t\tj++;\r\n\t}\r\n\r\n\twhile (j<tokens.length) {\r\n\t\tvar token=engine.analyzer.normalize(tokens[j]);\r\n\t\tloadtokens.push(token);\r\n\t\tlengths.push(1);\r\n\t\tj++;\r\n\t}\r\n\r\n\treturn {tokens:loadtokens, lengths: lengths , tokenlength: tokens.length};\r\n}\r\n/* host has fast native function */\r\nvar fastPhrase=function(engine,phrase) {\r\n\tvar phrase_term=newPhrase();\r\n\t//var tokens=engine.analyzer.tokenize(phrase).tokens;\r\n\tvar splitted=splitPhrase(engine,phrase);\r\n\r\n\tvar paths=postingPathFromTokens(engine,splitted.tokens);\r\n//create wildcard\r\n\r\n\tphrase_term.width=splitted.tokenlength; //for excerpt.js to getPhraseWidth\r\n\r\n\tengine.get(paths,{address:true},function(postingAddress){ //this is sync\r\n\t\tphrase_term.key=phrase;\r\n\t\tvar postingAddressWithWildcard=[];\r\n\t\tfor (var i=0;i<postingAddress.length;i++) {\r\n\t\t\tpostingAddressWithWildcard.push(postingAddress[i]);\r\n\t\t\tif (splitted.lengths[i]>1) {\r\n\t\t\t\tpostingAddressWithWildcard.push([splitted.lengths[i],0]); //wildcard has blocksize==0 \r\n\t\t\t}\r\n\t\t}\r\n\t\tengine.postingCache[phrase]=engine.mergePostings(postingAddressWithWildcard);\r\n\t});\r\n\treturn phrase_term;\r\n\t// put posting into cache[phrase.key]\r\n}\r\nvar slowPhrase=function(engine,terms,phrase) {\r\n\tvar j=0,tokens=engine.analyzer.tokenize(phrase).tokens;\r\n\tvar phrase_term=newPhrase();\r\n\tvar termid=0;\r\n\twhile (j<tokens.length) {\r\n\t\tvar raw=tokens[j], termlength=1;\r\n\t\tif (isWildcard(raw)) {\r\n\t\t\tif (phrase_term.termid.length==0)  { //skip leading wild card\r\n\t\t\t\tj++\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tterms.push(parseWildcard(raw));\r\n\t\t\ttermid=terms.length-1;\r\n\t\t\tphrase_term.termid.push(termid);\r\n\t\t\tphrase_term.termlength.push(termlength);\r\n\t\t} else if (isOrTerm(raw)){\r\n\t\t\tvar term=orTerms.apply(this,[tokens,j]);\r\n\t\t\tif (term) {\r\n\t\t\t\tterms.push(term);\r\n\t\t\t\ttermid=terms.length-1;\r\n\t\t\t\tj+=term.key.split(',').length-1;\t\t\t\t\t\r\n\t\t\t}\r\n\t\t\tj++;\r\n\t\t\tphrase_term.termid.push(termid);\r\n\t\t\tphrase_term.termlength.push(termlength);\r\n\t\t} else {\r\n\t\t\tvar phrase=\"\";\r\n\t\t\twhile (j<tokens.length) {\r\n\t\t\t\tif (!(isWildcard(tokens[j]) || isOrTerm(tokens[j]))) {\r\n\t\t\t\t\tphrase+=tokens[j];\r\n\t\t\t\t\tj++;\r\n\t\t\t\t} else break;\r\n\t\t\t}\r\n\r\n\t\t\tvar splitted=splitPhrase(engine,phrase);\r\n\t\t\tfor (var i=0;i<splitted.tokens.length;i++) {\r\n\t\t\t\tvar term=parseTerm(engine,splitted.tokens[i]);\r\n\t\t\t\tif (!term) continue;\r\n\t\t\t\tvar termidx=terms.map(function(a){return a.key}).indexOf(term.key);\r\n\t\t\t\tif (termidx==-1) {\r\n\t\t\t\t\tterms.push(term);\r\n\t\t\t\t\ttermid=terms.length-1;\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttermid=termidx;\r\n\t\t\t\t}\t\t\t\t\r\n\t\t\t\tphrase_term.termid.push(termid);\r\n\t\t\t\tphrase_term.termlength.push(splitted.lengths[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t\tj++;\r\n\t}\r\n\tphrase_term.key=phrase;\r\n\t//remove ending wildcard\r\n\tvar P=phrase_term , T=null;\r\n\tdo {\r\n\t\tT=terms[P.termid[P.termid.length-1]];\r\n\t\tif (!T) break;\r\n\t\tif (T.wildcard) P.termid.pop(); else break;\r\n\t} while(T);\t\t\r\n\treturn phrase_term;\r\n}\r\nvar newQuery =function(engine,query,opts) {\r\n\t//if (!query) return;\r\n\topts=opts||{};\r\n\tquery=trimSpace(engine,query);\r\n\r\n\tvar phrases=query,phrases=[];\r\n\tif (typeof query=='string' && query) {\r\n\t\tphrases=parseQuery(query,opts.phrase_sep || \"\");\r\n\t}\r\n\t\r\n\tvar phrase_terms=[], terms=[],variants=[],operators=[];\r\n\tvar pc=0;//phrase count\r\n\tfor  (var i=0;i<phrases.length;i++) {\r\n\t\tvar op=getOperator(phrases[pc]);\r\n\t\tif (op) phrases[pc]=phrases[pc].substring(1);\r\n\r\n\t\t/* auto add + for natural order ?*/\r\n\t\t//if (!opts.rank && op!='exclude' &&i) op='include';\r\n\t\toperators.push(op);\r\n\r\n\t\tif (isSimplePhrase(phrases[pc]) && engine.mergePostings ) {\r\n\t\t\tvar phrase_term=fastPhrase(engine,phrases[pc]);\r\n\t\t} else {\r\n\t\t\tvar phrase_term=slowPhrase(engine,terms,phrases[pc]);\r\n\t\t}\r\n\t\tphrase_terms.push(phrase_term);\r\n\r\n\t\tif (!engine.mergePostings && phrase_terms[pc].termid.length==0) {\r\n\t\t\tphrase_terms.pop();\r\n\t\t} else pc++;\r\n\t}\r\n\topts.op=operators;\r\n\r\n\tvar Q={dbname:engine.dbname,engine:engine,opts:opts,query:query,\r\n\t\tphrases:phrase_terms,terms:terms\r\n\t};\r\n\tQ.tokenize=function() {return engine.analyzer.tokenize.apply(engine,arguments);}\r\n\tQ.isSkip=function() {return engine.analyzer.isSkip.apply(engine,arguments);}\r\n\tQ.normalize=function() {return engine.analyzer.normalize.apply(engine,arguments);}\r\n\tQ.segWithHit=segWithHit;\r\n\r\n\t//Q.getRange=function() {return that.getRange.apply(that,arguments)};\r\n\t//API.queryid='Q'+(Math.floor(Math.random()*10000000)).toString(16);\r\n\treturn Q;\r\n}\r\nvar postingPathFromTokens=function(engine,tokens) {\r\n\tvar alltokens=engine.get(\"tokens\");\r\n\r\n\tvar tokenIds=tokens.map(function(t){ return 1+alltokens.indexOf(t)});\r\n\tvar postingid=[];\r\n\tfor (var i=0;i<tokenIds.length;i++) {\r\n\t\tpostingid.push( tokenIds[i]); // tokenId==0 , empty token\r\n\t}\r\n\treturn postingid.map(function(t){return [\"postings\",t]});\r\n}\r\nvar loadPostings=function(engine,tokens,cb) {\r\n\tvar toloadtokens=tokens.filter(function(t){\r\n\t\treturn !engine.postingCache[t.key]; //already in cache\r\n\t});\r\n\tif (toloadtokens.length==0) {\r\n\t\tcb();\r\n\t\treturn;\r\n\t}\r\n\tvar postingPaths=postingPathFromTokens(engine,tokens.map(function(t){return t.key}));\r\n\tengine.get(postingPaths,function(postings){\r\n\t\tpostings.map(function(p,i) { tokens[i].posting=p });\r\n\t\tif (cb) cb();\r\n\t});\r\n}\r\nvar groupBy=function(Q,posting) {\r\n\tphrases.forEach(function(P){\r\n\t\tvar key=P.key;\r\n\t\tvar docfreq=docfreqcache[key];\r\n\t\tif (!docfreq) docfreq=docfreqcache[key]={};\r\n\t\tif (!docfreq[that.groupunit]) {\r\n\t\t\tdocfreq[that.groupunit]={doclist:null,freq:null};\r\n\t\t}\t\t\r\n\t\tif (P.posting) {\r\n\t\t\tvar res=matchPosting(engine,P.posting);\r\n\t\t\tP.freq=res.freq;\r\n\t\t\tP.docs=res.docs;\r\n\t\t} else {\r\n\t\t\tP.docs=[];\r\n\t\t\tP.freq=[];\r\n\t\t}\r\n\t\tdocfreq[that.groupunit]={doclist:P.docs,freq:P.freq};\r\n\t});\r\n\treturn this;\r\n}\r\nvar groupByFolder=function(engine,filehits) {\r\n\tvar files=engine.get(\"filenames\");\r\n\tvar prevfolder=\"\",hits=0,out=[];\r\n\tfor (var i=0;i<filehits.length;i++) {\r\n\t\tvar fn=files[i];\r\n\t\tvar folder=fn.substring(0,fn.indexOf('/'));\r\n\t\tif (prevfolder && prevfolder!=folder) {\r\n\t\t\tout.push(hits);\r\n\t\t\thits=0;\r\n\t\t}\r\n\t\thits+=filehits[i].length;\r\n\t\tprevfolder=folder;\r\n\t}\r\n\tout.push(hits);\r\n\treturn out;\r\n}\r\nvar phrase_intersect=function(engine,Q) {\r\n\tvar intersected=null;\r\n\tvar fileoffsets=Q.engine.get(\"fileoffsets\");\r\n\tvar empty=[],emptycount=0,hashit=0;\r\n\tfor (var i=0;i<Q.phrases.length;i++) {\r\n\t\tvar byfile=plist.groupbyposting2(Q.phrases[i].posting,fileoffsets);\r\n\t\tif (byfile.length) byfile.shift();\r\n\t\tif (byfile.length) byfile.pop();\r\n\t\tbyfile.pop();\r\n\t\tif (intersected==null) {\r\n\t\t\tintersected=byfile;\r\n\t\t} else {\r\n\t\t\tfor (var j=0;j<byfile.length;j++) {\r\n\t\t\t\tif (!(byfile[j].length && intersected[j] && intersected[j].length)) {\r\n\t\t\t\t\tintersected[j]=empty; //reuse empty array\r\n\t\t\t\t\temptycount++;\r\n\t\t\t\t} else hashit++;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tQ.byFile=intersected;\r\n\tQ.byFolder=groupByFolder(engine,Q.byFile);\r\n\tvar out=[];\r\n\t//calculate new rawposting\r\n\tfor (var i=0;i<Q.byFile.length;i++) {\r\n\t\tif (Q.byFile[i].length) out=out.concat(Q.byFile[i]);\r\n\t}\r\n\tQ.rawresult=out;\r\n\tcountFolderFile(Q);\r\n}\r\nvar countFolderFile=function(Q) {\r\n\tQ.fileWithHitCount=0;\r\n\tQ.byFile.map(function(f){if (f.length) Q.fileWithHitCount++});\r\n\t\t\t\r\n\tQ.folderWithHitCount=0;\r\n\tQ.byFolder.map(function(f){if (f) Q.folderWithHitCount++});\r\n}\r\n\r\nvar main=function(engine,q,opts,cb){\r\n\r\n\tvar starttime=new Date();\r\n\tvar meta=engine.get(\"meta\");\r\n\tif (meta.normalize && engine.analyzer.setNormalizeTable) {\r\n\t\tmeta.normalizeObj=engine.analyzer.setNormalizeTable(meta.normalize,meta.normalizeObj);\r\n\t}\r\n\tif (typeof opts==\"function\") cb=opts;\r\n\topts=opts||{};\r\n\tvar Q=engine.queryCache[q];\r\n\tif (!Q) Q=newQuery(engine,q,opts); \r\n\tif (!Q) {\r\n\t\tengine.searchtime=new Date()-starttime;\r\n\t\tengine.totaltime=engine.searchtime;\r\n\t\tif (engine.context) cb.apply(engine.context,[\"empty result\",{rawresult:[]}]);\r\n\t\telse cb(\"empty result\",{rawresult:[]});\r\n\t\treturn;\r\n\t};\r\n\tengine.queryCache[q]=Q;\r\n\tif (Q.phrases.length) {\r\n\t\t\r\n\t\tloadPostings(engine,Q.terms,function(){\r\n\t\t\tif (!Q.phrases[0].posting) {\r\n\t\t\t\tengine.searchtime=new Date()-starttime;\r\n\t\t\t\tengine.totaltime=engine.searchtime;\r\n\t\t\t\tcb.apply(engine.context,[\"no such posting\",{rawresult:[]}]);\r\n\t\t\t\treturn;\t\t\t\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (!Q.phrases[0].posting.length) { //\r\n\t\t\t\tQ.phrases.forEach(loadPhrase.bind(Q));\r\n\t\t\t}\r\n\t\t\tif (Q.phrases.length==1) {\r\n\t\t\t\tQ.rawresult=Q.phrases[0].posting;\r\n\t\t\t} else {\r\n\t\t\t\tphrase_intersect(engine,Q);\r\n\t\t\t}\r\n\t\t\tvar fileoffsets=Q.engine.get(\"fileoffsets\");\r\n\t\t\t//console.log(\"search opts \"+JSON.stringify(opts));\r\n\r\n\t\t\tif (!Q.byFile && Q.rawresult && !opts.nogroup) {\r\n\t\t\t\tQ.byFile=plist.groupbyposting2(Q.rawresult, fileoffsets);\r\n\t\t\t\tQ.byFile.shift();Q.byFile.pop();\r\n\t\t\t\tQ.byFolder=groupByFolder(engine,Q.byFile);\r\n\r\n\t\t\t\tcountFolderFile(Q);\r\n\t\t\t}\r\n\r\n\t\t\tif (opts.range) {\r\n\t\t\t\tengine.searchtime=new Date()-starttime;\r\n\t\t\t\texcerpt.resultlist(engine,Q,opts,function(data) { \r\n\t\t\t\t\t//console.log(\"excerpt ok\");\r\n\t\t\t\t\tQ.excerpt=data;\r\n\t\t\t\t\tengine.totaltime=new Date()-starttime;\r\n\t\t\t\t\tcb.apply(engine.context,[0,Q]);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tengine.searchtime=new Date()-starttime;\r\n\t\t\t\tengine.totaltime=new Date()-starttime;\r\n\t\t\t\tcb.apply(engine.context,[0,Q]);\r\n\t\t\t}\r\n\t\t});\r\n\t} else { //empty search\r\n\t\tengine.searchtime=new Date()-starttime;\r\n\t\tengine.totaltime=new Date()-starttime;\r\n\t\tcb.apply(engine.context,[0,Q]);\r\n\t};\r\n}\r\n\r\nmain.splitPhrase=splitPhrase; //just for debug\r\nmodule.exports=main;",
    "/*\r\nconvert to pure js\r\nsave -g reactify\r\n*/\r\nvar React=(window&&window.React)||require(\"react\");\r\nvar E=React.createElement;\r\n\r\nvar hasksanagap=(typeof ksanagap!=\"undefined\");\r\nif (hasksanagap && (typeof console==\"undefined\" || typeof console.log==\"undefined\")) {\r\n\t\twindow.console={log:ksanagap.log,error:ksanagap.error,debug:ksanagap.debug,warn:ksanagap.warn};\r\n\t\tconsole.log(\"install console output funciton\");\r\n}\r\n\r\nvar checkfs=function() {\r\n\treturn (navigator && navigator.webkitPersistentStorage) || hasksanagap;\r\n}\r\nvar featurechecks={\r\n\t\"fs\":checkfs\r\n}\r\nvar checkbrowser = React.createClass({\r\n\tgetInitialState:function() {\r\n\r\n\t\tvar missingFeatures=this.getMissingFeatures();\r\n\t\treturn {ready:false, missing:missingFeatures};\r\n\t},\r\n\tgetMissingFeatures:function() {\r\n\t\tvar feature=this.props.feature.split(\",\");\r\n\t\tvar status=[];\r\n\t\tfeature.map(function(f){\r\n\t\t\tvar checker=featurechecks[f];\r\n\t\t\tif (checker) checker=checker();\r\n\t\t\tstatus.push([f,checker]);\r\n\t\t});\r\n\t\treturn status.filter(function(f){return !f[1]});\r\n\t},\r\n\tdownloadbrowser:function() {\r\n\t\twindow.location=\"https://www.google.com/chrome/\"\r\n\t},\r\n\trenderMissing:function() {\r\n\t\tvar showMissing=function(m) {\r\n\t\t\treturn E(\"div\", null, m);\r\n\t\t}\r\n\t\treturn (\r\n\t\t E(\"div\", {ref: \"dialog1\", className: \"modal fade\", \"data-backdrop\": \"static\"}, \r\n\t\t    E(\"div\", {className: \"modal-dialog\"}, \r\n\t\t      E(\"div\", {className: \"modal-content\"}, \r\n\t\t        E(\"div\", {className: \"modal-header\"}, \r\n\t\t          E(\"button\", {type: \"button\", className: \"close\", \"data-dismiss\": \"modal\", \"aria-hidden\": \"true\"}, \"×\"), \r\n\t\t          E(\"h4\", {className: \"modal-title\"}, \"Browser Check\")\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-body\"}, \r\n\t\t          E(\"p\", null, \"Sorry but the following feature is missing\"), \r\n\t\t          this.state.missing.map(showMissing)\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-footer\"}, \r\n\t\t          E(\"button\", {onClick: this.downloadbrowser, type: \"button\", className: \"btn btn-primary\"}, \"Download Google Chrome\")\r\n\t\t        )\r\n\t\t      )\r\n\t\t    )\r\n\t\t  )\r\n\t\t );\r\n\t},\r\n\trenderReady:function() {\r\n\t\treturn E(\"span\", null, \"browser ok\")\r\n\t},\r\n\trender:function(){\r\n\t\treturn  (this.state.missing.length)?this.renderMissing():this.renderReady();\r\n\t},\r\n\tcomponentDidMount:function() {\r\n\t\tif (!this.state.missing.length) {\r\n\t\t\tthis.props.onReady();\r\n\t\t} else {\r\n\t\t\t$(this.refs.dialog1.getDOMNode()).modal('show');\r\n\t\t}\r\n\t}\r\n});\r\n\r\nmodule.exports=checkbrowser;",
    "\r\nvar userCancel=false;\r\nvar files=[];\r\nvar totalDownloadByte=0;\r\nvar targetPath=\"\";\r\nvar tempPath=\"\";\r\nvar nfile=0;\r\nvar baseurl=\"\";\r\nvar result=\"\";\r\nvar downloading=false;\r\nvar startDownload=function(dbid,_baseurl,_files) { //return download id\r\n\tvar fs     = require(\"fs\");\r\n\tvar path   = require(\"path\");\r\n\r\n\t\r\n\tfiles=_files.split(\"\\uffff\");\r\n\tif (downloading) return false; //only one session\r\n\tuserCancel=false;\r\n\ttotalDownloadByte=0;\r\n\tnextFile();\r\n\tdownloading=true;\r\n\tbaseurl=_baseurl;\r\n\tif (baseurl[baseurl.length-1]!='/')baseurl+='/';\r\n\ttargetPath=ksanagap.rootPath+dbid+'/';\r\n\ttempPath=ksanagap.rootPath+\".tmp/\";\r\n\tresult=\"\";\r\n\treturn true;\r\n}\r\n\r\nvar nextFile=function() {\r\n\tsetTimeout(function(){\r\n\t\tif (nfile==files.length) {\r\n\t\t\tnfile++;\r\n\t\t\tendDownload();\r\n\t\t} else {\r\n\t\t\tdownloadFile(nfile++);\t\r\n\t\t}\r\n\t},100);\r\n}\r\n\r\nvar downloadFile=function(nfile) {\r\n\tvar url=baseurl+files[nfile];\r\n\tvar tmpfilename=tempPath+files[nfile];\r\n\tvar mkdirp = require(\"./mkdirp\");\r\n\tvar fs     = require(\"fs\");\r\n\tvar http   = require(\"http\");\r\n\r\n\tmkdirp.sync(path.dirname(tmpfilename));\r\n\tvar writeStream = fs.createWriteStream(tmpfilename);\r\n\tvar datalength=0;\r\n\tvar request = http.get(url, function(response) {\r\n\t\tresponse.on('data',function(chunk){\r\n\t\t\twriteStream.write(chunk);\r\n\t\t\ttotalDownloadByte+=chunk.length;\r\n\t\t\tif (userCancel) {\r\n\t\t\t\twriteStream.end();\r\n\t\t\t\tsetTimeout(function(){nextFile();},100);\r\n\t\t\t}\r\n\t\t});\r\n\t\tresponse.on(\"end\",function() {\r\n\t\t\twriteStream.end();\r\n\t\t\tsetTimeout(function(){nextFile();},100);\r\n\t\t});\r\n\t});\r\n}\r\n\r\nvar cancelDownload=function() {\r\n\tuserCancel=true;\r\n\tendDownload();\r\n}\r\nvar verify=function() {\r\n\treturn true;\r\n}\r\nvar endDownload=function() {\r\n\tnfile=files.length+1;//stop\r\n\tresult=\"cancelled\";\r\n\tdownloading=false;\r\n\tif (userCancel) return;\r\n\tvar fs     = require(\"fs\");\r\n\tvar mkdirp = require(\"./mkdirp\");\r\n\r\n\tfor (var i=0;i<files.length;i++) {\r\n\t\tvar targetfilename=targetPath+files[i];\r\n\t\tvar tmpfilename   =tempPath+files[i];\r\n\t\tmkdirp.sync(path.dirname(targetfilename));\r\n\t\tfs.renameSync(tmpfilename,targetfilename);\r\n\t}\r\n\tif (verify()) {\r\n\t\tresult=\"success\";\r\n\t} else {\r\n\t\tresult=\"error\";\r\n\t}\r\n}\r\n\r\nvar downloadedByte=function() {\r\n\treturn totalDownloadByte;\r\n}\r\nvar doneDownload=function() {\r\n\tif (nfile>files.length) return result;\r\n\telse return \"\";\r\n}\r\nvar downloadingFile=function() {\r\n\treturn nfile-1;\r\n}\r\n\r\nvar downloader={startDownload:startDownload, downloadedByte:downloadedByte,\r\n\tdownloadingFile:downloadingFile, cancelDownload:cancelDownload,doneDownload:doneDownload};\r\nmodule.exports=downloader;",
    "/* todo , optional kdb */\r\nvar React=(window&&window.React)||require(\"react\");\r\nvar HtmlFS=require(\"./htmlfs\");\r\nvar html5fs=require(\"./html5fs\");\r\nvar CheckBrowser=require(\"./checkbrowser\");\r\nvar E=React.createElement;\r\n  \r\n\r\nvar FileList = React.createClass({\r\n\tgetInitialState:function() {\r\n\t\treturn {downloading:false,progress:0};\r\n\t},\r\n\tupdatable:function(f) {\r\n        var classes=\"btn btn-warning\";\r\n        if (this.state.downloading) classes+=\" disabled\";\r\n\t\tif (f.hasUpdate) return   E(\"button\", {className: classes, \r\n\t\t\t\"data-filename\": f.filename, \"data-url\": f.url, \r\n\t            onClick: this.download\r\n\t       }, \"Update\")\r\n\t\telse return null;\r\n\t},\r\n\tshowLocal:function(f) {\r\n        var classes=\"btn btn-danger\";\r\n        if (this.state.downloading) classes+=\" disabled\";\r\n\t  return E(\"tr\", null, E(\"td\", null, f.filename), \r\n\t      E(\"td\", null), \r\n\t      E(\"td\", {className: \"pull-right\"}, \r\n\t      this.updatable(f), E(\"button\", {className: classes, \r\n\t               onClick: this.deleteFile, \"data-filename\": f.filename}, \"Delete\")\r\n\t        \r\n\t      )\r\n\t  )\r\n\t},  \r\n\tshowRemote:function(f) { \r\n\t  var classes=\"btn btn-warning\";\r\n\t  if (this.state.downloading) classes+=\" disabled\";\r\n\t  return (E(\"tr\", {\"data-id\": f.filename}, E(\"td\", null, \r\n\t      f.filename), \r\n\t      E(\"td\", null, f.desc), \r\n\t      E(\"td\", null, \r\n\t      E(\"span\", {\"data-filename\": f.filename, \"data-url\": f.url, \r\n\t            className: classes, \r\n\t            onClick: this.download}, \"Download\")\r\n\t      )\r\n\t  ));\r\n\t},\r\n\tshowFile:function(f) {\r\n\t//\treturn <span data-id={f.filename}>{f.url}</span>\r\n\t\treturn (f.ready)?this.showLocal(f):this.showRemote(f);\r\n\t},\r\n\treloadDir:function() {\r\n\t\tthis.props.action(\"reload\");\r\n\t},\r\n\tdownload:function(e) {\r\n\t\tvar url=e.target.dataset[\"url\"];\r\n\t\tvar filename=e.target.dataset[\"filename\"];\r\n\t\tthis.setState({downloading:true,progress:0,url:url});\r\n\t\tthis.userbreak=false;\r\n\t\thtml5fs.download(url,filename,function(){\r\n\t\t\tthis.reloadDir();\r\n\t\t\tthis.setState({downloading:false,progress:1});\r\n\t\t\t},function(progress,total){\r\n\t\t\t\tif (progress==0) {\r\n\t\t\t\t\tthis.setState({message:\"total \"+total})\r\n\t\t\t \t}\r\n\t\t\t \tthis.setState({progress:progress});\r\n\t\t\t \t//if user press abort return true\r\n\t\t\t \treturn this.userbreak;\r\n\t\t\t}\r\n\t\t,this);\r\n\t},\r\n\tdeleteFile:function( e) {\r\n\t\tvar filename=e.target.attributes[\"data-filename\"].value;\r\n\t\tthis.props.action(\"delete\",filename);\r\n\t},\r\n\tallFilesReady:function(e) {\r\n\t\treturn this.props.files.every(function(f){ return f.ready});\r\n\t},\r\n\tdismiss:function() {\r\n\t\t$(this.refs.dialog1.getDOMNode()).modal('hide');\r\n\t\tthis.props.action(\"dismiss\");\r\n\t},\r\n\tabortdownload:function() {\r\n\t\tthis.userbreak=true;\r\n\t},\r\n\tshowProgress:function() {\r\n\t     if (this.state.downloading) {\r\n\t      var progress=Math.round(this.state.progress*100);\r\n\t      return (\r\n\t      \tE(\"div\", null, \r\n\t      \t\"Downloading from \", this.state.url, \r\n\t      E(\"div\", {key: \"progress\", className: \"progress col-md-8\"}, \r\n\t          E(\"div\", {className: \"progress-bar\", role: \"progressbar\", \r\n\t              \"aria-valuenow\": progress, \"aria-valuemin\": \"0\", \r\n\t              \"aria-valuemax\": \"100\", style: {width: progress+\"%\"}}, \r\n\t            progress, \"%\"\r\n\t          )\r\n\t        ), \r\n\t        E(\"button\", {onClick: this.abortdownload, \r\n\t        \tclassName: \"btn btn-danger col-md-4\"}, \"Abort\")\r\n\t        )\r\n\t        );\r\n\t      } else {\r\n\t      \t\tif ( this.allFilesReady() ) {\r\n\t      \t\t\treturn E(\"button\", {onClick: this.dismiss, className: \"btn btn-success\"}, \"Ok\")\r\n\t      \t\t} else return null;\r\n\t      \t\t\r\n\t      }\r\n\t},\r\n\tshowUsage:function() {\r\n\t\tvar percent=this.props.remainPercent;\r\n           return (E(\"div\", null, E(\"span\", {className: \"pull-left\"}, \"Usage:\"), E(\"div\", {className: \"progress\"}, \r\n\t\t  E(\"div\", {className: \"progress-bar progress-bar-success progress-bar-striped\", role: \"progressbar\", style: {width: percent+\"%\"}}, \r\n\t\t    \tpercent+\"%\"\r\n\t\t  )\r\n\t\t)));\r\n\t},\r\n\trender:function() {\r\n\t  \treturn (\r\n\t\tE(\"div\", {ref: \"dialog1\", className: \"modal fade\", \"data-backdrop\": \"static\"}, \r\n\t\t    E(\"div\", {className: \"modal-dialog\"}, \r\n\t\t      E(\"div\", {className: \"modal-content\"}, \r\n\t\t        E(\"div\", {className: \"modal-header\"}, \r\n\t\t          E(\"h4\", {className: \"modal-title\"}, \"File Installer\")\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-body\"}, \r\n\t\t        \tE(\"table\", {className: \"table\"}, \r\n\t\t        \tE(\"tbody\", null, \r\n\t\t          \tthis.props.files.map(this.showFile)\r\n\t\t          \t)\r\n\t\t          )\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-footer\"}, \r\n\t\t        \tthis.showUsage(), \r\n\t\t           this.showProgress()\r\n\t\t        )\r\n\t\t      )\r\n\t\t    )\r\n\t\t  )\r\n\t\t);\r\n\t},\t\r\n\tcomponentDidMount:function() {\r\n\t\t$(this.refs.dialog1.getDOMNode()).modal('show');\r\n\t}\r\n});\r\n/*TODO kdb check version*/\r\nvar Filemanager = React.createClass({\r\n\tgetInitialState:function() {\r\n\t\tvar quota=this.getQuota();\r\n\t\treturn {browserReady:false,noupdate:true,\trequestQuota:quota,remain:0};\r\n\t},\r\n\tgetQuota:function() {\r\n\t\tvar q=this.props.quota||\"128M\";\r\n\t\tvar unit=q[q.length-1];\r\n\t\tvar times=1;\r\n\t\tif (unit==\"M\") times=1024*1024;\r\n\t\telse if (unit=\"K\") times=1024;\r\n\t\treturn parseInt(q) * times;\r\n\t},\r\n\tmissingKdb:function() {\r\n\t\tif (ksanagap.platform!=\"chrome\") return [];\r\n\t\tvar missing=this.props.needed.filter(function(kdb){\r\n\t\t\tfor (var i in html5fs.files) {\r\n\t\t\t\tif (html5fs.files[i][0]==kdb.filename) return false;\r\n\t\t\t}\r\n\t\t\treturn true;\r\n\t\t},this);\r\n\t\treturn missing;\r\n\t},\r\n\tgetRemoteUrl:function(fn) {\r\n\t\tvar f=this.props.needed.filter(function(f){return f.filename==fn});\r\n\t\tif (f.length ) return f[0].url;\r\n\t},\r\n\tgenFileList:function(existing,missing){\r\n\t\tvar out=[];\r\n\t\tfor (var i in existing) {\r\n\t\t\tvar url=this.getRemoteUrl(existing[i][0]);\r\n\t\t\tout.push({filename:existing[i][0], url :url, ready:true });\r\n\t\t}\r\n\t\tfor (var i in missing) {\r\n\t\t\tout.push(missing[i]);\r\n\t\t}\r\n\t\treturn out;\r\n\t},\r\n\treload:function() {\r\n\t\thtml5fs.readdir(function(files){\r\n  \t\t\tthis.setState({files:this.genFileList(files,this.missingKdb())});\r\n  \t\t},this);\r\n\t },\r\n\tdeleteFile:function(fn) {\r\n\t  html5fs.rm(fn,function(){\r\n\t  \tthis.reload();\r\n\t  },this);\r\n\t},\r\n\tonQuoteOk:function(quota,usage) {\r\n\t\tif (ksanagap.platform!=\"chrome\") {\r\n\t\t\t//console.log(\"onquoteok\");\r\n\t\t\tthis.setState({noupdate:true,missing:[],files:[],autoclose:true\r\n\t\t\t\t,quota:quota,remain:quota-usage,usage:usage});\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t//console.log(\"quote ok\");\r\n\t\tvar files=this.genFileList(html5fs.files,this.missingKdb());\r\n\t\tvar that=this;\r\n\t\tthat.checkIfUpdate(files,function(hasupdate) {\r\n\t\t\tvar missing=this.missingKdb();\r\n\t\t\tvar autoclose=this.props.autoclose;\r\n\t\t\tif (missing.length) autoclose=false;\r\n\t\t\tthat.setState({autoclose:autoclose,\r\n\t\t\t\tquota:quota,usage:usage,files:files,\r\n\t\t\t\tmissing:missing,\r\n\t\t\t\tnoupdate:!hasupdate,\r\n\t\t\t\tremain:quota-usage});\r\n\t\t});\r\n\t},  \r\n\tonBrowserOk:function() {\r\n\t  this.totalDownloadSize();\r\n\t}, \r\n\tdismiss:function() {\r\n\t\tthis.props.onReady(this.state.usage,this.state.quota);\r\n\t\tsetTimeout(function(){\r\n\t\t\tvar modalin=$(\".modal.in\");\r\n\t\t\tif (modalin.modal) modalin.modal('hide');\r\n\t\t},500);\r\n\t}, \r\n\ttotalDownloadSize:function() {\r\n\t\tvar files=this.missingKdb();\r\n\t\tvar taskqueue=[],totalsize=0;\r\n\t\tfor (var i=0;i<files.length;i++) {\r\n\t\t\ttaskqueue.push(\r\n\t\t\t\t(function(idx){\r\n\t\t\t\t\treturn (function(data){\r\n\t\t\t\t\t\tif (!(typeof data=='object' && data.__empty)) totalsize+=data;\r\n\t\t\t\t\t\thtml5fs.getDownloadSize(files[idx].url,taskqueue.shift());\r\n\t\t\t\t\t});\r\n\t\t\t\t})(i)\r\n\t\t\t);\r\n\t\t}\r\n\t\tvar that=this;\r\n\t\ttaskqueue.push(function(data){\t\r\n\t\t\ttotalsize+=data;\r\n\t\t\tsetTimeout(function(){that.setState({requireSpace:totalsize,browserReady:true})},0);\r\n\t\t});\r\n\t\ttaskqueue.shift()({__empty:true});\r\n\t},\r\n\tcheckIfUpdate:function(files,cb) {\r\n\t\tvar taskqueue=[];\r\n\t\tfor (var i=0;i<files.length;i++) {\r\n\t\t\ttaskqueue.push(\r\n\t\t\t\t(function(idx){\r\n\t\t\t\t\treturn (function(data){\r\n\t\t\t\t\t\tif (!(typeof data=='object' && data.__empty)) files[idx-1].hasUpdate=data;\r\n\t\t\t\t\t\thtml5fs.checkUpdate(files[idx].url,files[idx].filename,taskqueue.shift());\r\n\t\t\t\t\t});\r\n\t\t\t\t})(i)\r\n\t\t\t);\r\n\t\t}\r\n\t\tvar that=this;\r\n\t\ttaskqueue.push(function(data){\t\r\n\t\t\tif (files.length) files[files.length-1].hasUpdate=data;\r\n\t\t\tvar hasupdate=files.some(function(f){return f.hasUpdate});\r\n\t\t\tif (cb) cb.apply(that,[hasupdate]);\r\n\t\t});\r\n\t\ttaskqueue.shift()({__empty:true});\r\n\t},\r\n\trender:function(){\r\n    \t\tif (!this.state.browserReady) {   \r\n      \t\t\treturn E(CheckBrowser, {feature: \"fs\", onReady: this.onBrowserOk})\r\n    \t\t} if (!this.state.quota || this.state.remain<this.state.requireSpace) {  \r\n    \t\t\tvar quota=this.state.requestQuota;\r\n    \t\t\tif (this.state.usage+this.state.requireSpace>quota) {\r\n    \t\t\t\tquota=(this.state.usage+this.state.requireSpace)*1.5;\r\n    \t\t\t}\r\n      \t\t\treturn E(HtmlFS, {quota: quota, autoclose: \"true\", onReady: this.onQuoteOk})\r\n      \t\t} else {\r\n\t\t\tif (!this.state.noupdate || this.missingKdb().length || !this.state.autoclose) {\r\n\t\t\t\tvar remain=Math.round((this.state.usage/this.state.quota)*100);\t\t\t\t\r\n\t\t\t\treturn E(FileList, {action: this.action, files: this.state.files, remainPercent: remain})\r\n\t\t\t} else {\r\n\t\t\t\tsetTimeout( this.dismiss ,0);\r\n\t\t\t\treturn E(\"span\", null, \"Success\");\r\n\t\t\t}\r\n      \t\t}\r\n\t},\r\n\taction:function() {\r\n\t  var args = Array.prototype.slice.call(arguments);\r\n\t  var type=args.shift();\r\n\t  var res=null, that=this;\r\n\t  if (type==\"delete\") {\r\n\t    this.deleteFile(args[0]);\r\n\t  }  else if (type==\"reload\") {\r\n\t  \tthis.reload();\r\n\t  } else if (type==\"dismiss\") {\r\n\t  \tthis.dismiss();\r\n\t  }\r\n\t}\r\n});\r\n\r\nmodule.exports=Filemanager;",
    "/* emulate filesystem on html5 browser */\r\nvar get_head=function(url,field,cb){\r\n\tvar xhr = new XMLHttpRequest();\r\n\txhr.open(\"HEAD\", url, true);\r\n\txhr.onreadystatechange = function() {\r\n\t\t\tif (this.readyState == this.DONE) {\r\n\t\t\t\tcb(xhr.getResponseHeader(field));\r\n\t\t\t} else {\r\n\t\t\t\tif (this.status!==200&&this.status!==206) {\r\n\t\t\t\t\tcb(\"\");\r\n\t\t\t\t}\r\n\t\t\t} \r\n\t};\r\n\txhr.send();\t\r\n}\r\nvar get_date=function(url,cb) {\r\n\tget_head(url,\"Last-Modified\",function(value){\r\n\t\tcb(value);\r\n\t});\r\n}\r\nvar get_size=function(url, cb) {\r\n\tget_head(url,\"Content-Length\",function(value){\r\n\t\tcb(parseInt(value));\r\n\t});\r\n};\r\nvar checkUpdate=function(url,fn,cb) {\r\n\tif (!url) {\r\n\t\tcb(false);\r\n\t\treturn;\r\n\t}\r\n\tget_date(url,function(d){\r\n\t\tAPI.fs.root.getFile(fn, {create: false, exclusive: false}, function(fileEntry) {\r\n\t\t\tfileEntry.getMetadata(function(metadata){\r\n\t\t\t\tvar localDate=Date.parse(metadata.modificationTime);\r\n\t\t\t\tvar urlDate=Date.parse(d);\r\n\t\t\t\tcb(urlDate>localDate);\r\n\t\t\t});\r\n\t\t},function(){\r\n\t\t\tcb(false);\r\n\t\t});\r\n\t});\r\n}\r\nvar download=function(url,fn,cb,statuscb,context) {\r\n\t var totalsize=0,batches=null,written=0;\r\n\t var fileEntry=0, fileWriter=0;\r\n\t var createBatches=function(size) {\r\n\t\tvar bytes=1024*1024, out=[];\r\n\t\tvar b=Math.floor(size / bytes);\r\n\t\tvar last=size %bytes;\r\n\t\tfor (var i=0;i<=b;i++) {\r\n\t\t\tout.push(i*bytes);\r\n\t\t}\r\n\t\tout.push(b*bytes+last);\r\n\t\treturn out;\r\n\t }\r\n\t var finish=function() {\r\n\t\t rm(fn,function(){\r\n\t\t\t\tfileEntry.moveTo(fileEntry.filesystem.root, fn,function(){\r\n\t\t\t\t\tsetTimeout( cb.bind(context,false) , 0) ; \r\n\t\t\t\t},function(e){\r\n\t\t\t\t\tconsole.log(\"failed\",e)\r\n\t\t\t\t});\r\n\t\t },this); \r\n\t };\r\n\t\tvar tempfn=\"temp.kdb\";\r\n\t\tvar batch=function(b) {\r\n\t\tvar abort=false;\r\n\t\tvar xhr = new XMLHttpRequest();\r\n\t\tvar requesturl=url+\"?\"+Math.random();\r\n\t\txhr.open('get', requesturl, true);\r\n\t\txhr.setRequestHeader('Range', 'bytes='+batches[b]+'-'+(batches[b+1]-1));\r\n\t\txhr.responseType = 'blob';    \r\n\t\txhr.addEventListener('load', function() {\r\n\t\t\tvar blob=this.response;\r\n\t\t\tfileEntry.createWriter(function(fileWriter) {\r\n\t\t\t\tfileWriter.seek(fileWriter.length);\r\n\t\t\t\tfileWriter.write(blob);\r\n\t\t\t\twritten+=blob.size;\r\n\t\t\t\tfileWriter.onwriteend = function(e) {\r\n\t\t\t\t\tif (statuscb) {\r\n\t\t\t\t\t\tabort=statuscb.apply(context,[ fileWriter.length / totalsize,totalsize ]);\r\n\t\t\t\t\t\tif (abort) setTimeout( cb.bind(context,false) , 0) ;\r\n\t\t\t\t \t}\r\n\t\t\t\t\tb++;\r\n\t\t\t\t\tif (!abort) {\r\n\t\t\t\t\t\tif (b<batches.length-1) setTimeout(batch.bind(context,b),0);\r\n\t\t\t\t\t\telse                    finish();\r\n\t\t\t\t \t}\r\n\t\t\t \t};\r\n\t\t\t}, console.error);\r\n\t\t},false);\r\n\t\txhr.send();\r\n\t}\r\n\r\n\tget_size(url,function(size){\r\n\t\ttotalsize=size;\r\n\t\tif (!size) {\r\n\t\t\tif (cb) cb.apply(context,[false]);\r\n\t\t} else {//ready to download\r\n\t\t\trm(tempfn,function(){\r\n\t\t\t\t batches=createBatches(size);\r\n\t\t\t\t if (statuscb) statuscb.apply(context,[ 0, totalsize ]);\r\n\t\t\t\t API.fs.root.getFile(tempfn, {create: 1, exclusive: false}, function(_fileEntry) {\r\n\t\t\t\t\t\t\tfileEntry=_fileEntry;\r\n\t\t\t\t\t\tbatch(0);\r\n\t\t\t\t });\r\n\t\t\t},this);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nvar readFile=function(filename,cb,context) {\r\n\tAPI.fs.root.getFile(filename, function(fileEntry) {\r\n\t\t\tvar reader = new FileReader();\r\n\t\t\treader.onloadend = function(e) {\r\n\t\t\t\t\tif (cb) cb.apply(cb,[this.result]);\r\n\t\t\t\t};            \r\n\t}, console.error);\r\n}\r\nvar writeFile=function(filename,buf,cb,context){\r\n\tAPI.fs.root.getFile(filename, {create: true, exclusive: true}, function(fileEntry) {\r\n\t\t\tfileEntry.createWriter(function(fileWriter) {\r\n\t\t\t\tfileWriter.write(buf);\r\n\t\t\t\tfileWriter.onwriteend = function(e) {\r\n\t\t\t\t\tif (cb) cb.apply(cb,[buf.byteLength]);\r\n\t\t\t\t};            \r\n\t\t\t}, console.error);\r\n\t}, console.error);\r\n}\r\n\r\nvar readdir=function(cb,context) {\r\n\tvar dirReader = API.fs.root.createReader();\r\n\tvar out=[],that=this;\r\n\tdirReader.readEntries(function(entries) {\r\n\t\tif (entries.length) {\r\n\t\t\tfor (var i = 0, entry; entry = entries[i]; ++i) {\r\n\t\t\t\tif (entry.isFile) {\r\n\t\t\t\t\tout.push([entry.name,entry.toURL ? entry.toURL() : entry.toURI()]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tAPI.files=out;\r\n\t\tif (cb) cb.apply(context,[out]);\r\n\t}, function(){\r\n\t\tif (cb) cb.apply(context,[null]);\r\n\t});\r\n}\r\nvar getFileURL=function(filename) {\r\n\tif (!API.files ) return null;\r\n\tvar file= API.files.filter(function(f){return f[0]==filename});\r\n\tif (file.length) return file[0][1];\r\n}\r\nvar rm=function(filename,cb,context) {\r\n\tvar url=getFileURL(filename);\r\n\tif (url) rmURL(url,cb,context);\r\n\telse if (cb) cb.apply(context,[false]);\r\n}\r\n\r\nvar rmURL=function(filename,cb,context) {\r\n\twebkitResolveLocalFileSystemURL(filename, function(fileEntry) {\r\n\t\tfileEntry.remove(function() {\r\n\t\t\tif (cb) cb.apply(context,[true]);\r\n\t\t}, console.error);\r\n\t},  function(e){\r\n\t\tif (cb) cb.apply(context,[false]);//no such file\r\n\t});\r\n}\r\nfunction errorHandler(e) {\r\n\tconsole.error('Error: ' +e.name+ \" \"+e.message);\r\n}\r\nvar initfs=function(grantedBytes,cb,context) {\r\n\twebkitRequestFileSystem(PERSISTENT, grantedBytes,  function(fs) {\r\n\t\tAPI.fs=fs;\r\n\t\tAPI.quota=grantedBytes;\r\n\t\treaddir(function(){\r\n\t\t\tAPI.initialized=true;\r\n\t\t\tcb.apply(context,[grantedBytes,fs]);\r\n\t\t},context);\r\n\t}, errorHandler);\r\n}\r\nvar init=function(quota,cb,context) {\r\n\tnavigator.webkitPersistentStorage.requestQuota(quota, \r\n\t\t\tfunction(grantedBytes) {\r\n\t\t\t\tinitfs(grantedBytes,cb,context);\r\n\t\t}, errorHandler\r\n\t);\r\n}\r\nvar queryQuota=function(cb,context) {\r\n\tvar that=this;\r\n\tnavigator.webkitPersistentStorage.queryUsageAndQuota( \r\n\t function(usage,quota){\r\n\t\t\tinitfs(quota,function(){\r\n\t\t\t\tcb.apply(context,[usage,quota]);\r\n\t\t\t},context);\r\n\t});\r\n}\r\nvar API={\r\n\tinit:init\r\n\t,readdir:readdir\r\n\t,checkUpdate:checkUpdate\r\n\t,rm:rm\r\n\t,rmURL:rmURL\r\n\t,getFileURL:getFileURL\r\n\t,writeFile:writeFile\r\n\t,readFile:readFile\r\n\t,download:download\r\n\t,get_head:get_head\r\n\t,get_date:get_date\r\n\t,get_size:get_size\r\n\t,getDownloadSize:get_size\r\n\t,queryQuota:queryQuota\r\n}\r\nmodule.exports=API;",
    "var html5fs=require(\"./html5fs\");\r\nvar React=(window&&window.React)||require(\"react\");\r\nvar E=React.createElement;\r\n\r\nvar htmlfs = React.createClass({\r\n\tgetInitialState:function() { \r\n\t\treturn {ready:false, quota:0,usage:0,Initialized:false,autoclose:this.props.autoclose};\r\n\t},\r\n\tinitFilesystem:function() {\r\n\t\tvar quota=this.props.quota||1024*1024*128; // default 128MB\r\n\t\tquota=parseInt(quota);\r\n\t\thtml5fs.init(quota,function(q){\r\n\t\t\tthis.dialog=false;\r\n\t\t\t$(this.refs.dialog1.getDOMNode()).modal('hide');\r\n\t\t\tthis.setState({quota:q,autoclose:true});\r\n\t\t},this);\r\n\t},\r\n\twelcome:function() {\r\n\t\treturn (\r\n\t\tE(\"div\", {ref: \"dialog1\", className: \"modal fade\", id: \"myModal\", \"data-backdrop\": \"static\"}, \r\n\t\t    E(\"div\", {className: \"modal-dialog\"}, \r\n\t\t      E(\"div\", {className: \"modal-content\"}, \r\n\t\t        E(\"div\", {className: \"modal-header\"}, \r\n\t\t          E(\"h4\", {className: \"modal-title\"}, \"Welcome\")\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-body\"}, \r\n\t\t          \"Browser will ask for your confirmation.\"\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-footer\"}, \r\n\t\t          E(\"button\", {onClick: this.initFilesystem, type: \"button\", \r\n\t\t            className: \"btn btn-primary\"}, \"Initialize File System\")\r\n\t\t        )\r\n\t\t      )\r\n\t\t    )\r\n\t\t  )\r\n\t\t );\r\n\t},\r\n\trenderDefault:function(){\r\n\t\tvar used=Math.floor(this.state.usage/this.state.quota *100);\r\n\t\tvar more=function() {\r\n\t\t\tif (used>50) return E(\"button\", {type: \"button\", className: \"btn btn-primary\"}, \"Allocate More\");\r\n\t\t\telse null;\r\n\t\t}\r\n\t\treturn (\r\n\t\tE(\"div\", {ref: \"dialog1\", className: \"modal fade\", id: \"myModal\", \"data-backdrop\": \"static\"}, \r\n\t\t    E(\"div\", {className: \"modal-dialog\"}, \r\n\t\t      E(\"div\", {className: \"modal-content\"}, \r\n\t\t        E(\"div\", {className: \"modal-header\"}, \r\n\t\t          E(\"h4\", {className: \"modal-title\"}, \"Sandbox File System\")\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-body\"}, \r\n\t\t          E(\"div\", {className: \"progress\"}, \r\n\t\t            E(\"div\", {className: \"progress-bar\", role: \"progressbar\", style: {width: used+\"%\"}}, \r\n\t\t               used, \"%\"\r\n\t\t            )\r\n\t\t          ), \r\n\t\t          E(\"span\", null, this.state.quota, \" total , \", this.state.usage, \" in used\")\r\n\t\t        ), \r\n\t\t        E(\"div\", {className: \"modal-footer\"}, \r\n\t\t          E(\"button\", {onClick: this.dismiss, type: \"button\", className: \"btn btn-default\", \"data-dismiss\": \"modal\"}, \"Close\"), \r\n\t\t          more()\r\n\t\t        )\r\n\t\t      )\r\n\t\t    )\r\n\t\t  )\r\n\t\t  );\r\n\t},\r\n\tdismiss:function() {\r\n\t\tvar that=this;\r\n\t\tsetTimeout(function(){\r\n\t\t\tthat.props.onReady(that.state.quota,that.state.usage);\t\r\n\t\t},0);\r\n\t},\r\n\tqueryQuota:function() {\r\n\t\tif (ksanagap.platform==\"chrome\") {\r\n\t\t\thtml5fs.queryQuota(function(usage,quota){\r\n\t\t\t\tthis.setState({usage:usage,quota:quota,initialized:true});\r\n\t\t\t},this);\t\t\t\r\n\t\t} else {\r\n\t\t\tthis.setState({usage:333,quota:1000*1000*1024,initialized:true,autoclose:true});\r\n\t\t}\r\n\t},\r\n\trender:function() {\r\n\t\tvar that=this;\r\n\t\tif (!this.state.quota || this.state.quota<this.props.quota) {\r\n\t\t\tif (this.state.initialized) {\r\n\t\t\t\tthis.dialog=true;\r\n\t\t\t\treturn this.welcome();\t\r\n\t\t\t} else {\r\n\t\t\t\treturn E(\"span\", null, \"checking quota\");\r\n\t\t\t}\t\t\t\r\n\t\t} else {\r\n\t\t\tif (!this.state.autoclose) {\r\n\t\t\t\tthis.dialog=true;\r\n\t\t\t\treturn this.renderDefault(); \r\n\t\t\t}\r\n\t\t\tthis.dismiss();\r\n\t\t\tthis.dialog=false;\r\n\t\t\treturn null;\r\n\t\t}\r\n\t},\r\n\tcomponentDidMount:function() {\r\n\t\tif (!this.state.quota) {\r\n\t\t\tthis.queryQuota();\r\n\r\n\t\t};\r\n\t},\r\n\tcomponentDidUpdate:function() {\r\n\t\tif (this.dialog) $(this.refs.dialog1.getDOMNode()).modal('show');\r\n\t}\r\n});\r\n\r\nmodule.exports=htmlfs;",
    "var ksana={\"platform\":\"remote\"};\r\nif (typeof window!=\"undefined\") {\r\n\twindow.ksana=ksana;\r\n\tif (typeof ksanagap==\"undefined\") {\r\n\t\twindow.ksanagap=require(\"./ksanagap\"); //compatible layer with mobile\r\n\t}\r\n}\r\nif (typeof process !=\"undefined\") {\r\n\tif (process.versions && process.versions[\"node-webkit\"]) {\r\n  \t\tif (typeof nodeRequire!=\"undefined\") ksana.require=nodeRequire;\r\n  \t\tksana.platform=\"node-webkit\";\r\n  \t\twindow.ksanagap.platform=\"node-webkit\";\r\n\t\tvar ksanajs=require(\"fs\").readFileSync(\"ksana.js\",\"utf8\").trim();\r\n\t\tksana.js=JSON.parse(ksanajs.substring(14,ksanajs.length-1));\r\n\t\twindow.kfs=require(\"./kfs\");\r\n  \t}\r\n} else if (typeof chrome!=\"undefined\"){//} && chrome.fileSystem){\r\n//\twindow.ksanagap=require(\"./ksanagap\"); //compatible layer with mobile\r\n\twindow.ksanagap.platform=\"chrome\";\r\n\twindow.kfs=require(\"./kfs_html5\");\r\n\tif(window.location.origin.indexOf(\"//127.0.0.1\")>-1) {\r\n\t\trequire(\"./livereload\")();\r\n\t}\r\n\tksana.platform=\"chrome\";\r\n} else {\r\n\tif (typeof ksanagap!=\"undefined\" && typeof fs!=\"undefined\") {//mobile\r\n\t\tvar ksanajs=fs.readFileSync(\"ksana.js\",\"utf8\").trim(); //android extra \\n at the end\r\n\t\tksana.js=JSON.parse(ksanajs.substring(14,ksanajs.length-1));\r\n\t\tksana.platform=ksanagap.platform;\r\n\t\tif (typeof ksanagap.android !=\"undefined\") {\r\n\t\t\tksana.platform=\"android\";\r\n\t\t}\r\n\t}\r\n}\r\nvar timer=null;\r\nvar React=window.React||require(\"react\");\r\nvar boot=function(appId,cb) {\r\n\tif (typeof React!=\"undefined\") {\r\n\t\tReact.initializeTouchEvents(true);\r\n\t}\r\n\tksana.appId=appId;\r\n\tif (ksanagap.platform==\"chrome\") { //need to wait for jsonp ksana.js\r\n\t\ttimer=setInterval(function(){\r\n\t\t\tif (ksana.ready){\r\n\t\t\t\tclearInterval(timer);\r\n\t\t\t\tif (ksana.js && ksana.js.files && ksana.js.files.length) {\r\n\t\t\t\t\trequire(\"./installkdb\")(ksana.js,cb);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcb();\t\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},300);\r\n\t} else {\r\n\t\tcb();\r\n\t}\r\n}\r\n\r\nmodule.exports={boot:boot\r\n\t,htmlfs:require(\"./htmlfs\")\r\n\t,html5fs:require(\"./html5fs\")\r\n\t,liveupdate:require(\"./liveupdate\")\r\n\t,fileinstaller:require(\"./fileinstaller\")\r\n\t,downloader:require(\"./downloader\")\r\n\t,installkdb:require(\"./installkdb\")\r\n};",
    "var React=(window&&window.React)||require(\"react\");\r\nvar Fileinstaller=require(\"./fileinstaller\");\r\n\r\nvar getRequire_kdb=function() {\r\n    var required=[];\r\n    ksana.js.files.map(function(f){\r\n      if (f.indexOf(\".kdb\")==f.length-4) {\r\n        var slash=f.lastIndexOf(\"/\");\r\n        if (slash>-1) {\r\n          var dbid=f.substring(slash+1,f.length-4);\r\n          required.push({url:f,dbid:dbid,filename:dbid+\".kdb\"});\r\n        } else {\r\n          var dbid=f.substring(0,f.length-4);\r\n          required.push({url:ksana.js.baseurl+f,dbid:dbid,filename:f});\r\n        }        \r\n      }\r\n    });\r\n    return required;\r\n}\r\nvar callback=null;\r\nvar onReady=function() {\r\n\tcallback();\r\n}\r\nvar openFileinstaller=function(keep) {\r\n\tvar require_kdb=getRequire_kdb().map(function(db){\r\n\t  return {\r\n\t    url:window.location.origin+window.location.pathname+db.dbid+\".kdb\",\r\n\t    dbdb:db.dbid,\r\n\t    filename:db.filename\r\n\t  }\r\n\t})\r\n\treturn React.createElement(Fileinstaller, {quota: \"512M\", autoclose: !keep, needed: require_kdb, \r\n\t                 onReady: onReady});\r\n}\r\nvar installkdb=function(ksanajs,cb,context) {\r\n\tReact.render(openFileinstaller(),document.getElementById(\"main\"));\r\n\tcallback=cb;\r\n}\r\nmodule.exports=installkdb;",
    "//Simulate feature in ksanagap\r\n/* \r\n  runs on node-webkit only\r\n*/\r\n\r\nvar readDir=function(path) { //simulate Ksanagap function\r\n\tvar fs=nodeRequire(\"fs\");\r\n\tpath=path||\"..\";\r\n\tvar dirs=[];\r\n\tif (path[0]==\".\") {\r\n\t\tif (path==\".\") dirs=fs.readdirSync(\".\");\r\n\t\telse {\r\n\t\t\tdirs=fs.readdirSync(\"..\");\r\n\t\t}\r\n\t} else {\r\n\t\tdirs=fs.readdirSync(path);\r\n\t}\r\n\r\n\treturn dirs.join(\"\\uffff\");\r\n}\r\nvar listApps=function() {\r\n\r\n\tvar fs=nodeRequire(\"fs\");\r\n\tvar ksanajsfile=function(d) {return \"../\"+d+\"/ksana.js\"};\r\n\tvar dirs=fs.readdirSync(\"..\").filter(function(d){\r\n\t\t\t\treturn fs.statSync(\"../\"+d).isDirectory() && d[0]!=\".\"\r\n\t\t\t\t   && fs.existsSync(ksanajsfile(d));\r\n\t});\r\n\t\r\n\tvar out=dirs.map(function(d){\r\n\r\n\t\tvar fn=ksanajsfile(d);\r\n\t\tif (!fs.existsSync(fn)) return;\r\n\t\tvar content=fs.readFileSync(fn,\"utf8\");\r\n  \t\tcontent=content.replace(\"})\",\"}\");\r\n  \t\tcontent=content.replace(\"jsonp_handler(\",\"\");\r\n  \t\ttry{\r\n  \t\t\tvar obj= JSON.parse(content);\r\n\t\t\tobj.dbid=d;\r\n\t\t\tobj.path=d;\r\n\t\t\treturn obj;\r\n  \t\t} catch(e) {\r\n  \t\t\tconsole.log(e);\r\n  \t\t\treturn null;\r\n  \t\t}\r\n\t});\r\n\r\n\tout=out.filter(function(o){return !!o});\r\n\treturn JSON.stringify(out);\r\n}\r\n\r\n\r\n\r\nvar kfs={readDir:readDir,listApps:listApps};\r\n\r\nmodule.exports=kfs;",
    "var readDir=function(){\r\n\treturn \"[]\";\r\n}\r\nvar listApps=function(){\r\n\treturn \"[]\";\r\n}\r\nmodule.exports={readDir:readDir,listApps:listApps};",
    "var appname=\"installer\";\r\nvar switchApp=function(path) {\r\n\tvar fs=require(\"fs\");\r\n\tpath=\"../\"+path;\r\n\tappname=path;\r\n\tdocument.location.href= path+\"/index.html\"; \r\n\tprocess.chdir(path);\r\n}\r\nvar downloader={};\r\nvar rootPath=\"\";\r\n\r\nvar deleteApp=function(app) {\r\n\tconsole.error(\"not allow on PC, do it in File Explorer/ Finder\");\r\n}\r\nvar username=function() {\r\n\treturn \"\";\r\n}\r\nvar useremail=function() {\r\n\treturn \"\"\r\n}\r\nvar runtime_version=function() {\r\n\treturn \"1.4\";\r\n}\r\n\r\n//copy from liveupdate\r\nvar jsonp=function(url,dbid,callback,context) {\r\n  var script=document.getElementById(\"jsonp2\");\r\n  if (script) {\r\n    script.parentNode.removeChild(script);\r\n  }\r\n  window.jsonp_handler=function(data) {\r\n    if (typeof data==\"object\") {\r\n      data.dbid=dbid;\r\n      callback.apply(context,[data]);    \r\n    }  \r\n  }\r\n  window.jsonp_error_handler=function() {\r\n    console.error(\"url unreachable\",url);\r\n    callback.apply(context,[null]);\r\n  }\r\n  script=document.createElement('script');\r\n  script.setAttribute('id', \"jsonp2\");\r\n  script.setAttribute('onerror', \"jsonp_error_handler()\");\r\n  url=url+'?'+(new Date().getTime());\r\n  script.setAttribute('src', url);\r\n  document.getElementsByTagName('head')[0].appendChild(script); \r\n}\r\n\r\nvar ksanagap={\r\n\tplatform:\"node-webkit\",\r\n\tstartDownload:downloader.startDownload,\r\n\tdownloadedByte:downloader.downloadedByte,\r\n\tdownloadingFile:downloader.downloadingFile,\r\n\tcancelDownload:downloader.cancelDownload,\r\n\tdoneDownload:downloader.doneDownload,\r\n\tswitchApp:switchApp,\r\n\trootPath:rootPath,\r\n\tdeleteApp: deleteApp,\r\n\tusername:username, //not support on PC\r\n\tuseremail:username,\r\n\truntime_version:runtime_version,\r\n\t\r\n}\r\n\r\nif (typeof process!=\"undefined\" && !process.browser) {\r\n\tvar ksanajs=require(\"fs\").readFileSync(\"./ksana.js\",\"utf8\").trim();\r\n\tdownloader=require(\"./downloader\");\r\n\t//ksana.js=JSON.parse(ksanajs.substring(14,ksanajs.length-1));\r\n\trootPath=process.cwd();\r\n\trootPath=require(\"path\").resolve(rootPath,\"..\").replace(/\\\\/g,\"/\")+'/';\r\n\tksana.ready=true;\r\n} else{\r\n\tvar url=window.location.origin+window.location.pathname.replace(\"index.html\",\"\")+\"ksana.js\";\r\n\tjsonp(url,appname,function(data){\r\n\t\tksana.js=data;\r\n\t\tksana.ready=true;\r\n\t});\r\n}\r\nmodule.exports=ksanagap;",
    "var started=false;\r\nvar timer=null;\r\nvar bundledate=null;\r\nvar get_date=require(\"./html5fs\").get_date;\r\nvar checkIfBundleUpdated=function() {\r\n\tget_date(\"bundle.js\",function(date){\r\n\t\tif (bundledate &&bundledate!=date){\r\n\t\t\tlocation.reload();\r\n\t\t}\r\n\t\tbundledate=date;\r\n\t});\r\n}\r\nvar livereload=function() {\r\n\tif (started) return;\r\n\r\n\ttimer1=setInterval(function(){\r\n\t\tcheckIfBundleUpdated();\r\n\t},2000);\r\n\tstarted=true;\r\n}\r\n\r\nmodule.exports=livereload;",
    "\r\nvar jsonp=function(url,dbid,callback,context) {\r\n  var script=document.getElementById(\"jsonp\");\r\n  if (script) {\r\n    script.parentNode.removeChild(script);\r\n  }\r\n  if (typeof dbid==\"function\") {\r\n    context=callback;\r\n    callback=dbid;\r\n    dbid=\"\";\r\n  }\r\n  window.jsonp_handler=function(data) {\r\n    //console.log(\"receive from ksana.js\",data);\r\n    if (typeof data==\"object\" && dbid) {\r\n      if (typeof data.dbid==\"undefined\") {\r\n        data.dbid=dbid;\r\n      }\r\n    }\r\n    callback.apply(context,[data]);\r\n  }\r\n\r\n  window.jsonp_error_handler=function() {\r\n    console.error(\"url unreachable\",url);\r\n    callback.apply(context,[null]);\r\n  }\r\n\r\n  script=document.createElement('script');\r\n  script.setAttribute('id', \"jsonp\");\r\n  script.setAttribute('onerror', \"jsonp_error_handler()\");\r\n  url=url+'?'+(new Date().getTime());\r\n  script.setAttribute('src', url);\r\n  document.getElementsByTagName('head')[0].appendChild(script); \r\n}\r\nvar runtime_version_ok=function(minruntime) {\r\n  if (!minruntime) return true;//not mentioned.\r\n  var min=parseFloat(minruntime);\r\n  var runtime=parseFloat( ksanagap.runtime_version()||\"1.0\");\r\n  if (min>runtime) return false;\r\n  return true;\r\n}\r\n\r\nvar needToUpdate=function(fromjson,tojson) {\r\n  var needUpdates=[];\r\n  for (var i=0;i<fromjson.length;i++) { \r\n    var to=tojson[i];\r\n    var from=fromjson[i];\r\n    var newfiles=[],newfilesizes=[],removed=[];\r\n    \r\n    if (!to || !to.files) continue; //cannot reach host\r\n    if (!runtime_version_ok(to.minruntime)) {\r\n      console.warn(\"runtime too old, need \"+to.minruntime);\r\n      continue; \r\n    }\r\n    if (!from.filedates) {\r\n      console.warn(\"missing filedates in ksana.js of \"+from.dbid);\r\n      continue;\r\n    }\r\n    from.filedates.map(function(f,idx){\r\n      var newidx=to.files.indexOf( from.files[idx]);\r\n      if (newidx==-1) {\r\n        //file removed in new version\r\n        removed.push(from.files[idx]);\r\n      } else {\r\n        var fromdate=Date.parse(f);\r\n        var todate=Date.parse(to.filedates[newidx]);\r\n        if (fromdate<todate) {\r\n          newfiles.push( to.files[newidx] );\r\n          newfilesizes.push(to.filesizes[newidx]);\r\n        }        \r\n      }\r\n    });\r\n    if (newfiles.length) {\r\n      from.newfiles=newfiles;\r\n      from.newfilesizes=newfilesizes;\r\n      from.removed=removed;\r\n      needUpdates.push(from);\r\n    }\r\n  }\r\n  return needUpdates;\r\n}\r\nvar getUpdatables=function(apps,cb,context) {\r\n  getRemoteJson(apps,function(jsons){\r\n    var hasUpdates=needToUpdate(apps,jsons);\r\n    cb.apply(context,[hasUpdates]);\r\n  },context);\r\n}\r\nvar getRemoteJson=function(apps,cb,context) {\r\n  var taskqueue=[],output=[];\r\n  var makecb=function(app){\r\n    return function(data){\r\n        if (!(data && typeof data =='object' && data.__empty)) output.push(data);\r\n        if (!app.baseurl) {\r\n          taskqueue.shift({__empty:true});\r\n        } else {\r\n          var url=app.baseurl+\"/ksana.js\";\r\n          try {\r\n            jsonp( url ,app.dbid,taskqueue.shift(), context);             \r\n          } catch(e) {\r\n            console.log(e);\r\n            taskqueue.shift({__empty:true});\r\n          }\r\n        }\r\n    };\r\n  };\r\n  apps.forEach(function(app){taskqueue.push(makecb(app))});\r\n\r\n  taskqueue.push(function(data){\r\n    output.push(data);\r\n    cb.apply(context,[output]);\r\n  });\r\n\r\n  taskqueue.shift()({__empty:true}); //run the task\r\n}\r\nvar humanFileSize=function(bytes, si) {\r\n    var thresh = si ? 1000 : 1024;\r\n    if(bytes < thresh) return bytes + ' B';\r\n    var units = si ? ['kB','MB','GB','TB','PB','EB','ZB','YB'] : ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];\r\n    var u = -1;\r\n    do {\r\n        bytes /= thresh;\r\n        ++u;\r\n    } while(bytes >= thresh);\r\n    return bytes.toFixed(1)+' '+units[u];\r\n};\r\nvar humanDate=function(datestring) {\r\n    var d=Date.parse(datestring);\r\n    if (isNaN(d)) {\r\n      return \"invalid date\";\r\n    } else {\r\n      return new Date(d).toLocaleString();\r\n    }\r\n}\r\nvar start=function(ksanajs,cb,context){\r\n  var files=ksanajs.newfiles||ksanajs.files;\r\n  var baseurl=ksanajs.baseurl|| \"http://127.0.0.1:8080/\"+ksanajs.dbid+\"/\";\r\n  var started=ksanagap.startDownload(ksanajs.dbid,baseurl,files.join(\"\\uffff\"));\r\n  cb.apply(context,[started]);\r\n}\r\nvar status=function(){\r\n  var nfile=ksanagap.downloadingFile();\r\n  var downloadedByte=ksanagap.downloadedByte();\r\n  var done=ksanagap.doneDownload();\r\n  return {nfile:nfile,downloadedByte:downloadedByte, done:done};\r\n}\r\n\r\nvar cancel=function(){\r\n  return ksanagap.cancelDownload();\r\n}\r\n\r\nvar liveupdate={ humanFileSize: humanFileSize, humanDate:humanDate,\r\n  needToUpdate: needToUpdate , jsonp:jsonp, \r\n  getUpdatables:getUpdatables,\r\n  start:start,\r\n  cancel:cancel,\r\n  status:status\r\n  };\r\nmodule.exports=liveupdate;",
    "function mkdirP (p, mode, f, made) {\r\n     var path = nodeRequire('path');\r\n     var fs = nodeRequire('fs');\r\n\t\r\n    if (typeof mode === 'function' || mode === undefined) {\r\n        f = mode;\r\n        mode = 0x1FF & (~process.umask());\r\n    }\r\n    if (!made) made = null;\r\n\r\n    var cb = f || function () {};\r\n    if (typeof mode === 'string') mode = parseInt(mode, 8);\r\n    p = path.resolve(p);\r\n\r\n    fs.mkdir(p, mode, function (er) {\r\n        if (!er) {\r\n            made = made || p;\r\n            return cb(null, made);\r\n        }\r\n        switch (er.code) {\r\n            case 'ENOENT':\r\n                mkdirP(path.dirname(p), mode, function (er, made) {\r\n                    if (er) cb(er, made);\r\n                    else mkdirP(p, mode, cb, made);\r\n                });\r\n                break;\r\n\r\n            // In the case of any other error, just see if there's a dir\r\n            // there already.  If so, then hooray!  If not, then something\r\n            // is borked.\r\n            default:\r\n                fs.stat(p, function (er2, stat) {\r\n                    // if the stat fails, then that's super weird.\r\n                    // let the original error be the failure reason.\r\n                    if (er2 || !stat.isDirectory()) cb(er, made)\r\n                    else cb(null, made);\r\n                });\r\n                break;\r\n        }\r\n    });\r\n}\r\n\r\nmkdirP.sync = function sync (p, mode, made) {\r\n    var path = nodeRequire('path');\r\n    var fs = nodeRequire('fs');\r\n    if (mode === undefined) {\r\n        mode = 0x1FF & (~process.umask());\r\n    }\r\n    if (!made) made = null;\r\n\r\n    if (typeof mode === 'string') mode = parseInt(mode, 8);\r\n    p = path.resolve(p);\r\n\r\n    try {\r\n        fs.mkdirSync(p, mode);\r\n        made = made || p;\r\n    }\r\n    catch (err0) {\r\n        switch (err0.code) {\r\n            case 'ENOENT' :\r\n                made = sync(path.dirname(p), mode, made);\r\n                sync(p, mode, made);\r\n                break;\r\n\r\n            // In the case of any other error, just see if there's a dir\r\n            // there already.  If so, then hooray!  If not, then something\r\n            // is borked.\r\n            default:\r\n                var stat;\r\n                try {\r\n                    stat = fs.statSync(p);\r\n                }\r\n                catch (err1) {\r\n                    throw err0;\r\n                }\r\n                if (!stat.isDirectory()) throw err0;\r\n                break;\r\n        }\r\n    }\r\n\r\n    return made;\r\n};\r\n\r\nmodule.exports = mkdirP.mkdirp = mkdirP.mkdirP = mkdirP;\r\n"
  ]
}